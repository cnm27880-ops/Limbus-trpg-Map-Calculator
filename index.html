<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Limbus Command v7.1 (Fixes)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0a0a0b; --bg-panel: #131316; --bg-card: #1a1a1f; --bg-input: #0d0d0f;
            --border: #2a2a30; --border-focus: #404048;
            --accent-red: #e53935; --accent-green: #43a047; --accent-blue: #1e88e5;
            --accent-orange: #fb8c00; --accent-yellow: #fdd835; --accent-purple: #8e24aa;
            --text-main: #e8e8ec; --text-dim: #6e6e78; --text-muted: #48484f;
            --grid-size: 50px; --sidebar-width: 340px; --nav-height: 56px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; padding:0; background:var(--bg-main); color:var(--text-main); font-family:'Noto Sans TC',sans-serif; height:100vh; height:100dvh; overflow:hidden; display:flex; flex-direction:column; }
        ::-webkit-scrollbar { width:6px; height:6px; } ::-webkit-scrollbar-track { background:var(--bg-main); } ::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
        button { cursor:pointer; border:none; font-family:inherit; transition:all 0.1s ease; user-select: none; } button:active { transform:scale(0.96); }
        input, select { background:var(--bg-input); border:1px solid var(--border); color:var(--text-main); padding:8px 10px; border-radius:6px; font-size:0.9rem; }
        input:focus, select:focus { outline:none; border-color:var(--border-focus); }
        input[type="number"] { font-family:'JetBrains Mono',monospace; }
        .hidden { display:none !important; }

        /* Login */
        #login-layer { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; padding:20px; }
        .login-box { background:var(--bg-panel); padding:32px; border-radius:12px; border:1px solid var(--border); width:100%; max-width:380px; text-align:center; }
        .login-title { font-size:1.8rem; font-weight:700; color:var(--accent-red); margin-bottom:4px; }
        .login-btn { width:100%; padding:14px; font-weight:600; font-size:1rem; color:#000; border-radius:8px; margin-top:8px; }
        .btn-host { background:linear-gradient(135deg,var(--accent-red),#c62828); }
        .btn-join { background:linear-gradient(135deg,var(--accent-blue),#1565c0); }
        .btn-back { background:var(--bg-card); color:var(--text-dim); margin-top:16px; }

        /* Navbar */
        .navbar { height:var(--nav-height); background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; gap:8px; z-index:100; flex-shrink:0; }
        .nav-tabs { display:flex; gap:4px; flex:1; }
        .nav-tab { background:transparent; color:var(--text-dim); padding:8px 16px; font-size:0.9rem; border-radius:8px; display:flex; align-items:center; gap:6px; }
        .nav-tab.active { background:var(--bg-card); color:var(--text-main); }
        .id-badge { background:var(--bg-card); color:var(--accent-green); padding:6px 10px; border-radius:6px; font-family:'JetBrains Mono',monospace; font-size:0.75rem; cursor:pointer; border:1px dashed var(--border); }
        .sidebar-toggle { display:none; background:var(--bg-card); color:var(--text-dim); padding:8px 12px; border-radius:6px; }
        .sidebar-toggle.active { color:var(--accent-yellow); }

        /* Layout */
        .main-wrapper { flex:1; display:flex; overflow:hidden; position:relative; }
        .page { position:absolute; inset:0; display:none; overflow:hidden; }
        .page.active { display:flex; }

        /* Map Page */
        #page-map { flex-direction:row; }
        .sidebar { width:var(--sidebar-width); background:var(--bg-panel); border-right:1px solid var(--border); display:none; flex-direction:column; overflow:hidden; flex-shrink:0; }
        .sidebar.show { display:flex; }
        .sidebar-header { padding:12px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .sidebar-content { flex:1; overflow-y:auto; padding:12px; }

        .map-toolbar { background:var(--bg-panel); border-bottom:1px solid var(--border); padding:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; z-index:10; }
        .map-tools-scroll { display:flex; gap:6px; overflow-x:auto; max-width:100%; padding-bottom:2px; }
        .tool-btn { width:36px; height:36px; flex-shrink:0; background:var(--bg-card); color:var(--text-dim); border-radius:6px; font-size:1rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .tool-btn.active { box-shadow:0 0 0 2px var(--accent-yellow); color:#fff; }
        .tool-btn .color-indicator { width:8px; height:8px; border-radius:50%; position:absolute; bottom:4px; right:4px; border:1px solid rgba(255,255,255,0.5); }
        .tool-separator { width:1px; height:24px; background:var(--border); margin:0 4px; flex-shrink:0; }
        
        /* Map Controls */
        .map-controls-right { display:flex; gap:8px; align-items:center; margin-left:auto; }
        .map-select { width:130px; padding:6px; font-size:0.8rem; }
        .size-input { width:45px; text-align:center; padding:6px; }
        .apply-btn { background:var(--bg-card); padding:6px 12px; border-radius:6px; font-size:0.8rem; }

        /* Map Viewport & Container */
        .map-viewport { flex:1; background:#050506; position:relative; overflow:hidden; cursor: grab; }
        .map-viewport:active { cursor: grabbing; }
        .map-container { position:absolute; left:50%; top:50%; transform-origin: center center; will-change:transform; user-select: none; }
        
        #battle-map { display:grid; border:2px solid #444; background:var(--bg-main); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .cell { width:var(--grid-size); height:var(--grid-size); border:1px solid rgba(255,255,255,0.05); position:relative; }
        
        /* Tile Vis */
        .cell.deploy-target { background:rgba(253,216,53,0.3) !important; box-shadow:inset 0 0 0 2px var(--accent-yellow); cursor: crosshair; }

        /* Tokens */
        .token { 
            position:absolute; inset:2px; /* å¡«æ»¿æ ¼å­ä½†åœ¨å…§ç¸®ä¸€é» */
            border-radius:50%; border:2px solid #fff; 
            background-size:cover; background-position:center; background-color:#333; 
            z-index:10; display:flex; align-items:center; justify-content:center; 
            font-weight:700; font-size:16px; color:#fff; text-shadow:0 1px 3px #000; 
            pointer-events: auto; cursor: pointer; transition: transform 0.1s;
        }
        .token.selected { transform:scale(1.15); box-shadow:0 0 0 3px var(--accent-yellow); z-index:20; }
        .token.enemy { border-color:var(--accent-red); } 
        .token.player { border-color:var(--accent-green); }

        /* Units Page */
        #page-units { flex-direction:column; background:var(--bg-main); }
        .units-toolbar { background:var(--bg-panel); border-bottom:1px solid var(--border); padding:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .units-btn { background:var(--bg-card); color:var(--text-main); padding:8px 14px; border-radius:8px; font-size:0.85rem; display:flex; align-items:center; gap:6px; }
        .units-btn.primary { background:var(--accent-yellow); color:#000; font-weight:600; }
        .units-list { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }

        .unit-card { background:var(--bg-card); border-radius:8px; padding:10px; border-left:4px solid var(--text-muted); display:flex; flex-direction:column; gap:8px; }
        .unit-card.enemy { border-left-color:var(--accent-red); } .unit-card.player { border-left-color:var(--accent-green); }
        .unit-card.active-turn { box-shadow:0 0 0 2px var(--accent-yellow); background:#1f1f24; }
        .unit-header { display:flex; align-items:center; gap:10px; }
        .unit-avatar { width:42px; height:42px; border-radius:6px; background:var(--bg-input); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-weight:600; background-size:cover; flex-shrink:0; cursor: pointer; }
        .unit-avatar.enemy { border-color:var(--accent-red); color:var(--accent-red); } .unit-avatar.player { border-color:var(--accent-green); color:var(--accent-green); }
        
        .hp-bar-wrap { height:10px; background:var(--bg-input); border-radius:3px; display:flex; overflow:hidden; border:1px solid var(--border); width:100%; }
        .hp-chunk { height:100%; }
        .hp-empty { background:#1a1a1f; } .hp-b { background:var(--accent-blue); } .hp-l { background:var(--accent-orange); } .hp-a { background:var(--accent-red); }
        
        .unit-actions { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
        .action-btn { flex:1; min-width:40px; padding:6px; background:var(--bg-input); color:var(--text-dim); border-radius:4px; font-size:0.75rem; border:1px solid transparent; }
        .action-btn:hover { color:var(--text-main); border-color:var(--border); }
        .action-btn.dmg-b { color:var(--accent-blue); } .action-btn.dmg-l { color:var(--accent-orange); } .action-btn.dmg-a { color:var(--accent-red); } .action-btn.heal { color:var(--accent-green); }

        /* Calculator */
        #page-calc { flex-direction:column; background:var(--bg-main); overflow-y:auto; padding:16px; }
        .calc-container { max-width:650px; width:100%; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
        .calc-section { background:var(--bg-card); border-radius:10px; padding:14px; border:1px solid var(--border); }
        .calc-section-title { font-size:0.8rem; font-weight:700; color:var(--text-dim); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; gap:8px; }
        .calc-section-title.atk { color:var(--accent-green); } .calc-section-title.def { color:var(--accent-red); }
        .calc-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .calc-field { display:flex; flex-direction:column; gap:4px; }
        .calc-label { font-size:0.75rem; color:var(--text-dim); }

        /* Boss Mode Styles */
        .boss-toggle { display:flex; align-items:center; gap:12px; padding:10px; background:var(--bg-input); border-radius:6px; cursor:pointer; }
        .boss-toggle input[type="checkbox"] { width:18px; height:18px; accent-color:var(--accent-purple); }
        .boss-options { margin-top:10px; padding-top:10px; border-top:1px dashed var(--border); display:none; }
        .boss-options.show { display:block; }
        
        .boss-action-item { display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg-input); border-radius:6px; border-left:3px solid var(--accent-purple); margin-bottom:6px; flex-wrap:wrap; }
        .boss-action-num { font-weight:bold; color:var(--accent-purple); min-width:20px; }
        .boss-add-action { width:100%; padding:8px; background:var(--bg-card); border:1px dashed var(--border); border-radius:6px; color:var(--text-dim); margin-top:8px; }
        
        .boss-summary { margin-top:12px; padding:12px; background:rgba(142,36,170,0.08); border-radius:6px; border:1px solid var(--accent-purple); }
        .boss-summary-line { font-size:0.85rem; margin-bottom:4px; display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:4px; }
        .boss-summary-line:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
        .val-pos { color:var(--accent-green); font-weight:bold; }
        .val-neg { color:var(--accent-red); font-weight:bold; }
        .val-neutral { color:var(--text-dim); }

        .calc-buttons { display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-top:10px; }
        .calc-btn { padding:14px; border-radius:8px; font-weight:600; font-size:1rem; }
        .calc-btn-reset { background:var(--bg-card); color:var(--text-dim); }
        .calc-btn-calc { background:linear-gradient(135deg,var(--accent-green),#2e7d32); color:#000; }
        
        .def-tags, .atk-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; }
        .def-tag, .atk-tag { padding:4px 10px; background:var(--bg-input); border:1px solid var(--border); border-radius:15px; font-size:0.75rem; color:var(--text-dim); cursor:pointer; }
        .def-tag.active { color:#000; border-color:transparent; }
        .def-tag.physical.active { background:var(--accent-orange); } .def-tag.agility.active { background:var(--accent-green); } .def-tag.supernatural.active { background:var(--accent-purple); } .def-tag.other.active { background:var(--accent-blue); }
        .atk-tag.active { background:var(--accent-red); color:#000; }
        .def-inputs { display:flex; flex-direction:column; gap:8px; }
        .def-input-row { display:none; align-items:center; gap:8px; padding:6px; background:var(--bg-input); border-radius:6px; }
        .def-input-row.show { display:flex; }

        /* Modals */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:none; justify-content:center; align-items:center; padding:15px; }
        .modal-overlay.show { display:flex; }
        .modal { background:var(--bg-panel); border-radius:10px; border:1px solid var(--border); width:100%; max-width:400px; max-height:90vh; overflow-y:auto; }
        .modal-header { padding:14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:16px; display:flex; flex-direction:column; gap:14px; }
        .modal-footer { padding:14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
        .modal-btn { padding:8px 16px; border-radius:6px; }
        
        /* Helper */
        .toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:#222; border:1px solid var(--accent-green); color:#fff; padding:10px 20px; border-radius:30px; z-index:3000; opacity:0; transition:all 0.3s; pointer-events:none; font-size:0.9rem; }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        
        #tile-info-panel {
            background: rgba(0,0,0,0.6); border: 1px solid var(--border);
            border-radius: 6px; padding: 10px; margin-bottom: 10px;
            font-size: 0.8rem; color: var(--text-dim); display: none;
        }

        @media (min-width:1024px) { .sidebar-toggle { display:flex; } .sidebar.show { display:flex; } }
        @media (max-width:1023px) { .map-controls-right { display:none; } .nav-tab { padding:8px 10px; font-size:0.8rem; } }
    </style>
</head>
<body>
<input type="file" id="file-upload" accept="image/*" style="display:none;">
<div class="toast" id="toast"></div>

<!-- Login -->
<div id="login-layer">
    <div class="login-box" id="login-main">
        <div class="login-title">LIMBUS</div>
        <div style="color:var(--text-dim);margin-bottom:20px;">æˆ°è¡“æŒ‡æ®ç³»çµ± v7.1</div>
        <input type="text" id="input-name" placeholder="è¼¸å…¥ä»£è™Ÿ" style="width:100%;text-align:center;margin-bottom:10px;">
        <button class="login-btn btn-host" onclick="initSystem('st')">æˆ‘æ˜¯ STï¼ˆå»ºæˆ¿ï¼‰</button>
        <button class="login-btn btn-join" onclick="showJoinStep()">æˆ‘æ˜¯ç©å®¶ï¼ˆåŠ å…¥ï¼‰</button>
    </div>
    <div class="login-box hidden" id="login-join">
        <div class="login-title">åŠ å…¥æˆ¿é–“</div>
        <input type="text" id="input-host-id" placeholder="è²¼ä¸Š ST çš„ ID" style="width:100%;text-align:center;margin-bottom:10px;">
        <button class="login-btn btn-join" onclick="initSystem('player')">é€£ç·š</button>
        <button class="login-btn btn-back" onclick="showMainStep()">è¿”å›</button>
    </div>
    <div class="login-box hidden" id="login-loading"><div style="color:var(--accent-green);">é€£ç·šä¸­...</div></div>
</div>

<!-- Nav -->
<nav class="navbar">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="map" onclick="switchPage('map')">ğŸ—ºï¸ åœ°åœ–</button>
        <button class="nav-tab" data-page="units" onclick="switchPage('units')">âš”ï¸ å–®ä½</button>
        <button class="nav-tab" data-page="calc" onclick="switchPage('calc')">ğŸ² è¨ˆç®—</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">ğŸ“‹</button>
        <span class="id-badge" id="my-id" onclick="copyId()" title="é»æ“Šè¤‡è£½ID">---</span>
    </div>
</nav>

<!-- Content -->
<div class="main-wrapper">
    <!-- Map -->
    <div id="page-map" class="page active">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><span style="font-weight:bold;color:var(--accent-yellow);">æˆ°é¬¥åºåˆ—</span><button style="background:none;color:var(--text-dim);font-size:1.2rem;" onclick="toggleSidebar()">Ã—</button></div>
            <div class="sidebar-content">
                <div id="tile-info-panel">
                    <div style="color:var(--accent-yellow);font-weight:bold;margin-bottom:4px;">åœ°å½¢æ•ˆæœ</div>
                    <div id="tile-effect-desc"></div>
                </div>
                <div id="sidebar-units"></div>
            </div>
        </aside>
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;">
            <div class="map-toolbar">
                <div class="map-tools-scroll" id="dynamic-tools">
                    <button class="tool-btn active" data-tool="cursor" onclick="setTool('cursor')">ğŸ‘†</button>
                    <button class="tool-btn" data-tool="floor" onclick="setTool('floor')">ğŸ§¹</button>
                </div>
                <div class="tool-separator"></div>
                <button class="tool-btn" onclick="resetCamera()" title="è¦–è§’æ­¸ä½">ğŸ¯</button>
                <button class="tool-btn" onclick="clearSelection()" title="å–æ¶ˆé¸å–">âœ•</button>
                
                <div class="map-controls-right" id="st-map-controls">
                    <select id="map-theme-select" class="map-select" onchange="changeMapTheme(this.value)">
                        <option value="0">ä¸€èˆ¬è¨“ç·´å®¤</option>
                        <option value="1">å¾Œå··æ·±è™•</option>
                        <option value="2">L å…¬å¸å»¢å¢Ÿ</option>
                        <option value="3">W å…¬å¸åˆ—è»Š</option>
                        <option value="4">K å…¬å¸å·¥å» </option>
                        <option value="5">U å…¬å¸ç”²æ¿</option>
                        <option value="6">å†°é›ªåŸå ¡</option>
                        <option value="7">è¡€è‚‰å±±ä¸˜</option>
                    </select>
                    <input type="number" id="map-w" class="size-input" value="15" min="5" max="50">
                    <span style="font-size:0.8rem;color:#555;">x</span>
                    <input type="number" id="map-h" class="size-input" value="15" min="5" max="50">
                    <button class="apply-btn" onclick="resizeMap()">å¥—ç”¨</button>
                </div>
            </div>
            <!-- Map Viewport with Pan/Zoom logic -->
            <div class="map-viewport" id="map-viewport">
                <div class="map-container" id="map-container">
                    <div id="battle-map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Units -->
    <div id="page-units" class="page">
        <div class="units-toolbar" id="units-toolbar">
            <button class="units-btn primary" onclick="nextTurn()">â–¶ ä¸‹ä¸€å›åˆ</button>
            <button class="units-btn" onclick="openAddUnitModal()">+ æ–°å¢</button>
            <button class="units-btn" onclick="openBatchModal()">ğŸ“‹ æ‰¹é‡</button>
            <button class="units-btn" onclick="sortByInit()">â± æ’åº</button>
        </div>
        <div class="units-list" id="units-list"></div>
    </div>

    <!-- Calculator -->
    <div id="page-calc" class="page">
        <div class="calc-container">
            <!-- Boss Mode Section -->
            <div class="calc-section">
                <label class="boss-toggle">
                    <input type="checkbox" id="boss-mode" onchange="toggleBossMode()">
                    <div>
                        <div style="font-weight:bold;color:var(--accent-purple);">ğŸ”® ç‰¹æ®Š BOSS æ¨¡å¼</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">å•Ÿç”¨æˆ¿è¦è¨ˆç®—ï¼šè¤‡æ•¸è¡Œå‹•ã€å…ˆæ”»åŠ æˆ</div>
                    </div>
                </label>
                <div class="boss-options" id="boss-options">
                    <div class="calc-grid">
                        <div class="calc-field"><span class="calc-label">ä¸»ç·š/æ”¯ç·šç­‰ç´š</span><input type="number" id="boss-tier" value="1" min="1" max="10" onchange="updateBossSummary()"></div>
                        <div class="calc-field"><span class="calc-label">æœ¬å›åˆç‹€æ³</span><select id="boss-engage" onchange="updateBossSummary()"><option value="yes">æœ‰å°æŠ—è¡Œå‹•</option><option value="no">å®Œå…¨æœªå°æŠ— (æˆ‘æ–¹DP+)</option></select></div>
                    </div>
                    
                    <div id="boss-actions-list" style="margin-top:10px;"></div>
                    <button class="boss-add-action" onclick="addBossAction()">+ æ–°å¢å°æŠ—è¡Œå‹•</button>

                    <div class="boss-summary">
                        <div style="font-weight:bold;color:var(--accent-purple);margin-bottom:6px;">ğŸ“Š çµæœé è¦½</div>
                        <div id="boss-summary-content" style="display:flex;flex-direction:column;gap:4px;"></div>
                    </div>
                </div>
            </div>

            <!-- Standard Calc -->
            <div class="calc-section">
                <div class="calc-section-title atk">ğŸ—¡ï¸ æ”»æ“Šæ–¹ (æˆ‘æ–¹)</div>
                <div class="atk-tags">
                    <span class="atk-tag" data-type="pen" onclick="toggleAtkTag('pen')">ç ´ç”²</span>
                    <span class="atk-tag" data-type="speed" onclick="toggleAtkTag('speed')">é«˜é€Ÿ</span>
                    <span class="atk-tag" data-type="magic" onclick="toggleAtkTag('magic')">ç ´é­”</span>
                </div>
                <div class="calc-grid">
                    <div class="calc-field"><span class="calc-label">æ”»æ“Š DP</span><input type="number" id="c-atk" value="10" min="0"></div>
                    <div class="calc-field"><span class="calc-label">æ”»æ“Šé™„åŠ æˆåŠŸ</span><input type="number" id="c-atk-auto" value="0" min="0"></div>
                    <div class="calc-field def-input-row" id="row-pen"><span style="font-size:0.75rem;">ç ´ç”²å€¼</span><input type="number" style="width:60px;" id="c-pen" value="0"></div>
                    <div class="calc-field def-input-row" id="row-speed"><span style="font-size:0.75rem;">é«˜é€Ÿå€¼</span><input type="number" style="width:60px;" id="c-speed" value="0"></div>
                    <div class="calc-field def-input-row" id="row-magic"><span style="font-size:0.75rem;">ç ´é­”å€¼</span><input type="number" style="width:60px;" id="c-magic" value="0"></div>
                    <div class="calc-field"><span class="calc-label">æ„å¿—åŠ å€¼</span><select id="c-will"><option value="0">ä¸ä½¿ç”¨</option><option value="3">+3 (å®Œç¾)</option></select></div>
                </div>
            </div>

            <div class="calc-section">
                <div class="calc-section-title def">ğŸ›¡ï¸ é˜²ç¦¦æ–¹ (æ•µæ–¹)</div>
                <div class="def-tags">
                    <span class="def-tag physical" data-def="armor" onclick="toggleDefTag('armor')">ç›”ç”²</span>
                    <span class="def-tag physical" data-def="shield" onclick="toggleDefTag('shield')">ç›¾ç‰Œ</span>
                    <span class="def-tag physical" data-def="natural" onclick="toggleDefTag('natural')">å¤©ç”Ÿ</span>
                    <span class="def-tag agility" data-def="base" onclick="toggleDefTag('base')">åŸºç¤</span>
                    <span class="def-tag agility" data-def="dodge" onclick="toggleDefTag('dodge')">é–ƒé¿</span>
                    <span class="def-tag agility" data-def="block" onclick="toggleDefTag('block')">æ ¼æ“‹</span>
                    <span class="def-tag agility" data-def="shieldBlock" onclick="toggleDefTag('shieldBlock')">ç›¾æ“‹</span>
                    <span class="def-tag supernatural" data-def="force" onclick="toggleDefTag('force')">åŠ›å ´</span>
                    <span class="def-tag supernatural" data-def="deflect" onclick="toggleDefTag('deflect')">åæ–œ</span>
                    <span class="def-tag supernatural" data-def="magicArmor" onclick="toggleDefTag('magicArmor')">æ³•ç”²</span>
                    <span class="def-tag other" data-def="cover" onclick="toggleDefTag('cover')">æ©è”½</span>
                    <span class="def-tag other" data-def="insight" onclick="toggleDefTag('insight')">æ´å¯Ÿ</span>
                    <span class="def-tag other" data-def="other" onclick="toggleDefTag('other')">å…¶ä»–</span>
                </div>
                <div class="def-inputs" id="def-inputs"></div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">
                    <div class="calc-grid">
                        <div class="calc-field"><span class="calc-label">æœ¬å›åˆå·²å—æ“Šæ¬¡æ•¸</span><input type="number" id="c-hits" value="0" min="0"></div>
                        <div class="calc-field"><span class="calc-label" style="color:var(--accent-orange)">é˜²ç¦¦é™„åŠ æˆåŠŸ</span><input type="number" id="c-def-auto" value="0" min="0"></div>
                    </div>
                </div>
            </div>

            <div class="calc-buttons">
                <button class="calc-btn calc-btn-reset" onclick="resetCalc()">ğŸ”„ é‡ç½®</button>
                <button class="calc-btn calc-btn-calc" onclick="calculateDP()">âš¡ è¨ˆç®— (åƒ…ä¸€èˆ¬)</button>
            </div>
            <div style="text-align:center;padding:15px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);">
                <div id="result-main" style="font-size:2rem;font-weight:bold;color:var(--accent-green);">---</div>
                <div id="result-detail" style="font-size:0.8rem;color:var(--text-dim);margin-top:5px;">ä¸€èˆ¬è¨ˆç®—çµæœé¡¯ç¤ºæ–¼æ­¤<br>(BOSSæ¨¡å¼è«‹çœ‹ä¸Šæ–¹é è¦½é¢æ¿)</div>
            </div>
        </div>
    </div>
</div>

<!-- Add Unit Modal -->
<div class="modal-overlay" id="modal-add-unit">
    <div class="modal">
        <div class="modal-header"><span>æ–°å¢å–®ä½</span><button onclick="closeModal('modal-add-unit')">Ã—</button></div>
        <div class="modal-body">
            <input type="text" id="add-name" placeholder="åç¨±">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <input type="number" id="add-hp" value="10" placeholder="HP">
                <select id="add-type"><option value="enemy">æ•µæ–¹</option><option value="player">æˆ‘æ–¹</option></select>
            </div>
            <label><input type="checkbox" id="add-avatar"> ä¸Šå‚³é ­åƒ</label>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-add-unit')" style="background:var(--bg-card);">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmAddUnit()" style="background:var(--accent-green);color:#000;">ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- Batch Modal -->
<div class="modal-overlay" id="modal-batch">
    <div class="modal">
        <div class="modal-header"><span>æ‰¹é‡æ–°å¢</span><button onclick="closeModal('modal-batch')">Ã—</button></div>
        <div class="modal-body">
            <input type="text" id="batch-prefix" placeholder="å‰ç¶´ (ä¾‹: é›œå…µ)">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="calc-field"><span class="calc-label">èµ·å§‹ç·¨è™Ÿ</span><input type="number" id="batch-start" value="1"></div>
                <div class="calc-field"><span class="calc-label">æ•¸é‡</span><input type="number" id="batch-count" value="5"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="calc-field"><span class="calc-label">HP</span><input type="number" id="batch-hp" value="10"></div>
                <div class="calc-field"><span class="calc-label">é¡å‹</span><select id="batch-type"><option value="enemy">æ•µæ–¹</option><option value="player">æˆ‘æ–¹</option></select></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-batch')" style="background:var(--bg-card);">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmBatchAdd()" style="background:var(--accent-green);color:#000;">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
/* --- 1. CONFIG & DATA --- */
const MAP_PRESETS = [
    { name: "ä¸€èˆ¬è¨“ç·´å®¤", tiles: [
        { id: 10, color: '#2a2a30', name: 'ç‰†å£', effect: 'ä¸å¯é€šè¡Œ' },
        { id: 11, color: 'rgba(67,160,71,0.15)', name: 'æ©é«”', effect: 'æä¾›æ©è”½ (+4 DP)' },
        { id: 12, color: 'rgba(229,57,53,0.15)', name: 'éšªåœ°', effect: 'æ¯å›åˆ 1 é»å‚·å®³' },
        { id: 13, color: '#111114', name: 'åœ°æ¿', effect: 'ç„¡ç‰¹æ®Šæ•ˆæœ' }
    ]},
    { name: "å¾Œå··æ·±è™•", tiles: [
        { id: 20, color: '#4e342e', name: 'ç”Ÿé½æ©é«”', effect: 'ç¡¬æ©é«”ï¼šä¸å¯é€šè¡Œã€‚è²¼ç‰†ç«™ç«‹æ™‚ï¼Œé ç¨‹é˜²ç¦¦+4ã€‚' },
        { id: 21, color: '#0d47a1', name: 'æ²¹æ±¡ç©æ°´', effect: 'æ¿•æ»‘ï¼šé˜²ç¦¦-4ã€‚å—ç«ç„°å‚·å®³æ™‚é¡å¤–+3ç¼ç‡’ã€‚' },
        { id: 22, color: '#fdd835', name: 'è·¯ç‡ˆ/éœ“è™¹', effect: 'æš´éœ²ï¼šç„¡æ³•éš±èº«ã€‚ç„¡è¦–é»‘æš—æ¸›å€¼ã€‚' },
        { id: 23, color: '#1b5e20', name: 'åƒåœ¾å †', effect: 'éª¯é«’ï¼šç§»å‹•å›°é›£ã€‚å›åˆçµæŸæ™‚å—3é»æ¯’ç´ (L)ã€‚' }
    ]},
    { name: "Lå…¬å¸å»¢å¢Ÿ", tiles: [
        { id: 30, color: '#00e676', name: 'Cogitoæ´©æ¼', effect: 'ç²¾ç¥è…è•ï¼šå›åˆçµæŸæ‰£3æ„å¿—ï¼Œè‹¥ç©ºå‰‡3Aå‚·ã€‚' },
        { id: 31, color: '#616161', name: 'æ”¶å®¹é–€', effect: 'å …å›ºæ©é«”ï¼šé˜²ç¦¦+6ã€‚å—å‚·>10æ™‚ç²‰ç¢ã€‚' },
        { id: 32, color: '#b71c1c', name: 'æ´»æ€§å±å¡Š', effect: 'æŠ“æ’“ï¼šåªèƒ½æ¨™æº–ç§»å‹•ã€‚é€²å…¥å—1Lå‚·ã€‚' },
        { id: 33, color: '#ffb300', name: 'æŠ‘åˆ¶åŠ›å ´', effect: 'ç†æ™ºç¶­è­·ï¼šç²¾ç¥å‚·å®³æ¸›åŠã€‚' }
    ]},
    { name: "Wå…¬å¸åˆ—è»Š", tiles: [
        { id: 40, color: '#00bcd4', name: 'ç©ºé–“è£‚éš™', effect: 'ç›¸ä½å‚³é€ï¼šå¼·åˆ¶å‚³é€åˆ°éš¨æ©Ÿè£‚éš™ï¼ŒçµæŸç§»å‹•ã€‚' },
        { id: 41, color: '#f06292', name: 'è¡€è‚‰åº§æ¤…', effect: 'é»è‘—ï¼šç§»å‹•å›°é›£ã€‚è¿‘æˆ°æ”»æ“ŠDP-6ã€‚' },
        { id: 42, color: '#ffd700', name: 'é ­ç­‰è‰™å±éšœ', effect: 'éš”é›¢ï¼šé˜»æ“‹è¦–ç·šã€‚éœ€è»Šç¥¨æˆ–20+å‚·å®³ç ´å£ã€‚' },
        { id: 43, color: '#eeeeee', name: 'æ™‚é–“åœæ»¯', effect: 'å‡çµï¼šç‹€æ…‹æŒçºŒæ™‚é–“ä¸æ¸›å°‘ã€‚' }
    ]},
    { name: "Kå…¬å¸å·¥å» ", tiles: [
        { id: 50, color: '#69f0ae', name: 'HPå®‰ç“¿', effect: 'éåº¦å†ç”Ÿï¼šå›åˆé–‹å§‹å›4HPï¼Œæº¢å‡ºè½‰å‚·å®³ã€‚' },
        { id: 51, color: '#81d4fa', name: 'ç»ç’ƒæ£§é“', effect: 'æ˜“ç¢ï¼šå—çˆ†ç‚¸/éˆæ“Šæ™‚é˜²ç¦¦-6ã€‚' },
        { id: 52, color: '#fff176', name: 'ç›£æ§å€åŸŸ', effect: 'é–å®šï¼šå—åˆ°çš„æ‰€æœ‰å‚·å®³+3ã€‚' },
        { id: 53, color: '#ffffff', name: 'æ¶ˆæ¯’å™´å˜´', effect: 'æ·¨åŒ–ï¼šé€²å…¥æ™‚ç§»é™¤æ‰€æœ‰ç‹€æ…‹(Buff/Debuff)ã€‚' }
    ]},
    { name: "Uå…¬å¸ç”²æ¿", tiles: [
        { id: 60, color: '#5d4037', name: 'æ¿•æ»‘ç”²æ¿', effect: 'é‡å¿ƒä¸ç©©ï¼šæ”»æ“ŠDP-6ã€‚æ“Šé€€è·é›¢+5ã€‚' },
        { id: 61, color: '#1a237e', name: 'å·¨æµªæ‹æ‰“', effect: 'è¡æ“Šï¼šå›åˆçµæŸå—3Lå‚·ä¸¦å¾Œé€€1æ ¼ã€‚' },
        { id: 62, color: '#455a64', name: 'é­šå‰ç™¼å°„å™¨', effect: 'æ©é«”+6é˜²ç¦¦ã€‚ç›¸é„°å¯ç™¼å°„é­šå‰(ç›´ç·š8æ ¼, 15DP)ã€‚' },
        { id: 63, color: '#7b1fa2', name: 'å…±é³´éŸ³å‰', effect: 'å…±æŒ¯ï¼šæ­¤æ ¼åŠç›¸é„°å‹æ–¹è¿‘æˆ°DP+6ã€‚' }
    ]},
    { name: "å†°é›ªåŸå ¡", tiles: [
        { id: 70, color: '#80deea', name: 'è¬å¹´ç„å†°', effect: 'è„†åŒ–ï¼šå—ç‰©ç†å‚·å®³æ™‚å‚·å®³+3ã€‚' },
        { id: 71, color: '#ffffff', name: 'å·¨å¤§å†°åˆº', effect: 'åˆºç©¿ï¼šé€²å…¥/ç¶“éå—3Lå‚·ã€‚' },
        { id: 72, color: '#006064', name: 'å‡çµä¾›å“', effect: 'æ©é«”+6ã€‚ç ´å£æ™‚å‘¨åœ1æ ¼éº»ç—º3å±¤ã€‚' },
        { id: 73, color: '#0d47a1', name: 'æ·±æ·µé‚Šç·£', effect: 'æ­»äº¡é‚Šç•Œï¼šæ“Šé€€å…¥æ­¤æ ¼è¦–ç‚ºå¢œè½/æ­»äº¡ã€‚' }
    ]},
    { name: "è¡€è‚‰å±±ä¸˜", tiles: [
        { id: 80, color: '#b71c1c', name: 'è •å‹•å±éª¸', effect: 'æ³¥æ²¼ï¼šç§»å‹•å›°é›£ã€‚å›åˆçµæŸæµè¡€4å±¤ã€‚' },
        { id: 81, color: '#bf360c', name: 'ç»ç¥­ä¹‹ç«', effect: 'ç‡ƒç‡’ï¼šé€²å…¥ç²4ç‡ƒç‡’ã€‚Nç¤¾æˆå“¡æ”»æ“ŠDP+6ã€‚' },
        { id: 82, color: '#3e2723', name: 'ç©¿åˆºæ¨', effect: 'åˆ‘å…·ï¼šåœ¨æ­¤è¢«æ“Šä¸­é¡å¤–å—4æ„å¿—å‚·ã€‚' },
        { id: 83, color: '#ffd600', name: 'é‡‘æå…‰è¼', effect: 'æ‰­æ›²ï¼šå›åˆé–‹å§‹å›2æ„å¿—ï¼Œå…¨æŠ€èƒ½åŠ éª°+1ã€‚' }
    ]}
];

let state = { units: [], turnIdx: 0, mapW: 15, mapH: 15, mapData: [], themeId: 0 };
let myPeerId = null, conn = null, myRole = 'player';
let peer = null;
let currentTool = 'cursor';
let selectedUnitId = null;
let uploadTargetId = null;

// Camera State
let cam = { x: 0, y: 0, scale: 1.0 };
let isDraggingMap = false;
let lastPointer = { x: 0, y: 0 };
let lastDist = 0; // For pinch zoom

/* --- 2. INIT & CONN --- */
function initSystem(role) {
    const name = document.getElementById('input-name').value.trim();
    if (!name) return showToast('è«‹è¼¸å…¥ä»£è™Ÿ');
    
    document.getElementById('login-main').classList.add('hidden');
    document.getElementById('login-join').classList.add('hidden');
    document.getElementById('login-loading').classList.remove('hidden');
    
    myRole = role;
    peer = new Peer(); 
    
    peer.on('open', id => {
        myPeerId = id;
        document.getElementById('my-id').innerText = id;
        document.getElementById('login-layer').classList.add('hidden');
        
        if (role === 'st') {
            document.getElementById('st-map-controls').style.display = 'flex';
            document.getElementById('units-toolbar').style.display = 'flex';
            document.getElementById('tile-info-panel').style.display = 'block';
            initMapData();
            updateToolbar();
            renderAll();
        } else {
            document.getElementById('st-map-controls').style.display = 'none';
            document.getElementById('units-toolbar').style.display = 'none';
            if(document.getElementById('input-host-id').value) {
                connectToHost(document.getElementById('input-host-id').value.trim());
            }
        }
        initCameraEvents();
    });

    peer.on('connection', c => {
        setupConnection(c);
        if (myRole === 'st') { setTimeout(() => sendState(), 500); }
    });

    peer.on('error', err => {
        showToast('é€£ç·šéŒ¯èª¤: ' + err.type);
        document.getElementById('login-layer').classList.remove('hidden');
        document.getElementById('login-loading').classList.add('hidden');
    });
}

function showJoinStep() {
    document.getElementById('login-main').classList.add('hidden');
    document.getElementById('login-join').classList.remove('hidden');
}
function showMainStep() {
    document.getElementById('login-join').classList.add('hidden');
    document.getElementById('login-main').classList.remove('hidden');
}
function connectToHost(hostId) {
    if(!hostId) return;
    conn = peer.connect(hostId);
    setupConnection(conn);
}
function setupConnection(c) {
    conn = c;
    conn.on('data', data => { if (data.type === 'state') { state = data.payload; renderAll(); } });
    conn.on('close', () => showToast('é€£ç·šå·²æ–·é–‹'));
}
function sendState() {
    if (!conn) return;
    conn.send({ type: 'state', payload: state });
}

/* --- 3. CAMERA LOGIC (PAN & ZOOM) --- */
function initCameraEvents() {
    const vp = document.getElementById('map-viewport');
    
    // Wheel Zoom
    vp.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoomCamera(delta);
    }, { passive: false });

    // Pointer Events (Mouse & Touch)
    vp.addEventListener('pointerdown', e => {
        isDraggingMap = true;
        lastPointer = { x: e.clientX, y: e.clientY };
        vp.setPointerCapture(e.pointerId);
    });

    vp.addEventListener('pointermove', e => {
        if (!isDraggingMap) return;
        e.preventDefault();
        const dx = e.clientX - lastPointer.x;
        const dy = e.clientY - lastPointer.y;
        
        cam.x += dx;
        cam.y += dy;
        lastPointer = { x: e.clientX, y: e.clientY };
        applyCamera();
    });

    vp.addEventListener('pointerup', e => {
        isDraggingMap = false;
        vp.releasePointerCapture(e.pointerId);
    });

    // Touch Pinch (Simple)
    vp.addEventListener('touchmove', e => {
        if(e.touches.length === 2) {
            e.preventDefault(); // Stop page scroll
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            if(lastDist) {
                const diff = dist - lastDist;
                zoomCamera(diff * 0.005);
            }
            lastDist = dist;
        }
    }, { passive: false });
    
    vp.addEventListener('touchend', () => { lastDist = 0; });
}

function zoomCamera(amount) {
    cam.scale = Math.max(0.5, Math.min(3.0, cam.scale + amount));
    applyCamera();
}

function applyCamera() {
    const con = document.getElementById('map-container');
    con.style.transform = `translate(${cam.x}px, ${cam.y}px) scale(${cam.scale})`;
}

function resetCamera() {
    cam = { x: 0, y: 0, scale: 1.0 };
    applyCamera();
}

/* --- 4. MAP LOGIC --- */
function initMapData() {
    state.mapData = Array(state.mapH).fill().map(() => Array(state.mapW).fill(0));
}

function changeMapTheme(id) {
    if(myRole !== 'st') return;
    state.themeId = parseInt(id);
    updateToolbar();
    sendState(); renderAll();
}

function updateToolbar() {
    const container = document.getElementById('dynamic-tools');
    const staticTools = container.querySelectorAll('[data-tool="cursor"], [data-tool="floor"]');
    container.innerHTML = '';
    staticTools.forEach(t => container.appendChild(t));

    const theme = MAP_PRESETS[state.themeId] || MAP_PRESETS[0];
    theme.tiles.forEach(tile => {
        if(tile.name === 'åœ°æ¿') return;
        const btn = document.createElement('button');
        btn.className = 'tool-btn';
        btn.dataset.tool = tile.id;
        btn.title = tile.name;
        btn.onclick = () => setTool(tile.id);
        
        const dot = document.createElement('div');
        dot.className = 'color-indicator';
        dot.style.backgroundColor = tile.color;
        
        btn.innerText = tile.name.substring(0, 1);
        btn.appendChild(dot);
        container.appendChild(btn);
    });
}

function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`.tool-btn[data-tool="${tool}"]`);
    if(btn) btn.classList.add('active');

    if(myRole === 'st') {
        const info = document.getElementById('tile-effect-desc');
        const theme = MAP_PRESETS[state.themeId];
        let desc = "";
        if (tool === 'floor') desc = "æ¸…é™¤æ ¼å­";
        else if (tool === 'cursor') desc = "é¸æ“‡å–®ä½ / æŸ¥çœ‹æ ¼å­";
        else {
            const t = theme.tiles.find(x => x.id == tool);
            if(t) desc = `${t.name}: ${t.effect}`;
        }
        info.innerText = desc;
    }
}

function resizeMap() {
    const w = parseInt(document.getElementById('map-w').value);
    const h = parseInt(document.getElementById('map-h').value);
    if(w < 5 || h < 5 || w > 50 || h > 50) return showToast('å°ºå¯¸ 5~50');
    
    const newData = Array(h).fill().map(() => Array(w).fill(0));
    for(let y=0; y<Math.min(h, state.mapH); y++) {
        for(let x=0; x<Math.min(w, state.mapW); x++) {
            newData[y][x] = state.mapData[y][x];
        }
    }
    state.mapW = w; state.mapH = h; state.mapData = newData;
    sendState(); renderAll();
}

/* --- 5. RENDER SYSTEM --- */
function renderAll() {
    renderMap();
    renderUnitsList();
    renderSidebarUnits();
}

function renderMap() {
    const grid = document.getElementById('battle-map');
    grid.style.gridTemplateColumns = `repeat(${state.mapW}, var(--grid-size))`;
    grid.innerHTML = '';
    
    // Set container size for centering
    const pxW = state.mapW * 50; // 50 is grid size var
    const pxH = state.mapH * 50;
    grid.style.width = pxW + 'px';
    grid.style.height = pxH + 'px';
    // Center logic handled by map-container flex/pos usually, but here transform is used.
    document.getElementById('map-container').style.width = pxW + 'px';
    document.getElementById('map-container').style.height = pxH + 'px';
    document.getElementById('map-container').style.marginLeft = `-${pxW/2}px`;
    document.getElementById('map-container').style.marginTop = `-${pxH/2}px`;

    const theme = MAP_PRESETS[state.themeId] || MAP_PRESETS[0];

    for(let y=0; y<state.mapH; y++) {
        for(let x=0; x<state.mapW; x++) {
            const val = state.mapData[y][x];
            const div = document.createElement('div');
            div.className = 'cell';
            
            // Deployment Highlight Logic
            if (currentTool === 'cursor' && selectedUnitId !== null && myRole === 'st') {
               // Checking if unit is waiting to deploy
               const u = state.units.find(u => u.id === selectedUnitId);
               if(u && u.x === -1) div.classList.add('deploy-target');
            }

            let tileDef = theme.tiles.find(t => t.id === val);
            // Fallback for old saves
            if (!tileDef && state.themeId === 0) {
                 if(val === 1) tileDef = theme.tiles.find(t=>t.name==='ç‰†å£');
                 else if(val === 2) tileDef = theme.tiles.find(t=>t.name==='æ©é«”');
                 else if(val === 3) tileDef = theme.tiles.find(t=>t.name==='éšªåœ°');
            }

            if (tileDef) {
                div.style.backgroundColor = tileDef.color;
                if(tileDef.name.includes('ç‰†') || tileDef.name.includes('æ©é«”')) {
                    div.style.backgroundImage = 'repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(0,0,0,0.2) 4px,rgba(0,0,0,0.2) 8px)';
                }
            }

            // Interactions
            div.onpointerdown = (e) => {
                if(isDraggingMap) return;
                handleMapInput(x, y, e);
            };
            div.onpointerenter = (e) => { if(e.buttons === 1 && !isDraggingMap) handleMapInput(x, y, e); };
            
            grid.appendChild(div);
        }
    }
    
    // Tokens
    state.units.filter(u => u.x >= 0).forEach(u => {
        const t = document.createElement('div');
        t.className = `token ${u.type} ${u.id === selectedUnitId ? 'selected' : ''}`;
        
        // Correct positioning within grid
        t.style.left = `calc(${u.x} * var(--grid-size))`;
        t.style.top = `calc(${u.y} * var(--grid-size))`;
        
        if(u.avatar) t.style.backgroundImage = `url(${u.avatar})`;
        else t.innerText = u.name[0].toUpperCase();
        
        t.onpointerdown = (e) => {
            if(currentTool === 'cursor') {
                e.stopPropagation();
                selectUnit(u.id);
            }
        };
        grid.appendChild(t);
    });
}

function handleMapInput(x, y, e) {
    if (currentTool === 'cursor') {
        if(selectedUnitId !== null && myRole === 'st') {
            const u = state.units.find(u => u.id === selectedUnitId);
            if(u) {
                u.x = x; u.y = y;
                selectedUnitId = null; // Deselect after move
                sendState(); renderAll();
            }
        }
        return;
    }
    if (myRole !== 'st') return;

    let newVal = (currentTool === 'floor') ? 0 : parseInt(currentTool);
    if (state.mapData[y][x] !== newVal) {
        state.mapData[y][x] = newVal;
        renderAll(); // Immediate visual
    }
}
window.addEventListener('pointerup', () => { if(myRole==='st') sendState(); });

/* --- 6. UNITS LOGIC --- */
function renderUnitsList() {
    const list = document.getElementById('units-list');
    if (!list) return;
    
    list.innerHTML = state.units.map((u, idx) => {
        const isTurn = idx === state.turnIdx;
        const a = u.hpArr.filter(x => x === 3).length;
        const l = u.hpArr.filter(x => x === 2).length;
        const b = u.hpArr.filter(x => x === 1).length;
        const empty = u.maxHp - a - l - b;
        
        const isEnemy = u.type === 'enemy';
        const isSt = myRole === 'st';
        const hideDetails = isEnemy && !isSt;

        let statusText = `${empty}å®Œå¥½ / ${b}B / ${l}L / ${a}A`;
        if (hideDetails) statusText = `ç‹€æ…‹: ${getVagueStatus(u)}`;

        const bar = u.hpArr.map(h => {
            let cls = 'hp-empty';
            if (h === 1) cls = 'hp-b';
            if (h === 2) cls = 'hp-l';
            if (h === 3) cls = 'hp-a';
            return `<div class="hp-chunk ${cls}" style="width:${100/u.maxHp}%"></div>`;
        }).join('');

        const deployBtn = u.x >= 0 
            ? `<button class="action-btn" onclick="recallUnit(${u.id})">ğŸ“æ”¶å›</button>` 
            : `<button class="action-btn" onclick="startDeploy(${u.id})">ğŸ“éƒ¨ç½²</button>`;
        
        let actions = '';
        if (isSt) {
            actions = `
                <div class="unit-actions">
                    <button class="action-btn dmg-b" onclick="modifyHP(${u.id},'b',1)">+B</button>
                    <button class="action-btn dmg-l" onclick="modifyHP(${u.id},'l',1)">+L</button>
                    <button class="action-btn dmg-a" onclick="modifyHP(${u.id},'a',1)">+A</button>
                    <button class="action-btn heal" onclick="modifyHP(${u.id},'heal',1)">æ²»</button>
                    ${deployBtn}
                    <button class="action-btn" onclick="deleteUnit(${u.id})">âœ•</button>
                </div>
            `;
        }

        const avaStyle = u.avatar ? `background-image:url(${u.avatar});color:transparent;` : '';
        const initInput = `<input type="number" class="unit-init" value="${u.init}" onchange="updateInit(${u.id},this.value)" ${!isSt?'readonly':''} style="width:50px;text-align:center;">`;

        return `
            <div class="unit-card ${u.type} ${isTurn ? 'active-turn' : ''}">
                <div class="unit-header">
                    <div class="unit-avatar ${u.type}" style="${avaStyle}" onclick="uploadAvatar(${u.id})">${u.avatar?'':u.name[0]}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${escapeHtml(u.name)}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">${statusText}</div>
                    </div>
                    ${initInput}
                </div>
                <div class="hp-bar-wrap">${bar}</div>
                ${actions}
            </div>
        `;
    }).join('');
}

function renderSidebarUnits() {
    const c = document.getElementById('sidebar-units');
    if(!c) return;
    if(state.units.length === 0) { c.innerHTML = '<div style="padding:10px;text-align:center;color:#555;">ç„¡å–®ä½</div>'; return; }
    
    c.innerHTML = state.units.map((u, idx) => {
        const isTurn = idx === state.turnIdx;
        const isEnemy = u.type === 'enemy';
        const isSt = myRole === 'st';
        
        const bar = `<div class="hp-bar-wrap" style="height:6px;margin-top:4px;">` + 
            u.hpArr.map(h => `<div class="hp-chunk ${h===0?'hp-empty':h===1?'hp-b':h===2?'hp-l':'hp-a'}" style="width:${100/u.maxHp}%"></div>`).join('') + 
            `</div>`;

        let statusTxt = isEnemy && !isSt ? getVagueStatus(u) : 
            `${u.hpArr.filter(x=>x===3).length}A ${u.hpArr.filter(x=>x===2).length}L`;

        return `
            <div class="unit-card ${u.type} ${isTurn?'active-turn':''}" style="padding:8px;margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;">
                    <span style="font-weight:bold;font-size:0.9rem;">${escapeHtml(u.name)}</span>
                    <span style="color:var(--accent-yellow);font-family:'JetBrains Mono';">${u.init}</span>
                </div>
                <div style="font-size:0.75rem;color:#777;">${statusTxt}</div>
                ${bar}
            </div>
        `;
    }).join('');
}

function getVagueStatus(u) {
    const dmg = u.hpArr.filter(x => x > 0).length;
    const ratio = dmg / u.maxHp;
    if(ratio === 0) return "å®Œå¥½";
    if(ratio < 0.3) return "è¼•å‚·";
    if(ratio < 0.6) return "å—å‚·";
    if(ratio < 0.9) return "é‡å‚·";
    return "ç€•æ­»";
}

/* --- 7. ACTIONS --- */
function openAddUnitModal() { document.getElementById('modal-add-unit').classList.add('show'); }
function openBatchModal() { document.getElementById('modal-batch').classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function confirmAddUnit() {
    const name = document.getElementById('add-name').value || 'Unit';
    const hp = parseInt(document.getElementById('add-hp').value) || 10;
    const type = document.getElementById('add-type').value;
    const useAvatar = document.getElementById('add-avatar').checked;
    
    const u = createUnit(name, hp, type);
    if(useAvatar) { uploadTargetId = u.id; document.getElementById('file-upload').click(); }
    state.units.push(u);
    closeModal('modal-add-unit'); sendState(); renderAll();
}

function confirmBatchAdd() {
    const pre = document.getElementById('batch-prefix').value || 'Unit';
    const start = parseInt(document.getElementById('batch-start').value) || 1;
    const count = parseInt(document.getElementById('batch-count').value) || 5;
    const hp = parseInt(document.getElementById('batch-hp').value) || 10;
    const type = document.getElementById('batch-type').value;

    for(let i=0; i<count; i++) state.units.push(createUnit(`${pre}${start+i}`, hp, type));
    closeModal('modal-batch'); sendState(); renderAll();
}

function createUnit(name, hp, type) {
    return { id: Date.now()+Math.random(), name, maxHp: hp, hpArr: Array(hp).fill(0), type, init: 0, x: -1, y: -1, avatar: null };
}

function deleteUnit(id) {
    if(!confirm('åˆªé™¤?')) return;
    state.units = state.units.filter(u => u.id !== id);
    sendState(); renderAll();
}

function modifyHP(id, type, amount) {
    const u = state.units.find(u => u.id === id);
    if(!u) return;
    for(let i=0; i<amount; i++) {
        if (type === 'heal') {
            const idx = u.hpArr.findIndex(x => x > 0);
            if(idx !== -1) u.hpArr[idx] = 0;
        } else {
            const val = type==='b'?1:type==='l'?2:3;
            const eIdx = u.hpArr.findIndex(x => x === 0);
            if(eIdx !== -1) u.hpArr[eIdx] = val;
            else {
                // Upgrade
                const bIdx = u.hpArr.findIndex(x => x === 1);
                if(bIdx !== -1 && val >= 1) u.hpArr[bIdx] = 2;
                else {
                    const lIdx = u.hpArr.findIndex(x => x === 2);
                    if(lIdx !== -1 && val >= 1) u.hpArr[lIdx] = 3;
                }
            }
        }
        u.hpArr.sort((a,b) => b-a);
    }
    sendState(); renderAll();
}

function updateInit(id, val) {
    const u = state.units.find(u => u.id === id);
    if(u) { u.init = parseInt(val); sendState(); renderAll(); }
}
function sortByInit() {
    state.units.sort((a,b) => b.init - a.init);
    state.turnIdx = 0; sendState(); renderAll();
}
function nextTurn() {
    if(state.units.length) {
        state.turnIdx = (state.turnIdx + 1) % state.units.length;
        sendState(); renderAll();
        setTimeout(() => {
            const el = document.querySelector('.unit-card.active-turn');
            if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
        }, 100);
    }
}

function selectUnit(id) { selectedUnitId = id; renderMap(); }
function startDeploy(id) {
    switchPage('map');
    selectedUnitId = id;
    renderMap();
    showToast('è«‹åœ¨åœ°åœ–ä¸Šé»æ“Šä½ç½®éƒ¨ç½²');
}
function recallUnit(id) {
    const u = state.units.find(u => u.id === id);
    if(u) { u.x = -1; u.y = -1; sendState(); renderAll(); }
}
function clearSelection() { selectedUnitId = null; currentTool = 'cursor'; renderAll(); }

document.getElementById('file-upload').addEventListener('change', e => {
    if(!uploadTargetId) return;
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = 64; cvs.height = 64;
                cvs.getContext('2d').drawImage(img,0,0,64,64);
                const u = state.units.find(u => u.id === uploadTargetId);
                if(u) { u.avatar = cvs.toDataURL('image/jpeg',0.7); sendState(); renderAll(); }
                uploadTargetId = null;
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
});

function uploadAvatar(id) {
    if(myRole !== 'st') return;
    uploadTargetId = id;
    document.getElementById('file-upload').click();
}

/* --- 8. CALCULATOR LOGIC (FIXED) --- */
const DEF_TYPES = [
    {id:'armor',name:'ç›”ç”²',t:'physical'},{id:'shield',name:'ç›¾ç‰Œ',t:'physical'},{id:'natural',name:'å¤©ç”Ÿ',t:'physical'},
    {id:'base',name:'åŸºç¤',t:'agility'},{id:'dodge',name:'é–ƒé¿',t:'agility'},{id:'block',name:'æ ¼æ“‹',t:'agility'},{id:'shieldBlock',name:'ç›¾æ“‹',t:'agility'},
    {id:'force',name:'åŠ›å ´',t:'supernatural'},{id:'deflect',name:'åæ–œ',t:'supernatural'},{id:'magicArmor',name:'æ³•ç”²',t:'supernatural'},
    {id:'cover',name:'æ©è”½',t:'other'},{id:'insight',name:'æ´å¯Ÿ',t:'other'},{id:'other',name:'å…¶ä»–',t:'other'}
];

document.getElementById('def-inputs').innerHTML = DEF_TYPES.map(d => 
    `<div class="def-input-row" id="def-${d.id}"><span style="width:50px;font-size:0.8rem;">${d.name}</span><input type="number" data-def="${d.id}" value="0"></div>`
).join('');

function toggleDefTag(id) {
    document.querySelector(`.def-tag[data-def="${id}"]`).classList.toggle('active');
    const row = document.getElementById(`def-${id}`);
    row.classList.toggle('show');
    if(!row.classList.contains('show')) row.querySelector('input').value=0;
}
function toggleAtkTag(t) {
    document.querySelector(`.atk-tag[data-type="${t}"]`).classList.toggle('active');
    const row = document.getElementById(`row-${t}`);
    row.classList.toggle('show');
    if(!row.classList.contains('show')) row.querySelector('input').value=0;
}

function calculateDP() {
    let atk = parseInt(document.getElementById('c-atk').value)||0;
    let auto = parseInt(document.getElementById('c-atk-auto').value)||0;
    let will = parseInt(document.getElementById('c-will').value)||0;
    
    let pen = parseInt(document.getElementById('c-pen').value)||0;
    let spd = parseInt(document.getElementById('c-speed').value)||0;
    let mag = parseInt(document.getElementById('c-magic').value)||0;
    
    let defs = {};
    DEF_TYPES.forEach(t => defs[t.id] = parseInt(document.querySelector(`input[data-def="${t.id}"]`).value)||0);
    
    // Reductions
    if(pen>0 && defs.shield>0) { let r=Math.min(pen,defs.shield); defs.shield-=r; pen-=r; }
    if(pen>0 && defs.armor>0) { let r=Math.min(pen,defs.armor); defs.armor-=r; pen-=r; }
    if(pen>0 && defs.natural>0) defs.natural-=Math.min(pen,defs.natural);
    
    if(spd>0 && defs.block>0) { let r=Math.min(spd,defs.block); defs.block-=r; spd-=r; }
    if(spd>0 && defs.dodge>0) { let r=Math.min(spd,defs.dodge); defs.dodge-=r; spd-=r; }
    if(spd>0 && defs.base>0) defs.base-=Math.min(spd,defs.base);
    
    if(mag>0 && defs.force>0) { let r=Math.min(mag,defs.force); defs.force-=r; mag-=r; }
    if(mag>0 && defs.deflect>0) { let r=Math.min(mag,defs.deflect); defs.deflect-=r; mag-=r; }
    if(mag>0 && defs.magicArmor>0) defs.magicArmor-=Math.min(mag,defs.magicArmor);
    
    let hits = parseInt(document.getElementById('c-hits').value)||0;
    while(hits>0) {
        if(defs.block>0) defs.block = Math.max(0, defs.block-2);
        else if(defs.shieldBlock>0) defs.shieldBlock = Math.max(0, defs.shieldBlock-2);
        else if(defs.dodge>0) defs.dodge = Math.max(0, defs.dodge-2);
        hits--;
    }
    
    let totalDef = Object.values(defs).reduce((a,b)=>a+b,0);
    let defAuto = parseInt(document.getElementById('c-def-auto').value)||0;
    
    let final = atk + will + auto - (totalDef + defAuto);
    const rm = document.getElementById('result-main');
    const rd = document.getElementById('result-detail');
    
    if(final > 0) {
        rm.innerText = `${final} D10`; rm.style.color='var(--accent-green)';
        rd.innerText = `æ”»æ“Š ${atk+will+auto} - é˜²ç¦¦ ${totalDef+defAuto}`;
    } else {
        rm.innerText = `æ©Ÿé‹éª°`; rm.style.color='var(--accent-red)';
        rd.innerText = `DP ${final} (â‰¤0)ï¼Œè½‰ç‚ºæ©Ÿé‹éª°åˆ¤å®š`;
    }
}

/* --- BOSS LOGIC FIXED --- */
let bossActions = [];
function toggleBossMode() {
    document.getElementById('boss-options').classList.toggle('show', document.getElementById('boss-mode').checked);
}
function addBossAction() {
    bossActions.push({ id: Date.now(), winner: 'boss' }); // default boss wins init
    renderBossActions(); updateBossSummary();
}
function removeBossAction(id) {
    bossActions = bossActions.filter(a => a.id !== id);
    renderBossActions(); updateBossSummary();
}
function setBossActionWinner(id, w) {
    const a = bossActions.find(a => a.id === id);
    if(a) { a.winner = w; updateBossSummary(); }
}

function renderBossActions() {
    const d = document.getElementById('boss-actions-list');
    d.innerHTML = bossActions.map((a, i) => `
        <div class="boss-action-item">
            <span class="boss-action-num">#${i+1}</span>
            <label><input type="radio" name="ba-${a.id}" ${a.winner==='boss'?'checked':''} onchange="setBossActionWinner(${a.id},'boss')"> Bosså¿«</label>
            <label><input type="radio" name="ba-${a.id}" ${a.winner==='player'?'checked':''} onchange="setBossActionWinner(${a.id},'player')"> ç©å®¶å¿«</label>
            <button onclick="removeBossAction(${a.id})" style="margin-left:auto;color:var(--text-dim);background:none;">âœ•</button>
        </div>
    `).join('');
}

function updateBossSummary() {
    const tier = parseInt(document.getElementById('boss-tier').value) || 1;
    const engage = document.getElementById('boss-engage').value;
    const content = document.getElementById('boss-summary-content');
    const baseVal = tier * 10;
    
    if(engage === 'no') {
        content.innerHTML = `<div class="boss-summary-line"><span>æœ¬å›åˆæœªå°æŠ—ï¼Œç©å®¶ DP</span><span class="val-pos">+${baseVal}</span></div>`;
        return;
    }

    if(bossActions.length === 0) {
        content.innerHTML = '<div style="color:gray;">è«‹æ–°å¢è¡Œå‹•ä»¥è¨ˆç®—</div>';
        return;
    }

    // New Logic per user request
    let html = '';
    
    // 1. Multi-action penalty calculation
    // "è‹¥æ‡‰å°è¤‡æ•¸è¡Œå‹•ï¼Œæ¯å¤šä¸€å€‹ï¼ŒBOSSé‡å°ä½ çš„è¡Œå‹•DPå¢åŠ  Tier*10"
    const extraCount = Math.max(0, bossActions.length - 1);
    const multiPenalty = extraCount * baseVal;
    
    if(extraCount > 0) {
        html += `<div class="boss-summary-line"><span>è¤‡æ•¸è¡Œå‹•æ‡²ç½° (${extraCount}å€‹é¡å¤–)</span><span class="val-neg">Boss DP +${multiPenalty}</span></div>`;
    } else {
        html += `<div class="boss-summary-line"><span>å–®ä¸€è¡Œå‹•</span><span class="val-neutral">ç„¡æ‡²ç½°</span></div>`;
    }

    html += '<hr style="border:0;border-top:1px dashed #444;width:100%;margin:4px 0;">';

    // 2. Per action calculation
    bossActions.forEach((a, idx) => {
        let speedMod = 0;
        let speedText = "";
        
        if (a.winner === 'boss') {
            speedMod = baseVal;
            speedText = "Bosså…ˆæ”»å¿« (+10)";
        } else {
            speedMod = -baseVal;
            speedText = "Bosså…ˆæ”»æ…¢ (-10)";
        }
        
        const total = speedMod + multiPenalty;
        const colorClass = total > 0 ? 'val-neg' : (total < 0 ? 'val-pos' : 'val-neutral');
        const sign = total > 0 ? '+' : '';
        
        html += `
            <div class="boss-summary-line">
                <span>è¡Œå‹• #${idx+1} (${a.winner==='boss'?'Bosså¿«':'ç©å®¶å¿«'})</span>
                <span class="${colorClass}">Boss DP ${sign}${total}</span>
            </div>
            <div style="font-size:0.7rem;color:#666;text-align:right;margin-top:-2px;">
                (é€Ÿåº¦${speedMod > 0 ? '+' : ''}${speedMod} + æ‡²ç½°+${multiPenalty})
            </div>
        `;
    });

    content.innerHTML = html;
}

function resetCalc() {
    document.querySelectorAll('#page-calc input[type="number"]').forEach(i => {
        if(i.id!=='boss-tier') i.value=0;
    });
    document.getElementById('c-atk').value = 10; // default
    document.querySelectorAll('.active').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.def-input-row').forEach(e=>e.classList.remove('show'));
    document.getElementById('result-main').innerText='---';
}

/* --- UTILS --- */
function escapeHtml(t) { return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):t; }
function copyId() { navigator.clipboard.writeText(myPeerId).then(()=>showToast('å·²è¤‡è£½')); }
function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebar-toggle').classList.toggle('active'); }
function switchPage(p) { 
    document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); 
    document.getElementById('page-'+p).classList.add('active'); 
    document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
    document.querySelector(`.nav-tab[data-page="${p}"]`).classList.add('active');
}
</script>
</body>
</html>