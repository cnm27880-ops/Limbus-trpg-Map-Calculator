<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Limbus Command v7.4</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0a0a0b; --bg-panel: #131316; --bg-card: #1a1a1f; --bg-input: #0d0d0f;
            --border: #2a2a30; --border-focus: #404048;
            --accent-red: #e53935; --accent-green: #43a047; --accent-blue: #1e88e5;
            --accent-orange: #fb8c00; --accent-yellow: #fdd835; --accent-purple: #8e24aa;
            --text-main: #e8e8ec; --text-dim: #6e6e78; --text-muted: #48484f;
            --grid-size: 50px; --sidebar-width: 340px; --nav-height: 56px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; padding:0; background:var(--bg-main); color:var(--text-main); font-family:'Noto Sans TC',sans-serif; height:100vh; height:100dvh; overflow:hidden; display:flex; flex-direction:column; }
        ::-webkit-scrollbar { width:6px; height:6px; } ::-webkit-scrollbar-track { background:var(--bg-main); } ::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
        button { cursor:pointer; border:none; font-family:inherit; transition:all 0.1s ease; user-select: none; } button:active { transform:scale(0.96); }
        input, select { background:var(--bg-input); border:1px solid var(--border); color:var(--text-main); padding:8px 10px; border-radius:6px; font-size:0.9rem; }
        input:focus, select:focus { outline:none; border-color:var(--border-focus); }
        input[type="number"] { font-family:'JetBrains Mono',monospace; }
        .hidden { display:none !important; }

        /* Login */
        #login-layer { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; padding:20px; }
        .login-box { background:var(--bg-panel); padding:32px; border-radius:12px; border:1px solid var(--border); width:100%; max-width:380px; text-align:center; }
        .login-title { font-size:1.8rem; font-weight:700; color:var(--accent-red); margin-bottom:4px; }
        .login-btn { width:100%; padding:14px; font-weight:600; font-size:1rem; color:#000; border-radius:8px; margin-top:8px; }
        .btn-host { background:linear-gradient(135deg,var(--accent-red),#c62828); }
        .btn-join { background:linear-gradient(135deg,var(--accent-blue),#1565c0); }
        .btn-back { background:var(--bg-card); color:var(--text-dim); margin-top:16px; }

        /* Navbar */
        .navbar { height:var(--nav-height); background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; gap:8px; z-index:100; flex-shrink:0; }
        .nav-tabs { display:flex; gap:4px; flex:1; }
        .nav-tab { background:transparent; color:var(--text-dim); padding:8px 16px; font-size:0.9rem; border-radius:8px; display:flex; align-items:center; gap:6px; }
        .nav-tab.active { background:var(--bg-card); color:var(--text-main); }
        .id-badge { background:var(--bg-card); color:var(--accent-green); padding:6px 10px; border-radius:6px; font-family:'JetBrains Mono',monospace; font-size:0.75rem; cursor:pointer; border:1px dashed var(--border); }
        .sidebar-toggle { display:none; background:var(--bg-card); color:var(--text-dim); padding:8px 12px; border-radius:6px; }
        .sidebar-toggle.active { color:var(--accent-yellow); }

        /* Layout */
        .main-wrapper { flex:1; display:flex; overflow:hidden; position:relative; }
        .page { position:absolute; inset:0; display:none; overflow:hidden; }
        .page.active { display:flex; }

        /* Map Page */
        #page-map { flex-direction:row; }
        .sidebar { width:var(--sidebar-width); background:var(--bg-panel); border-right:1px solid var(--border); display:none; flex-direction:column; overflow:hidden; flex-shrink:0; }
        .sidebar.show { display:flex; }
        .sidebar-header { padding:12px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .sidebar-content { flex:1; overflow-y:auto; padding:12px; }

        .map-toolbar { background:var(--bg-panel); border-bottom:1px solid var(--border); padding:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; z-index:10; }
        .map-tools-scroll { display:flex; gap:6px; overflow-x:auto; max-width:100%; padding-bottom:2px; }
        .tool-btn { width:36px; height:36px; flex-shrink:0; background:var(--bg-card); color:var(--text-dim); border-radius:6px; font-size:1rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .tool-btn.active { box-shadow:0 0 0 2px var(--accent-yellow); color:#fff; }
        .tool-btn .color-indicator { width:8px; height:8px; border-radius:50%; position:absolute; bottom:4px; right:4px; border:1px solid rgba(255,255,255,0.5); }
        .tool-separator { width:1px; height:24px; background:var(--border); margin:0 4px; flex-shrink:0; }
        
        /* Map Controls */
        .map-controls-right { display:flex; gap:8px; align-items:center; margin-left:auto; }
        .map-select { width:130px; padding:6px; font-size:0.8rem; }
        .size-input { width:45px; text-align:center; padding:6px; }
        .apply-btn { background:var(--bg-card); padding:6px 12px; border-radius:6px; font-size:0.8rem; }

        /* Map Viewport & Container */
        .map-viewport { flex:1; background:#050506; position:relative; overflow:hidden; cursor: grab; }
        .map-viewport:active { cursor: grabbing; }
        .map-container { position:absolute; left:50%; top:50%; transform-origin: center center; will-change:transform; user-select: none; }
        
        #battle-map { display:grid; border:2px solid #444; background:var(--bg-main); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .cell { width:var(--grid-size); height:var(--grid-size); border:1px solid rgba(255,255,255,0.05); position:relative; touch-action: none; }
        
        /* Tile Vis */
        .cell.deploy-target { background:rgba(253,216,53,0.3) !important; box-shadow:inset 0 0 0 2px var(--accent-yellow); cursor: crosshair; }

        /* Tokens */
        .token {
            position:absolute;
            width: calc(var(--grid-size) - 4px);
            height: calc(var(--grid-size) - 4px);
            border-radius:50%; border:2px solid #fff;
            background-size:cover; background-position:center; background-color:#333;
            z-index:10; display:flex; align-items:center; justify-content:center;
            font-weight:700; font-size:16px; color:#fff; text-shadow:0 1px 3px #000;
            pointer-events: auto; cursor: grab; transition: transform 0.1s, left 0.15s, top 0.15s;
            touch-action: none;
        }
        .token:active { cursor: grabbing; }
        .token.selected { transform:scale(1.15); box-shadow:0 0 0 3px var(--accent-yellow); z-index:20; }
        .token.dragging { z-index: 100; transition: none; opacity: 0.9; transform: scale(1.1); }
        .token.enemy { border-color:var(--accent-red); } 
        .token.player { border-color:var(--accent-green); }

        /* Units Page */
        #page-units { flex-direction:column; background:var(--bg-main); }
        .units-toolbar { background:var(--bg-panel); border-bottom:1px solid var(--border); padding:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .units-btn { background:var(--bg-card); color:var(--text-main); padding:8px 14px; border-radius:8px; font-size:0.85rem; display:flex; align-items:center; gap:6px; }
        .units-btn.primary { background:var(--accent-yellow); color:#000; font-weight:600; }
        .units-list { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }

        .unit-card { background:var(--bg-card); border-radius:8px; padding:10px; border-left:4px solid var(--text-muted); display:flex; flex-direction:column; gap:8px; }
        .unit-card.enemy { border-left-color:var(--accent-red); } .unit-card.player { border-left-color:var(--accent-green); }
        .unit-card.active-turn { box-shadow:0 0 0 2px var(--accent-yellow); background:#1f1f24; }
        .unit-header { display:flex; align-items:center; gap:10px; }
        .unit-avatar { width:42px; height:42px; border-radius:6px; background:var(--bg-input); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-weight:600; background-size:cover; flex-shrink:0; cursor: pointer; }
        .unit-avatar.enemy { border-color:var(--accent-red); color:var(--accent-red); } .unit-avatar.player { border-color:var(--accent-green); color:var(--accent-green); }
        
        .hp-bar-wrap { height:10px; background:var(--bg-input); border-radius:3px; display:flex; overflow:hidden; border:1px solid var(--border); width:100%; }
        .hp-chunk { height:100%; }
        .hp-empty { background:#1a1a1f; } .hp-b { background:var(--accent-blue); } .hp-l { background:var(--accent-orange); } .hp-a { background:var(--accent-red); }
        
        .unit-actions { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
        .action-btn { flex:1; min-width:40px; padding:6px; background:var(--bg-input); color:var(--text-dim); border-radius:4px; font-size:0.75rem; border:1px solid transparent; }
        .action-btn:hover { color:var(--text-main); border-color:var(--border); }
        .action-btn.dmg-b { color:var(--accent-blue); } .action-btn.dmg-l { color:var(--accent-orange); } .action-btn.dmg-a { color:var(--accent-red); } .action-btn.heal { color:var(--accent-green); }

        /* Calculator */
        #page-calc { flex-direction:column; background:var(--bg-main); overflow-y:auto; padding:16px; }
        .calc-container { max-width:650px; width:100%; margin:0 auto; display:flex; flex-direction:column; gap:12px; }
        .calc-section { background:var(--bg-card); border-radius:10px; padding:14px; border:1px solid var(--border); }
        .calc-section-title { font-size:0.8rem; font-weight:700; color:var(--text-dim); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; gap:8px; }
        .calc-section-title.atk { color:var(--accent-green); } .calc-section-title.def { color:var(--accent-red); }
        .calc-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .calc-field { display:flex; flex-direction:column; gap:4px; }
        .calc-label { font-size:0.75rem; color:var(--text-dim); }

        /* Boss Mode Styles */
        .boss-toggle { display:flex; align-items:center; gap:12px; padding:10px; background:var(--bg-input); border-radius:6px; cursor:pointer; }
        .boss-toggle input[type="checkbox"] { width:18px; height:18px; accent-color:var(--accent-purple); }
        .boss-options { margin-top:10px; padding-top:10px; border-top:1px dashed var(--border); display:none; }
        .boss-options.show { display:block; }
        
        .boss-action-item { display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg-input); border-radius:6px; border-left:3px solid var(--accent-purple); margin-bottom:6px; flex-wrap:wrap; }
        .boss-action-num { font-weight:bold; color:var(--accent-purple); min-width:20px; }
        .boss-add-action { width:100%; padding:8px; background:var(--bg-card); border:1px dashed var(--border); border-radius:6px; color:var(--text-dim); margin-top:8px; }
        
        .boss-summary { margin-top:12px; padding:12px; background:rgba(142,36,170,0.08); border-radius:6px; border:1px solid var(--accent-purple); }
        .boss-summary-line { font-size:0.85rem; margin-bottom:4px; display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:4px; }
        .boss-summary-line:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
        .val-pos { color:var(--accent-green); font-weight:bold; }
        .val-neg { color:var(--accent-red); font-weight:bold; }
        .val-neutral { color:var(--text-dim); }

        .calc-buttons { display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-top:10px; }
        .calc-btn { padding:14px; border-radius:8px; font-weight:600; font-size:1rem; }
        .calc-btn-reset { background:var(--bg-card); color:var(--text-dim); }
        .calc-btn-calc { background:linear-gradient(135deg,var(--accent-green),#2e7d32); color:#000; }
        
        .def-tags, .atk-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; }
        .def-tag, .atk-tag { padding:4px 10px; background:var(--bg-input); border:1px solid var(--border); border-radius:15px; font-size:0.75rem; color:var(--text-dim); cursor:pointer; }
        .def-tag.active { color:#000; border-color:transparent; }
        .def-tag.physical.active { background:var(--accent-orange); } .def-tag.agility.active { background:var(--accent-green); } .def-tag.supernatural.active { background:var(--accent-purple); } .def-tag.other.active { background:var(--accent-blue); }
        .atk-tag.active { background:var(--accent-red); color:#000; }
        .def-inputs { display:flex; flex-direction:column; gap:8px; }
        .def-input-row { display:none; align-items:center; gap:8px; padding:6px; background:var(--bg-input); border-radius:6px; }
        .def-input-row.show { display:flex; }

        /* Modals */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:none; justify-content:center; align-items:center; padding:15px; }
        .modal-overlay.show { display:flex; }
        .modal { background:var(--bg-panel); border-radius:10px; border:1px solid var(--border); width:100%; max-width:400px; max-height:90vh; overflow-y:auto; }
        .modal-header { padding:14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:16px; display:flex; flex-direction:column; gap:14px; }
        .modal-footer { padding:14px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }
        .modal-btn { padding:8px 16px; border-radius:6px; }
        
        /* Helper */
        .toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:#222; border:1px solid var(--accent-green); color:#fff; padding:10px 20px; border-radius:30px; z-index:3000; opacity:0; transition:all 0.3s; pointer-events:none; font-size:0.9rem; }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

        /* Connection Status */
        .conn-status { display:flex; align-items:center; gap:6px; padding:4px 10px; border-radius:20px; font-size:0.75rem; background:var(--bg-card); }
        .conn-dot { width:8px; height:8px; border-radius:50%; animation: pulse 2s infinite; }
        .conn-dot.online { background:var(--accent-green); }
        .conn-dot.offline { background:var(--accent-red); animation:none; }
        .conn-dot.connecting { background:var(--accent-yellow); }
        @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }

        /* Player Code Display */
        .player-code { font-family:'JetBrains Mono',monospace; font-size:1.5rem; font-weight:bold; letter-spacing:4px; color:var(--accent-yellow); background:var(--bg-input); padding:8px 16px; border-radius:8px; border:2px dashed var(--accent-yellow); margin:10px 0; cursor:pointer; }
        .player-code:hover { background:var(--bg-card); }
        
        #tile-info-panel {
            background: rgba(0,0,0,0.6); border: 1px solid var(--border);
            border-radius: 6px; padding: 10px; margin-bottom: 10px;
            font-size: 0.8rem; color: var(--text-dim); display: none;
        }

        @media (min-width:1024px) { .sidebar-toggle { display:flex; } .sidebar.show { display:flex; } }
        @media (max-width:1023px) { .map-controls-right { display:none; } .nav-tab { padding:8px 10px; font-size:0.8rem; } }
    </style>
</head>
<body>
<input type="file" id="file-upload" accept="image/*" style="display:none;">
<div class="toast" id="toast"></div>

<!-- Login -->
<div id="login-layer">
    <div class="login-box" id="login-main">
        <div class="login-title">LIMBUS</div>
        <div style="color:var(--text-dim);margin-bottom:20px;">æˆ°è¡“æŒ‡æ®ç³»çµ± v7.4</div>
        <input type="text" id="input-name" placeholder="è¼¸å…¥ä»£è™Ÿ" style="width:100%;text-align:center;margin-bottom:10px;">
        <button class="login-btn btn-host" onclick="showSTStep()">æˆ‘æ˜¯ STï¼ˆå»ºæˆ¿ï¼‰</button>
        <button class="login-btn btn-join" onclick="showJoinStep()">æˆ‘æ˜¯ç©å®¶ï¼ˆåŠ å…¥ï¼‰</button>
    </div>
    <div class="login-box hidden" id="login-st">
        <div class="login-title">å»ºç«‹æˆ¿é–“</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">å¦‚æœ‰èˆŠè­˜åˆ¥ç¢¼å¯è¼¸å…¥ä»¥æ¢å¾©èº«ä»½</div>
        <input type="text" id="input-st-code" placeholder="4 ä½æ•¸è­˜åˆ¥ç¢¼ï¼ˆé¸å¡«ï¼‰" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-host" onclick="initSystem('st')">å»ºç«‹æˆ¿é–“</button>
        <button class="login-btn btn-back" onclick="showMainStep()">è¿”å›</button>
    </div>
    <div class="login-box hidden" id="login-join">
        <div class="login-title">åŠ å…¥æˆ¿é–“</div>
        <input type="text" id="input-host-id" placeholder="è²¼ä¸Š ST çš„æˆ¿é–“ ID" style="width:100%;text-align:center;margin-bottom:10px;">
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">å¦‚æœ‰èˆŠè­˜åˆ¥ç¢¼å¯è¼¸å…¥ä»¥æ¢å¾©èº«ä»½</div>
        <input type="text" id="input-player-code" placeholder="4 ä½æ•¸è­˜åˆ¥ç¢¼ï¼ˆé¸å¡«ï¼‰" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-join" onclick="initSystem('player')">é€£ç·š</button>
        <button class="login-btn btn-back" onclick="showMainStep()">è¿”å›</button>
    </div>
    <div class="login-box hidden" id="login-loading">
        <div style="color:var(--accent-green);margin-bottom:10px;">é€£ç·šä¸­...</div>
        <div id="loading-status" style="font-size:0.8rem;color:var(--text-dim);"></div>
    </div>
</div>

<!-- Nav -->
<nav class="navbar">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="map" onclick="switchPage('map')">ğŸ—ºï¸ åœ°åœ–</button>
        <button class="nav-tab" data-page="units" onclick="switchPage('units')">âš”ï¸ å–®ä½</button>
        <button class="nav-tab" data-page="calc" onclick="switchPage('calc')">ğŸ² è¨ˆç®—</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
        <div class="conn-status" id="conn-status" title="é€£ç·šç‹€æ…‹">
            <div class="conn-dot connecting" id="conn-dot"></div>
            <span id="conn-text">é€£ç·šä¸­</span>
        </div>
        <span class="player-code" id="my-code" onclick="copyMyCode()" title="é»æ“Šè¤‡è£½è­˜åˆ¥ç¢¼" style="font-size:0.9rem;padding:4px 8px;display:none;">----</span>
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">ğŸ“‹</button>
        <span class="id-badge" id="my-id" onclick="copyId()" title="é»æ“Šè¤‡è£½ID">---</span>
    </div>
</nav>

<!-- Content -->
<div class="main-wrapper">
    <!-- Map -->
    <div id="page-map" class="page active">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><span style="font-weight:bold;color:var(--accent-yellow);">æˆ°é¬¥åºåˆ—</span><button style="background:none;color:var(--text-dim);font-size:1.2rem;" onclick="toggleSidebar()">Ã—</button></div>
            <div class="sidebar-content">
                <div id="tile-info-panel">
                    <div style="color:var(--accent-yellow);font-weight:bold;margin-bottom:4px;">åœ°å½¢æ•ˆæœ</div>
                    <div id="tile-effect-desc"></div>
                </div>
                <div id="sidebar-units"></div>
            </div>
        </aside>
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;">
            <div class="map-toolbar">
                <div class="map-tools-scroll" id="dynamic-tools">
                    <button class="tool-btn active" data-tool="cursor" onclick="setTool('cursor')">ğŸ‘†</button>
                    <button class="tool-btn" data-tool="floor" onclick="setTool('floor')">ğŸ§¹</button>
                </div>
                <div class="tool-separator"></div>
                <button class="tool-btn" onclick="resetCamera()" title="è¦–è§’æ­¸ä½">ğŸ¯</button>
                <button class="tool-btn" onclick="clearSelection()" title="å–æ¶ˆé¸å–">âœ•</button>
                
                <div class="map-controls-right" id="st-map-controls">
                    <select id="map-theme-select" class="map-select" onchange="changeMapTheme(this.value)">
                        <option value="0">ä¸€èˆ¬è¨“ç·´å®¤</option>
                        <option value="1">å¾Œå··æ·±è™•</option>
                        <option value="2">L å…¬å¸å»¢å¢Ÿ</option>
                        <option value="3">W å…¬å¸åˆ—è»Š</option>
                        <option value="4">K å…¬å¸å·¥å» </option>
                        <option value="5">U å…¬å¸ç”²æ¿</option>
                        <option value="6">å†°é›ªåŸå ¡</option>
                        <option value="7">è¡€è‚‰å±±ä¸˜</option>
                    </select>
                    <input type="number" id="map-w" class="size-input" value="15" min="5" max="50">
                    <span style="font-size:0.8rem;color:#555;">x</span>
                    <input type="number" id="map-h" class="size-input" value="15" min="5" max="50">
                    <button class="apply-btn" onclick="resizeMap()">å¥—ç”¨</button>
                </div>
            </div>
            <!-- Map Viewport with Pan/Zoom logic -->
            <div class="map-viewport" id="map-viewport">
                <div class="map-container" id="map-container">
                    <div id="battle-map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Units -->
    <div id="page-units" class="page">
        <div class="units-toolbar" id="units-toolbar">
            <button class="units-btn primary" onclick="nextTurn()">â–¶ ä¸‹ä¸€å›åˆ</button>
            <button class="units-btn" onclick="openAddUnitModal()">+ æ–°å¢</button>
            <button class="units-btn" onclick="openBatchModal()">ğŸ“‹ æ‰¹é‡</button>
            <button class="units-btn" onclick="sortByInit()">â± æ’åº</button>
        </div>
        <div class="units-list" id="units-list"></div>
    </div>

    <!-- Calculator -->
    <div id="page-calc" class="page">
        <div class="calc-container">
            <!-- Boss Mode Section -->
            <div class="calc-section">
                <label class="boss-toggle">
                    <input type="checkbox" id="boss-mode" onchange="toggleBossMode()">
                    <div>
                        <div style="font-weight:bold;color:var(--accent-purple);">ğŸ”® ç‰¹æ®Š BOSS æ¨¡å¼</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">å•Ÿç”¨æˆ¿è¦è¨ˆç®—ï¼šè¤‡æ•¸è¡Œå‹•ã€å…ˆæ”»åŠ æˆ</div>
                    </div>
                </label>
                <div class="boss-options" id="boss-options">
                    <div class="calc-grid">
                        <div class="calc-field"><span class="calc-label">ä¸»ç·š/æ”¯ç·šç­‰ç´š</span><input type="number" id="boss-tier" value="1" min="1" max="10" onchange="updateBossSummary()"></div>
                        <div class="calc-field"><span class="calc-label">æœ¬å›åˆç‹€æ³</span><select id="boss-engage" onchange="updateBossSummary()"><option value="yes">æœ‰å°æŠ—è¡Œå‹•</option><option value="no">å®Œå…¨æœªå°æŠ— (æˆ‘æ–¹DP+)</option></select></div>
                    </div>
                    
                    <div id="boss-actions-list" style="margin-top:10px;"></div>
                    <button class="boss-add-action" onclick="addBossAction()">+ æ–°å¢å°æŠ—è¡Œå‹•</button>

                    <div class="boss-summary">
                        <div style="font-weight:bold;color:var(--accent-purple);margin-bottom:6px;">ğŸ“Š çµæœé è¦½</div>
                        <div id="boss-summary-content" style="display:flex;flex-direction:column;gap:4px;"></div>
                    </div>
                </div>
            </div>

            <!-- Standard Calc -->
            <div class="calc-section">
                <div class="calc-section-title atk">ğŸ—¡ï¸ æ”»æ“Šæ–¹ (æˆ‘æ–¹)</div>
                <div class="atk-tags">
                    <span class="atk-tag" data-type="pen" onclick="toggleAtkTag('pen')">ç ´ç”²</span>
                    <span class="atk-tag" data-type="speed" onclick="toggleAtkTag('speed')">é«˜é€Ÿ</span>
                    <span class="atk-tag" data-type="magic" onclick="toggleAtkTag('magic')">ç ´é­”</span>
                </div>
                <div class="calc-grid">
                    <div class="calc-field"><span class="calc-label">æ”»æ“Š DP</span><input type="number" id="c-atk" value="10" min="0"></div>
                    <div class="calc-field"><span class="calc-label">æ”»æ“Šé™„åŠ æˆåŠŸ</span><input type="number" id="c-atk-auto" value="0" min="0"></div>
                    <div class="calc-field def-input-row" id="row-pen"><span style="font-size:0.75rem;">ç ´ç”²å€¼</span><input type="number" style="width:60px;" id="c-pen" value="0"></div>
                    <div class="calc-field def-input-row" id="row-speed"><span style="font-size:0.75rem;">é«˜é€Ÿå€¼</span><input type="number" style="width:60px;" id="c-speed" value="0"></div>
                    <div class="calc-field def-input-row" id="row-magic"><span style="font-size:0.75rem;">ç ´é­”å€¼</span><input type="number" style="width:60px;" id="c-magic" value="0"></div>
                    <div class="calc-field"><span class="calc-label">æ„å¿—åŠ å€¼</span><select id="c-will"><option value="0">ä¸ä½¿ç”¨</option><option value="3">+3 (å®Œç¾)</option></select></div>
                </div>
            </div>

            <div class="calc-section">
                <div class="calc-section-title def">ğŸ›¡ï¸ é˜²ç¦¦æ–¹ (æ•µæ–¹)</div>
                <div class="def-tags">
                    <span class="def-tag physical" data-def="armor" onclick="toggleDefTag('armor')">ç›”ç”²</span>
                    <span class="def-tag physical" data-def="shield" onclick="toggleDefTag('shield')">ç›¾ç‰Œ</span>
                    <span class="def-tag physical" data-def="natural" onclick="toggleDefTag('natural')">å¤©ç”Ÿ</span>
                    <span class="def-tag agility" data-def="base" onclick="toggleDefTag('base')">åŸºç¤</span>
                    <span class="def-tag agility" data-def="dodge" onclick="toggleDefTag('dodge')">é–ƒé¿</span>
                    <span class="def-tag agility" data-def="block" onclick="toggleDefTag('block')">æ ¼æ“‹</span>
                    <span class="def-tag agility" data-def="shieldBlock" onclick="toggleDefTag('shieldBlock')">ç›¾æ“‹</span>
                    <span class="def-tag supernatural" data-def="force" onclick="toggleDefTag('force')">åŠ›å ´</span>
                    <span class="def-tag supernatural" data-def="deflect" onclick="toggleDefTag('deflect')">åæ–œ</span>
                    <span class="def-tag supernatural" data-def="magicArmor" onclick="toggleDefTag('magicArmor')">æ³•ç”²</span>
                    <span class="def-tag other" data-def="cover" onclick="toggleDefTag('cover')">æ©è”½</span>
                    <span class="def-tag other" data-def="insight" onclick="toggleDefTag('insight')">æ´å¯Ÿ</span>
                    <span class="def-tag other" data-def="other" onclick="toggleDefTag('other')">å…¶ä»–</span>
                </div>
                <div class="def-inputs" id="def-inputs"></div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">
                    <div class="calc-grid">
                        <div class="calc-field"><span class="calc-label">æœ¬å›åˆå·²å—æ“Šæ¬¡æ•¸</span><input type="number" id="c-hits" value="0" min="0"></div>
                        <div class="calc-field"><span class="calc-label" style="color:var(--accent-orange)">é˜²ç¦¦é™„åŠ æˆåŠŸ</span><input type="number" id="c-def-auto" value="0" min="0"></div>
                    </div>
                </div>
            </div>

            <div class="calc-buttons">
                <button class="calc-btn calc-btn-reset" onclick="resetCalc()">ğŸ”„ é‡ç½®</button>
                <button class="calc-btn calc-btn-calc" onclick="calculateDP()">âš¡ è¨ˆç®— (åƒ…ä¸€èˆ¬)</button>
            </div>
            <div style="text-align:center;padding:15px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);">
                <div id="result-main" style="font-size:2rem;font-weight:bold;color:var(--accent-green);">---</div>
                <div id="result-detail" style="font-size:0.8rem;color:var(--text-dim);margin-top:5px;">ä¸€èˆ¬è¨ˆç®—çµæœé¡¯ç¤ºæ–¼æ­¤<br>(BOSSæ¨¡å¼è«‹çœ‹ä¸Šæ–¹é è¦½é¢æ¿)</div>
            </div>
        </div>
    </div>
</div>

<!-- Add Unit Modal -->
<div class="modal-overlay" id="modal-add-unit">
    <div class="modal">
        <div class="modal-header"><span>æ–°å¢å–®ä½</span><button onclick="closeModal('modal-add-unit')">Ã—</button></div>
        <div class="modal-body">
            <input type="text" id="add-name" placeholder="åç¨±">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <input type="number" id="add-hp" value="10" placeholder="HP">
                <select id="add-type"><option value="enemy">æ•µæ–¹</option><option value="player">æˆ‘æ–¹</option></select>
            </div>
            <label><input type="checkbox" id="add-avatar"> ä¸Šå‚³é ­åƒ</label>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-add-unit')" style="background:var(--bg-card);">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmAddUnit()" style="background:var(--accent-green);color:#000;">ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- Batch Modal -->
<div class="modal-overlay" id="modal-batch">
    <div class="modal">
        <div class="modal-header"><span>æ‰¹é‡æ–°å¢</span><button onclick="closeModal('modal-batch')">Ã—</button></div>
        <div class="modal-body">
            <input type="text" id="batch-prefix" placeholder="å‰ç¶´ (ä¾‹: é›œå…µ)">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="calc-field"><span class="calc-label">èµ·å§‹ç·¨è™Ÿ</span><input type="number" id="batch-start" value="1"></div>
                <div class="calc-field"><span class="calc-label">æ•¸é‡</span><input type="number" id="batch-count" value="5"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="calc-field"><span class="calc-label">HP</span><input type="number" id="batch-hp" value="10"></div>
                <div class="calc-field"><span class="calc-label">é¡å‹</span><select id="batch-type"><option value="enemy">æ•µæ–¹</option><option value="player">æˆ‘æ–¹</option></select></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-batch')" style="background:var(--bg-card);">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmBatchAdd()" style="background:var(--accent-green);color:#000;">ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- HP Modify Modal -->
<div class="modal-overlay" id="modal-hp">
    <div class="modal">
        <div class="modal-header"><span id="hp-modal-title">ä¿®æ”¹ HP</span><button onclick="closeModal('modal-hp')">Ã—</button></div>
        <div class="modal-body">
            <div id="hp-modal-mode-damage" style="display:none;">
                <div style="margin-bottom:10px;color:var(--text-dim);">é¸æ“‡å‚·å®³é¡å‹ï¼š</div>
                <div style="display:flex;gap:8px;margin-bottom:15px;">
                    <button class="action-btn dmg-b" style="flex:1;padding:12px;" onclick="setHpModalType('b')">B å‚· (éˆæ“Š)</button>
                    <button class="action-btn dmg-l" style="flex:1;padding:12px;" onclick="setHpModalType('l')">L å‚· (ç©¿åˆº)</button>
                    <button class="action-btn dmg-a" style="flex:1;padding:12px;" onclick="setHpModalType('a')">A å‚· (æƒ¡åŒ–)</button>
                </div>
            </div>
            <div id="hp-modal-mode-heal" style="display:none;">
                <div style="margin-bottom:10px;color:var(--text-dim);">é¸æ“‡è¦æ²»ç™‚çš„å‚·å‹¢é¡å‹ï¼š</div>
                <div style="display:flex;gap:8px;margin-bottom:15px;">
                    <button class="action-btn dmg-b" style="flex:1;padding:12px;" onclick="setHpModalType('heal-b')">æ²»ç™‚ B å‚·</button>
                    <button class="action-btn dmg-l" style="flex:1;padding:12px;" onclick="setHpModalType('heal-l')">æ²»ç™‚ L å‚·</button>
                    <button class="action-btn dmg-a" style="flex:1;padding:12px;" onclick="setHpModalType('heal-a')">æ²»ç™‚ A å‚·</button>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <span class="calc-label" style="white-space:nowrap;">æ•¸é‡ï¼š</span>
                <input type="number" id="hp-amount" value="1" min="1" style="flex:1;text-align:center;font-size:1.2rem;">
            </div>
            <input type="hidden" id="hp-target-id">
            <input type="hidden" id="hp-action-type" value="b">
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('modal-hp')" style="background:var(--bg-card);">å–æ¶ˆ</button>
            <button class="modal-btn" onclick="confirmHpModify()" style="background:var(--accent-green);color:#000;">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
/* --- 1. CONFIG & DATA --- */
const MAP_PRESETS = [
    { name: "ä¸€èˆ¬è¨“ç·´å®¤", tiles: [
        { id: 10, color: '#2a2a30', name: 'ç‰†å£', effect: 'ä¸å¯é€šè¡Œ' },
        { id: 11, color: 'rgba(67,160,71,0.15)', name: 'æ©é«”', effect: 'æä¾›æ©è”½ (+4 DP)' },
        { id: 12, color: 'rgba(229,57,53,0.15)', name: 'éšªåœ°', effect: 'æ¯å›åˆ 1 é»å‚·å®³' },
        { id: 13, color: '#111114', name: 'åœ°æ¿', effect: 'ç„¡ç‰¹æ®Šæ•ˆæœ' }
    ]},
    { name: "å¾Œå··æ·±è™•", tiles: [
        { id: 20, color: '#4e342e', name: 'ç”Ÿé½æ©é«”', effect: 'ç¡¬æ©é«”ï¼šä¸å¯é€šè¡Œã€‚è²¼ç‰†ç«™ç«‹æ™‚ï¼Œé ç¨‹é˜²ç¦¦+4ã€‚' },
        { id: 21, color: '#0d47a1', name: 'æ²¹æ±¡ç©æ°´', effect: 'æ¿•æ»‘ï¼šé˜²ç¦¦-4ã€‚å—ç«ç„°å‚·å®³æ™‚é¡å¤–+3ç¼ç‡’ã€‚' },
        { id: 22, color: '#fdd835', name: 'è·¯ç‡ˆ/éœ“è™¹', effect: 'æš´éœ²ï¼šç„¡æ³•éš±èº«ã€‚ç„¡è¦–é»‘æš—æ¸›å€¼ã€‚' },
        { id: 23, color: '#1b5e20', name: 'åƒåœ¾å †', effect: 'éª¯é«’ï¼šç§»å‹•å›°é›£ã€‚å›åˆçµæŸæ™‚å—3é»æ¯’ç´ (L)ã€‚' }
    ]},
    { name: "Lå…¬å¸å»¢å¢Ÿ", tiles: [
        { id: 30, color: '#00e676', name: 'Cogitoæ´©æ¼', effect: 'ç²¾ç¥è…è•ï¼šå›åˆçµæŸæ‰£3æ„å¿—ï¼Œè‹¥ç©ºå‰‡3Aå‚·ã€‚' },
        { id: 31, color: '#616161', name: 'æ”¶å®¹é–€', effect: 'å …å›ºæ©é«”ï¼šé˜²ç¦¦+6ã€‚å—å‚·>10æ™‚ç²‰ç¢ã€‚' },
        { id: 32, color: '#b71c1c', name: 'æ´»æ€§å±å¡Š', effect: 'æŠ“æ’“ï¼šåªèƒ½æ¨™æº–ç§»å‹•ã€‚é€²å…¥å—1Lå‚·ã€‚' },
        { id: 33, color: '#ffb300', name: 'æŠ‘åˆ¶åŠ›å ´', effect: 'ç†æ™ºç¶­è­·ï¼šç²¾ç¥å‚·å®³æ¸›åŠã€‚' }
    ]},
    { name: "Wå…¬å¸åˆ—è»Š", tiles: [
        { id: 40, color: '#00bcd4', name: 'ç©ºé–“è£‚éš™', effect: 'ç›¸ä½å‚³é€ï¼šå¼·åˆ¶å‚³é€åˆ°éš¨æ©Ÿè£‚éš™ï¼ŒçµæŸç§»å‹•ã€‚' },
        { id: 41, color: '#f06292', name: 'è¡€è‚‰åº§æ¤…', effect: 'é»è‘—ï¼šç§»å‹•å›°é›£ã€‚è¿‘æˆ°æ”»æ“ŠDP-6ã€‚' },
        { id: 42, color: '#ffd700', name: 'é ­ç­‰è‰™å±éšœ', effect: 'éš”é›¢ï¼šé˜»æ“‹è¦–ç·šã€‚éœ€è»Šç¥¨æˆ–20+å‚·å®³ç ´å£ã€‚' },
        { id: 43, color: '#eeeeee', name: 'æ™‚é–“åœæ»¯', effect: 'å‡çµï¼šç‹€æ…‹æŒçºŒæ™‚é–“ä¸æ¸›å°‘ã€‚' }
    ]},
    { name: "Kå…¬å¸å·¥å» ", tiles: [
        { id: 50, color: '#69f0ae', name: 'HPå®‰ç“¿', effect: 'éåº¦å†ç”Ÿï¼šå›åˆé–‹å§‹å›4HPï¼Œæº¢å‡ºè½‰å‚·å®³ã€‚' },
        { id: 51, color: '#81d4fa', name: 'ç»ç’ƒæ£§é“', effect: 'æ˜“ç¢ï¼šå—çˆ†ç‚¸/éˆæ“Šæ™‚é˜²ç¦¦-6ã€‚' },
        { id: 52, color: '#fff176', name: 'ç›£æ§å€åŸŸ', effect: 'é–å®šï¼šå—åˆ°çš„æ‰€æœ‰å‚·å®³+3ã€‚' },
        { id: 53, color: '#ffffff', name: 'æ¶ˆæ¯’å™´å˜´', effect: 'æ·¨åŒ–ï¼šé€²å…¥æ™‚ç§»é™¤æ‰€æœ‰ç‹€æ…‹(Buff/Debuff)ã€‚' }
    ]},
    { name: "Uå…¬å¸ç”²æ¿", tiles: [
        { id: 60, color: '#5d4037', name: 'æ¿•æ»‘ç”²æ¿', effect: 'é‡å¿ƒä¸ç©©ï¼šæ”»æ“ŠDP-6ã€‚æ“Šé€€è·é›¢+5ã€‚' },
        { id: 61, color: '#1a237e', name: 'å·¨æµªæ‹æ‰“', effect: 'è¡æ“Šï¼šå›åˆçµæŸå—3Lå‚·ä¸¦å¾Œé€€1æ ¼ã€‚' },
        { id: 62, color: '#455a64', name: 'é­šå‰ç™¼å°„å™¨', effect: 'æ©é«”+6é˜²ç¦¦ã€‚ç›¸é„°å¯ç™¼å°„é­šå‰(ç›´ç·š8æ ¼, 15DP)ã€‚' },
        { id: 63, color: '#7b1fa2', name: 'å…±é³´éŸ³å‰', effect: 'å…±æŒ¯ï¼šæ­¤æ ¼åŠç›¸é„°å‹æ–¹è¿‘æˆ°DP+6ã€‚' }
    ]},
    { name: "å†°é›ªåŸå ¡", tiles: [
        { id: 70, color: '#80deea', name: 'è¬å¹´ç„å†°', effect: 'è„†åŒ–ï¼šå—ç‰©ç†å‚·å®³æ™‚å‚·å®³+3ã€‚' },
        { id: 71, color: '#ffffff', name: 'å·¨å¤§å†°åˆº', effect: 'åˆºç©¿ï¼šé€²å…¥/ç¶“éå—3Lå‚·ã€‚' },
        { id: 72, color: '#006064', name: 'å‡çµä¾›å“', effect: 'æ©é«”+6ã€‚ç ´å£æ™‚å‘¨åœ1æ ¼éº»ç—º3å±¤ã€‚' },
        { id: 73, color: '#0d47a1', name: 'æ·±æ·µé‚Šç·£', effect: 'æ­»äº¡é‚Šç•Œï¼šæ“Šé€€å…¥æ­¤æ ¼è¦–ç‚ºå¢œè½/æ­»äº¡ã€‚' }
    ]},
    { name: "è¡€è‚‰å±±ä¸˜", tiles: [
        { id: 80, color: '#b71c1c', name: 'è •å‹•å±éª¸', effect: 'æ³¥æ²¼ï¼šç§»å‹•å›°é›£ã€‚å›åˆçµæŸæµè¡€4å±¤ã€‚' },
        { id: 81, color: '#bf360c', name: 'ç»ç¥­ä¹‹ç«', effect: 'ç‡ƒç‡’ï¼šé€²å…¥ç²4ç‡ƒç‡’ã€‚Nç¤¾æˆå“¡æ”»æ“ŠDP+6ã€‚' },
        { id: 82, color: '#3e2723', name: 'ç©¿åˆºæ¨', effect: 'åˆ‘å…·ï¼šåœ¨æ­¤è¢«æ“Šä¸­é¡å¤–å—4æ„å¿—å‚·ã€‚' },
        { id: 83, color: '#ffd600', name: 'é‡‘æå…‰è¼', effect: 'æ‰­æ›²ï¼šå›åˆé–‹å§‹å›2æ„å¿—ï¼Œå…¨æŠ€èƒ½åŠ éª°+1ã€‚' }
    ]}
];

let state = { units: [], turnIdx: 0, mapW: 15, mapH: 15, mapData: [], themeId: 0, players: {} };
let myPeerId = null, myRole = 'player', myName = '';
let peer = null;
let connections = {}; // ST holds all player connections: {peerId: conn}
let hostConn = null;  // Player holds connection to ST
let hostId = null;    // Room ID (ST's peer ID)

let currentTool = 'cursor';
let selectedUnitId = null;
let uploadTargetId = null;

// Camera State
let cam = { x: 0, y: 0, scale: 1.0 };
let isDraggingMap = false;
let lastPointer = { x: 0, y: 0 };
let lastDist = 0; // For pinch zoom

// Token Drag State
let isDraggingToken = false;
let draggedUnit = null;
let draggedElement = null;
let dragStartPos = { x: 0, y: 0 };
let tokenStartPos = { x: 0, y: 0 };

// Painting Drag State
let isPaintingDrag = false;

// Session Storage Keys
const STORAGE_KEY = 'limbus_session';

// Persistent player ID (survives reconnections)
let myPlayerId = null;
let myPlayerCode = null; // 4-digit player code

// Connection state
let connectionState = 'disconnected'; // 'disconnected', 'connecting', 'connected'
let heartbeatInterval = null;
let reconnectTimeout = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 10;
const HEARTBEAT_INTERVAL = 5000; // 5 seconds
const RECONNECT_DELAY = 2000; // 2 seconds base delay

/* --- 2. INIT & CONN --- */

// Generate a unique player ID
function generatePlayerId() {
    return 'player_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}

// Generate a 4-digit player code
function generatePlayerCode() {
    return String(Math.floor(1000 + Math.random() * 9000));
}

// Update connection status UI
function setConnectionStatus(status, text = null) {
    connectionState = status;
    const dot = document.getElementById('conn-dot');
    const txt = document.getElementById('conn-text');
    if (!dot || !txt) return;

    dot.className = 'conn-dot';
    switch(status) {
        case 'connected':
            dot.classList.add('online');
            txt.innerText = text || 'å·²é€£ç·š';
            txt.style.color = 'var(--accent-green)';
            break;
        case 'connecting':
            dot.classList.add('connecting');
            txt.innerText = text || 'é€£ç·šä¸­';
            txt.style.color = 'var(--accent-yellow)';
            break;
        case 'disconnected':
        default:
            dot.classList.add('offline');
            txt.innerText = text || 'é›¢ç·š';
            txt.style.color = 'var(--accent-red)';
            break;
    }
}

// Save session to localStorage
function saveSession() {
    const session = {
        name: myName,
        role: myRole,
        hostId: hostId,
        peerId: myPeerId,
        playerId: myPlayerId,
        playerCode: myPlayerCode,
        timestamp: Date.now()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
}

// Load session from localStorage
function loadSession() {
    try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : null;
    } catch { return null; }
}

// Clear session
function clearSession() {
    localStorage.removeItem(STORAGE_KEY);
}

// Start heartbeat for connection health check
function startHeartbeat() {
    stopHeartbeat();
    heartbeatInterval = setInterval(() => {
        if (myRole === 'st') {
            // ST sends heartbeat to all players
            for (const peerId in connections) {
                const conn = connections[peerId];
                if (conn && conn.open) {
                    try {
                        conn.send({ type: 'heartbeat', timestamp: Date.now() });
                    } catch(e) {
                        console.warn('Heartbeat failed for', peerId);
                    }
                }
            }
        } else if (hostConn && hostConn.open) {
            // Player sends heartbeat to ST
            try {
                hostConn.send({ type: 'heartbeat', playerId: myPlayerId, timestamp: Date.now() });
            } catch(e) {
                console.warn('Heartbeat failed');
                handleConnectionLost();
            }
        } else if (connectionState === 'connected') {
            // Connection seems lost
            handleConnectionLost();
        }
    }, HEARTBEAT_INTERVAL);
}

function stopHeartbeat() {
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
}

// Handle connection lost
function handleConnectionLost() {
    if (connectionState === 'disconnected') return;

    setConnectionStatus('disconnected', 'æ–·ç·š');
    showToast('é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...');

    // Try to reconnect
    attemptReconnect();
}

// Attempt to reconnect
function attemptReconnect() {
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
    }

    if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
        showToast('é‡é€£å¤±æ•—ï¼Œè«‹æ‰‹å‹•é‡æ–°é€£ç·š');
        setConnectionStatus('disconnected', 'é‡é€£å¤±æ•—');
        return;
    }

    reconnectAttempts++;
    const delay = RECONNECT_DELAY * Math.min(reconnectAttempts, 5);
    setConnectionStatus('connecting', `é‡é€£ä¸­ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);

    reconnectTimeout = setTimeout(() => {
        if (myRole === 'st') {
            // ST just needs to reconnect the peer
            if (peer && peer.disconnected && !peer.destroyed) {
                peer.reconnect();
            }
        } else if (hostId) {
            // Player needs to reconnect to ST
            if (hostConn) {
                try { hostConn.close(); } catch(e) {}
            }
            connectToHost(hostId);
        }
    }, delay);
}

// Reset reconnection state
function resetReconnectState() {
    reconnectAttempts = 0;
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
    }
}

// Handle page visibility change (for mobile background/foreground)
function setupVisibilityHandler() {
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            // Page became visible - check connection and refresh
            console.log('Page visible, checking connection...');

            if (myRole === 'player' && hostConn) {
                if (!hostConn.open) {
                    // Connection seems closed, try to reconnect
                    handleConnectionLost();
                } else {
                    // Connection seems ok, request state refresh
                    hostConn.send({ type: 'requestState', playerId: myPlayerId });
                }
            }

            // Force re-render to fix any visual glitches
            setTimeout(() => {
                renderAll();
            }, 100);
        } else {
            // Page going to background
            console.log('Page hidden');
        }
    });

    // Also handle page focus/blur for additional reliability
    window.addEventListener('focus', () => {
        setTimeout(() => {
            if (myRole === 'player' && hostConn && hostConn.open) {
                hostConn.send({ type: 'requestState', playerId: myPlayerId });
            }
            renderAll();
        }, 200);
    });
}

// Check for existing session on page load
function checkExistingSession() {
    const session = loadSession();
    if (session && session.name) {
        document.getElementById('input-name').value = session.name;
        if (session.hostId && session.role === 'player') {
            document.getElementById('input-host-id').value = session.hostId;
        }
        if (session.playerCode) {
            document.getElementById('input-player-code').value = session.playerCode;
        }
        // Show reconnect option
        if (session.role === 'st' || session.hostId) {
            showReconnectOption(session);
        }
    }
}

function showReconnectOption(session) {
    const mainBox = document.getElementById('login-main');
    let reconnectDiv = document.getElementById('reconnect-option');
    if (!reconnectDiv) {
        reconnectDiv = document.createElement('div');
        reconnectDiv.id = 'reconnect-option';
        reconnectDiv.style.cssText = 'margin-top:15px;padding:12px;background:rgba(67,160,71,0.1);border:1px solid var(--accent-green);border-radius:8px;';

        const codeDisplay = session.playerCode
            ? `<div style="margin:10px 0;"><div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:4px;">ä½ çš„è­˜åˆ¥ç¢¼ï¼š</div><div class="player-code" onclick="copyPlayerCode('${session.playerCode}')">${session.playerCode}</div><div style="font-size:0.65rem;color:var(--text-dim);">é»æ“Šè¤‡è£½ï¼Œç”¨æ–¼è·¨è£ç½®é‡é€£</div></div>`
            : '';

        reconnectDiv.innerHTML = `
            <div style="color:var(--accent-green);font-size:0.9rem;margin-bottom:8px;">ğŸ”„ åµæ¸¬åˆ°ä¸Šæ¬¡é€£ç·š</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-bottom:8px;">
                ${session.role === 'st' ? 'èº«ä»½: ST (æˆ¿ä¸»)' : 'æˆ¿é–“: ' + (session.hostId || '').substring(0,8) + '...'}
            </div>
            ${codeDisplay}
            <button class="login-btn" style="background:var(--accent-green);padding:10px;" onclick="reconnectSession()">å¿«é€Ÿé‡é€£</button>
            <button class="login-btn btn-back" style="padding:8px;margin-top:6px;" onclick="clearSessionAndRefresh()">æ¸…é™¤ä¸¦é‡æ–°é–‹å§‹</button>
        `;
        mainBox.appendChild(reconnectDiv);
    }
}

function copyPlayerCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showToast('è­˜åˆ¥ç¢¼å·²è¤‡è£½: ' + code);
    });
}

function clearSessionAndRefresh() {
    clearSession();
    location.reload();
}

function reconnectSession() {
    const session = loadSession();
    if (!session) return showToast('ç„¡æ³•è®€å–é€£ç·šè³‡æ–™');

    document.getElementById('input-name').value = session.name;
    if (session.role === 'st') {
        initSystem('st', session.peerId);
    } else if (session.hostId) {
        document.getElementById('input-host-id').value = session.hostId;
        initSystem('player');
    }
}

function initSystem(role, savedPeerId = null) {
    const name = document.getElementById('input-name').value.trim();
    if (!name) return showToast('è«‹è¼¸å…¥ä»£è™Ÿ');

    myName = name;
    myRole = role;

    // Initialize or restore player ID and code
    const session = loadSession();
    let inputCode = null;

    if (role === 'st') {
        inputCode = document.getElementById('input-st-code')?.value?.trim();
    } else {
        inputCode = document.getElementById('input-player-code')?.value?.trim();
    }

    if (inputCode && inputCode.length === 4) {
        // User entered a code - use it to restore identity
        myPlayerCode = inputCode;
        myPlayerId = 'code_' + inputCode;
    } else if (session && session.playerId) {
        myPlayerId = session.playerId;
        myPlayerCode = session.playerCode || generatePlayerCode();
    } else {
        myPlayerId = generatePlayerId();
        myPlayerCode = generatePlayerCode();
    }

    document.getElementById('login-main').classList.add('hidden');
    document.getElementById('login-join').classList.add('hidden');
    document.getElementById('login-st').classList.add('hidden');
    document.getElementById('login-loading').classList.remove('hidden');

    setConnectionStatus('connecting', 'å»ºç«‹é€£ç·šä¸­...');
    document.getElementById('loading-status').innerText = 'æ­£åœ¨é€£æ¥ä¼ºæœå™¨...';

    // Create peer with optional saved ID for ST reconnection
    const peerOptions = {};
    if (role === 'st' && savedPeerId) {
        // Try to use the same ID for ST reconnection
        peer = new Peer(savedPeerId, peerOptions);
    } else {
        peer = new Peer(peerOptions);
    }

    peer.on('open', id => {
        myPeerId = id;

        if (role === 'st') {
            hostId = id; // ST's own ID is the room ID
            setConnectionStatus('connected', 'ST å·²å°±ç·’');
        }

        document.getElementById('my-id').innerText = id;
        document.getElementById('login-layer').classList.add('hidden');

        // Save session
        saveSession();

        // Show player code in navbar
        updateCodeDisplay();

        // Setup visibility handler for mobile
        setupVisibilityHandler();

        if (role === 'st') {
            document.getElementById('st-map-controls').style.display = 'flex';
            document.getElementById('units-toolbar').style.display = 'flex';
            document.getElementById('tile-info-panel').style.display = 'block';

            // Initialize map if new session
            if (!state.mapData || state.mapData.length === 0) {
                initMapData();
            }
            updateToolbar();
            renderAll();

            // Start heartbeat for ST
            startHeartbeat();

            // Show player code for ST
            showToast(`æˆ¿é–“å·²å»ºç«‹ï¼ä½ çš„è­˜åˆ¥ç¢¼ï¼š${myPlayerCode}`);
        } else {
            // Show player toolbar (for adding their own units)
            document.getElementById('st-map-controls').style.display = 'none';
            document.getElementById('units-toolbar').style.display = 'flex';

            const inputHostId = document.getElementById('input-host-id').value.trim();
            if (inputHostId) {
                hostId = inputHostId;
                saveSession();
                connectToHost(inputHostId);
            }
        }
        initCameraEvents();
    });

    peer.on('connection', c => {
        handleNewConnection(c);
    });

    peer.on('error', err => {
        console.error('Peer error:', err);
        if (err.type === 'unavailable-id') {
            // ID already taken, generate new one for ST
            showToast('æˆ¿é–“IDå·²è¢«ä½”ç”¨ï¼Œç”¢ç”Ÿæ–°ID...');
            peer = new Peer();
            peer.on('open', id => {
                myPeerId = id;
                hostId = id;
                document.getElementById('my-id').innerText = id;
                document.getElementById('login-layer').classList.add('hidden');
                saveSession();
                initMapData();
                updateToolbar();
                renderAll();
                initCameraEvents();
            });
            peer.on('connection', c => handleNewConnection(c));
        } else {
            showToast('é€£ç·šéŒ¯èª¤: ' + err.type);
            document.getElementById('login-layer').classList.remove('hidden');
            document.getElementById('login-loading').classList.add('hidden');
        }
    });

    peer.on('disconnected', () => {
        showToast('èˆ‡ä¼ºæœå™¨æ–·ç·šï¼Œå˜—è©¦é‡é€£...');
        setTimeout(() => {
            if (peer && !peer.destroyed) {
                peer.reconnect();
            }
        }, 2000);
    });
}

function showSTStep() {
    document.getElementById('login-main').classList.add('hidden');
    document.getElementById('login-st').classList.remove('hidden');

    // Pre-fill ST code if available
    const session = loadSession();
    if (session && session.playerCode && session.role === 'st') {
        document.getElementById('input-st-code').value = session.playerCode;
    }
}

function showJoinStep() {
    document.getElementById('login-main').classList.add('hidden');
    document.getElementById('login-join').classList.remove('hidden');

    // Pre-fill host ID if available
    const session = loadSession();
    if (session && session.hostId) {
        document.getElementById('input-host-id').value = session.hostId;
    }
    if (session && session.playerCode && session.role === 'player') {
        document.getElementById('input-player-code').value = session.playerCode;
    }
}

function showMainStep() {
    document.getElementById('login-join').classList.add('hidden');
    document.getElementById('login-st').classList.add('hidden');
    document.getElementById('login-main').classList.remove('hidden');
}

function connectToHost(targetHostId) {
    if (!targetHostId) return;
    hostId = targetHostId;

    setConnectionStatus('connecting', 'é€£æ¥æˆ¿é–“ä¸­...');
    document.getElementById('loading-status').innerText = 'æ­£åœ¨é€£æ¥æˆ¿é–“...';

    hostConn = peer.connect(targetHostId, { reliable: true });

    hostConn.on('open', () => {
        setConnectionStatus('connected');
        resetReconnectState();
        showToast(`å·²é€£æ¥ï¼ä½ çš„è­˜åˆ¥ç¢¼ï¼š${myPlayerCode}`);

        // Send join message with player info (use persistent playerId for ownership)
        hostConn.send({
            type: 'join',
            peerId: myPeerId,
            playerId: myPlayerId,
            playerCode: myPlayerCode,
            playerName: myName
        });
        saveSession();

        // Start heartbeat for player
        startHeartbeat();
    });

    hostConn.on('data', data => {
        handlePlayerMessage(data);
    });

    hostConn.on('close', () => {
        console.log('Connection to host closed');
        hostConn = null;
        handleConnectionLost();
    });

    hostConn.on('error', err => {
        console.error('Connection error:', err);
        setConnectionStatus('disconnected', 'é€£ç·šéŒ¯èª¤');
        showToast('é€£ç·šéŒ¯èª¤: ' + err.type);

        // Try to reconnect
        setTimeout(() => attemptReconnect(), RECONNECT_DELAY);
    });
}

// ST handles new player connections
function handleNewConnection(conn) {
    const playerId = conn.peer;
    connections[playerId] = conn;

    conn.on('open', () => {
        console.log('Player connected:', playerId);
    });

    conn.on('data', data => {
        handleSTMessage(conn, data);
    });

    conn.on('close', () => {
        console.log('Player disconnected:', playerId);
        delete connections[playerId];
        // Optionally mark player as offline in state
        if (state.players[playerId]) {
            state.players[playerId].online = false;
            broadcastState();
        }
    });
}

// ST receives messages from players
function handleSTMessage(conn, data) {
    const peerId = conn.peer;
    // Use persistent playerId for ownership (falls back to peerId for backwards compatibility)
    const playerId = data.playerId || peerId;

    switch (data.type) {
        case 'heartbeat':
            // Respond to heartbeat
            if (conn.open) {
                conn.send({ type: 'heartbeat-ack', timestamp: Date.now() });
            }
            // Update player's peerId in case it changed (reconnection)
            if (state.players[playerId] && state.players[playerId].peerId !== peerId) {
                state.players[playerId].peerId = peerId;
                // Update connections map
                delete connections[state.players[playerId].peerId];
                connections[peerId] = conn;
            }
            break;

        case 'requestState':
            // Player requests fresh state (after visibility change)
            if (conn.open) {
                conn.send({ type: 'state', payload: state });
            }
            break;

        case 'join':
            // Register player with their persistent playerId
            state.players[playerId] = {
                id: playerId,
                peerId: peerId,
                code: data.playerCode,
                name: data.playerName,
                online: true
            };
            showToast(`${data.playerName} åŠ å…¥äº†æˆ¿é–“ (${data.playerCode || ''})`);
            broadcastState();
            break;

        case 'addUnit':
            // Player adds their own unit
            const unit = createUnit(data.name, data.hp, data.unitType);
            unit.ownerId = playerId;
            unit.ownerName = state.players[playerId]?.name || data.playerName;
            state.units.push(unit);
            broadcastState();
            break;

        case 'moveUnit':
            // Player moves their own unit
            const u = state.units.find(u => u.id === data.unitId);
            if (u && u.ownerId === playerId) {
                u.x = data.x;
                u.y = data.y;
                broadcastState();
            }
            break;

        case 'modifyHP':
            // Player modifies their own unit's HP
            const unit2 = state.units.find(u => u.id === data.unitId);
            if (unit2 && unit2.ownerId === playerId) {
                modifyHPInternal(unit2, data.dmgType, data.amount);
                broadcastState();
            }
            break;

        case 'deleteUnit':
            // Player deletes their own unit
            const idx = state.units.findIndex(u => u.id === data.unitId && u.ownerId === playerId);
            if (idx !== -1) {
                state.units.splice(idx, 1);
                broadcastState();
            }
            break;

        case 'updateInit':
            // Player updates their unit's initiative
            const unit3 = state.units.find(u => u.id === data.unitId);
            if (unit3 && unit3.ownerId === playerId) {
                unit3.init = data.init;
                broadcastState();
            }
            break;

        case 'uploadAvatar':
            // Player uploads avatar for their own unit
            const unit4 = state.units.find(u => u.id === data.unitId);
            if (unit4 && unit4.ownerId === playerId) {
                unit4.avatar = data.avatar;
                broadcastState();
            }
            break;
    }
}

// Player receives messages from ST
function handlePlayerMessage(data) {
    switch (data.type) {
        case 'state':
            state = data.payload;
            setConnectionStatus('connected');
            renderAll();
            break;

        case 'heartbeat':
            // ST sent a heartbeat, respond with ack
            if (hostConn && hostConn.open) {
                hostConn.send({ type: 'heartbeat-ack', playerId: myPlayerId, timestamp: Date.now() });
            }
            setConnectionStatus('connected');
            break;

        case 'heartbeat-ack':
            // ST acknowledged our heartbeat - connection is healthy
            setConnectionStatus('connected');
            resetReconnectState();
            break;
    }
}

// ST broadcasts state to all connected players
function broadcastState() {
    const message = { type: 'state', payload: state };
    for (const playerId in connections) {
        const conn = connections[playerId];
        if (conn && conn.open) {
            conn.send(message);
        }
    }
    renderAll();
}

// Send action to ST (for players)
function sendToHost(message) {
    if (hostConn && hostConn.open) {
        hostConn.send(message);
    }
}

// Legacy function for compatibility
function sendState() {
    if (myRole === 'st') {
        broadcastState();
    }
}

/* --- 3. CAMERA LOGIC (PAN & ZOOM) --- */
function initCameraEvents() {
    const vp = document.getElementById('map-viewport');

    // Wheel Zoom
    vp.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoomCamera(delta);
    }, { passive: false });

    // Pointer Events (Mouse & Touch) - Map Panning
    vp.addEventListener('pointerdown', e => {
        // Don't start map drag if clicking on a token (handled separately)
        if (isDraggingToken || e.target.classList.contains('token')) return;

        // Don't start map drag if using a paint tool on a cell
        if (currentTool !== 'cursor' && e.target.classList.contains('cell')) {
            isPaintingDrag = true;
            return;
        }

        isDraggingMap = true;
        lastPointer = { x: e.clientX, y: e.clientY };
        vp.setPointerCapture(e.pointerId);
    });

    vp.addEventListener('pointermove', e => {
        // Handle token dragging
        if (isDraggingToken && draggedElement) {
            e.preventDefault();
            handleTokenDragMove(e);
            return;
        }

        // Handle painting drag - cell events handle the actual painting
        if (isPaintingDrag) {
            return;
        }

        // Handle map panning
        if (!isDraggingMap) return;
        e.preventDefault();
        const dx = e.clientX - lastPointer.x;
        const dy = e.clientY - lastPointer.y;

        cam.x += dx;
        cam.y += dy;
        lastPointer = { x: e.clientX, y: e.clientY };
        applyCamera();
    });

    vp.addEventListener('pointerup', e => {
        // Handle token drop
        if (isDraggingToken) {
            endTokenDrag(e);
            return;
        }

        // Handle painting drag end
        if (isPaintingDrag) {
            isPaintingDrag = false;
            if (myRole === 'st') sendState();
            return;
        }

        // Handle map pan end
        if (isDraggingMap) {
            isDraggingMap = false;
            vp.releasePointerCapture(e.pointerId);
        }
    });

    vp.addEventListener('pointercancel', e => {
        if (isDraggingToken) {
            cancelTokenDrag();
        }
        isDraggingMap = false;
        isPaintingDrag = false;
    });

    // Touch Pinch (Simple)
    vp.addEventListener('touchmove', e => {
        if(e.touches.length === 2 && !isDraggingToken) {
            e.preventDefault();
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            if(lastDist) {
                const diff = dist - lastDist;
                zoomCamera(diff * 0.005);
            }
            lastDist = dist;
        }
    }, { passive: false });

    vp.addEventListener('touchend', () => { lastDist = 0; });
}

function zoomCamera(amount) {
    cam.scale = Math.max(0.5, Math.min(3.0, cam.scale + amount));
    applyCamera();
}

function applyCamera() {
    const con = document.getElementById('map-container');
    con.style.transform = `translate(${cam.x}px, ${cam.y}px) scale(${cam.scale})`;
}

function resetCamera() {
    cam = { x: 0, y: 0, scale: 1.0 };
    applyCamera();
}

/* --- 3.5 TOKEN DRAG LOGIC --- */
function startTokenDrag(e, unit, element) {
    isDraggingToken = true;
    draggedUnit = unit;
    draggedElement = element;
    dragStartPos = { x: e.clientX, y: e.clientY };

    const gridSize = 50;
    tokenStartPos = {
        x: unit.x * gridSize + 2,
        y: unit.y * gridSize + 2
    };

    element.classList.add('dragging');
    element.setPointerCapture(e.pointerId);
    selectUnit(unit.id);
}

function handleTokenDragMove(e) {
    if (!isDraggingToken || !draggedElement) return;

    const dx = (e.clientX - dragStartPos.x) / cam.scale;
    const dy = (e.clientY - dragStartPos.y) / cam.scale;

    draggedElement.style.left = (tokenStartPos.x + dx) + 'px';
    draggedElement.style.top = (tokenStartPos.y + dy) + 'px';
}

function endTokenDrag(e) {
    if (!isDraggingToken || !draggedUnit) {
        cancelTokenDrag();
        return;
    }

    // Calculate which cell we dropped on
    const gridSize = 50;
    const dx = (e.clientX - dragStartPos.x) / cam.scale;
    const dy = (e.clientY - dragStartPos.y) / cam.scale;

    const newPixelX = tokenStartPos.x + dx;
    const newPixelY = tokenStartPos.y + dy;

    // Convert to grid coordinates
    let newX = Math.round(newPixelX / gridSize);
    let newY = Math.round(newPixelY / gridSize);

    // Clamp to map bounds
    newX = Math.max(0, Math.min(state.mapW - 1, newX));
    newY = Math.max(0, Math.min(state.mapH - 1, newY));

    // Update unit position based on role
    if (myRole === 'st') {
        draggedUnit.x = newX;
        draggedUnit.y = newY;
        sendState();
    } else {
        // Player sends move request to ST
        sendToHost({
            type: 'moveUnit',
            playerId: myPlayerId,
            unitId: draggedUnit.id,
            x: newX,
            y: newY
        });
    }

    // Cleanup
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        try { draggedElement.releasePointerCapture(e.pointerId); } catch(err) {}
    }

    isDraggingToken = false;
    draggedUnit = null;
    draggedElement = null;

    // Clear selection after drag move
    selectedUnitId = null;

    renderAll();
}

function cancelTokenDrag() {
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        // Reset position
        const gridSize = 50;
        if (draggedUnit) {
            draggedElement.style.left = (draggedUnit.x * gridSize + 2) + 'px';
            draggedElement.style.top = (draggedUnit.y * gridSize + 2) + 'px';
        }
    }

    isDraggingToken = false;
    draggedUnit = null;
    draggedElement = null;
}

/* --- 4. MAP LOGIC --- */
function initMapData() {
    state.mapData = Array(state.mapH).fill().map(() => Array(state.mapW).fill(0));
}

function changeMapTheme(id) {
    if(myRole !== 'st') return;
    state.themeId = parseInt(id);
    updateToolbar();
    sendState(); renderAll();
}

function updateToolbar() {
    const container = document.getElementById('dynamic-tools');
    const staticTools = container.querySelectorAll('[data-tool="cursor"], [data-tool="floor"]');
    container.innerHTML = '';
    staticTools.forEach(t => container.appendChild(t));

    const theme = MAP_PRESETS[state.themeId] || MAP_PRESETS[0];
    theme.tiles.forEach(tile => {
        if(tile.name === 'åœ°æ¿') return;
        const btn = document.createElement('button');
        btn.className = 'tool-btn';
        btn.dataset.tool = tile.id;
        btn.title = tile.name;
        btn.onclick = () => setTool(tile.id);
        
        const dot = document.createElement('div');
        dot.className = 'color-indicator';
        dot.style.backgroundColor = tile.color;
        
        btn.innerText = tile.name.substring(0, 1);
        btn.appendChild(dot);
        container.appendChild(btn);
    });
}

function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`.tool-btn[data-tool="${tool}"]`);
    if(btn) btn.classList.add('active');

    if(myRole === 'st') {
        const info = document.getElementById('tile-effect-desc');
        const theme = MAP_PRESETS[state.themeId];
        let desc = "";
        if (tool === 'floor') desc = "æ¸…é™¤æ ¼å­";
        else if (tool === 'cursor') desc = "é¸æ“‡å–®ä½ / æŸ¥çœ‹æ ¼å­";
        else {
            const t = theme.tiles.find(x => x.id == tool);
            if(t) desc = `${t.name}: ${t.effect}`;
        }
        info.innerText = desc;
    }
}

function resizeMap() {
    const w = parseInt(document.getElementById('map-w').value);
    const h = parseInt(document.getElementById('map-h').value);
    if(w < 5 || h < 5 || w > 50 || h > 50) return showToast('å°ºå¯¸ 5~50');
    
    const newData = Array(h).fill().map(() => Array(w).fill(0));
    for(let y=0; y<Math.min(h, state.mapH); y++) {
        for(let x=0; x<Math.min(w, state.mapW); x++) {
            newData[y][x] = state.mapData[y][x];
        }
    }
    state.mapW = w; state.mapH = h; state.mapData = newData;
    sendState(); renderAll();
}

/* --- 5. RENDER SYSTEM --- */
function renderAll() {
    renderMap();
    renderUnitsList();
    renderSidebarUnits();
    renderUnitsToolbar();
}

function renderUnitsToolbar() {
    const toolbar = document.getElementById('units-toolbar');
    if (!toolbar) return;

    if (myRole === 'st') {
        toolbar.innerHTML = `
            <button class="units-btn primary" onclick="nextTurn()">â–¶ ä¸‹ä¸€å›åˆ</button>
            <button class="units-btn" onclick="openAddUnitModal()">+ æ–°å¢</button>
            <button class="units-btn" onclick="openBatchModal()">ğŸ“‹ æ‰¹é‡</button>
            <button class="units-btn" onclick="sortByInit()">â± æ’åº</button>
        `;
    } else {
        // Players can only add their own units
        toolbar.innerHTML = `
            <button class="units-btn" onclick="openAddUnitModal()">+ æ–°å¢æˆ‘çš„å–®ä½</button>
            <span style="color:var(--text-dim);font-size:0.8rem;padding:8px;">å›åˆæ§åˆ¶ç”± ST æ“ä½œ</span>
        `;
    }
}

function renderMap() {
    const grid = document.getElementById('battle-map');
    grid.style.gridTemplateColumns = `repeat(${state.mapW}, var(--grid-size))`;
    grid.innerHTML = '';
    
    // Set container size for centering
    const pxW = state.mapW * 50; // 50 is grid size var
    const pxH = state.mapH * 50;
    grid.style.width = pxW + 'px';
    grid.style.height = pxH + 'px';
    // Center logic handled by map-container flex/pos usually, but here transform is used.
    document.getElementById('map-container').style.width = pxW + 'px';
    document.getElementById('map-container').style.height = pxH + 'px';
    document.getElementById('map-container').style.marginLeft = `-${pxW/2}px`;
    document.getElementById('map-container').style.marginTop = `-${pxH/2}px`;

    const theme = MAP_PRESETS[state.themeId] || MAP_PRESETS[0];

    for(let y=0; y<state.mapH; y++) {
        for(let x=0; x<state.mapW; x++) {
            const val = state.mapData[y][x];
            const div = document.createElement('div');
            div.className = 'cell';
            
            // Deployment Highlight Logic - show for units user can control
            if (currentTool === 'cursor' && selectedUnitId !== null) {
               const u = state.units.find(u => u.id === selectedUnitId);
               if(u && u.x === -1 && canControlUnit(u)) {
                   div.classList.add('deploy-target');
               }
            }

            let tileDef = theme.tiles.find(t => t.id === val);
            // Fallback for old saves
            if (!tileDef && state.themeId === 0) {
                 if(val === 1) tileDef = theme.tiles.find(t=>t.name==='ç‰†å£');
                 else if(val === 2) tileDef = theme.tiles.find(t=>t.name==='æ©é«”');
                 else if(val === 3) tileDef = theme.tiles.find(t=>t.name==='éšªåœ°');
            }

            if (tileDef) {
                div.style.backgroundColor = tileDef.color;
                if(tileDef.name.includes('ç‰†') || tileDef.name.includes('æ©é«”')) {
                    div.style.backgroundImage = 'repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(0,0,0,0.2) 4px,rgba(0,0,0,0.2) 8px)';
                }
            }

            // Interactions
            div.onpointerdown = (e) => {
                if(isDraggingMap || isDraggingToken) return;
                // Stop propagation for cursor tool when deploying (prevents camera pan)
                if(currentTool === 'cursor' && selectedUnitId !== null) {
                    const u = state.units.find(u => u.id === selectedUnitId);
                    if(u && canControlUnit(u)) {
                        e.stopPropagation();
                    }
                }
                handleMapInput(x, y, e);
            };
            // Allow painting while dragging (when isPaintingDrag is true or buttons pressed)
            div.onpointerenter = (e) => {
                if(e.buttons === 1 && !isDraggingMap && !isDraggingToken) {
                    handleMapInput(x, y, e);
                }
            };
            
            grid.appendChild(div);
        }
    }
    
    // Tokens
    const gridSize = 50; // matches CSS --grid-size
    state.units.filter(u => u.x >= 0).forEach(u => {
        const t = document.createElement('div');
        t.className = `token ${u.type} ${u.id === selectedUnitId ? 'selected' : ''}`;
        t.dataset.unitId = u.id;

        // Correct positioning within grid (2px offset to center the 46px token in 50px cell)
        t.style.left = (u.x * gridSize + 2) + 'px';
        t.style.top = (u.y * gridSize + 2) + 'px';

        if(u.avatar) t.style.backgroundImage = `url(${u.avatar})`;
        else t.innerText = u.name[0].toUpperCase();

        // Token pointer events - click to select, drag to move
        let pointerDownTime = 0;
        let pointerDownPos = { x: 0, y: 0 };
        const DRAG_THRESHOLD = 5; // pixels to consider as drag

        t.onpointerdown = (e) => {
            if(currentTool !== 'cursor') return;
            e.stopPropagation();
            e.preventDefault();

            pointerDownTime = Date.now();
            pointerDownPos = { x: e.clientX, y: e.clientY };

            // Always select the unit first
            selectUnit(u.id);

            // Set up for potential drag
            if (canControlUnit(u)) {
                t.setPointerCapture(e.pointerId);
            }
        };

        t.onpointermove = (e) => {
            if (!canControlUnit(u)) return;
            if (pointerDownTime === 0) return;

            const dx = Math.abs(e.clientX - pointerDownPos.x);
            const dy = Math.abs(e.clientY - pointerDownPos.y);

            // If moved beyond threshold, start dragging
            if ((dx > DRAG_THRESHOLD || dy > DRAG_THRESHOLD) && !isDraggingToken) {
                startTokenDrag(e, u, t);
                // Adjust drag start position to original pointer down position
                dragStartPos = { x: pointerDownPos.x, y: pointerDownPos.y };
            } else if (isDraggingToken) {
                handleTokenDragMove(e);
            }
        };

        t.onpointerup = (e) => {
            if (isDraggingToken) {
                endTokenDrag(e);
            } else {
                // Just a click - unit is already selected, clicking on cell will move it
                try { t.releasePointerCapture(e.pointerId); } catch(err) {}
            }
            pointerDownTime = 0;
        };

        t.onpointercancel = (e) => {
            if (isDraggingToken) {
                cancelTokenDrag();
            }
            pointerDownTime = 0;
            try { t.releasePointerCapture(e.pointerId); } catch(err) {}
        };

        grid.appendChild(t);
    });
}

function handleMapInput(x, y, e) {
    if (currentTool === 'cursor') {
        if(selectedUnitId !== null) {
            const u = state.units.find(u => u.id === selectedUnitId);
            if(u && canControlUnit(u)) {
                if (myRole === 'st') {
                    u.x = x; u.y = y;
                    selectedUnitId = null;
                    sendState();
                    renderAll();
                } else {
                    // Player sends move request to ST
                    sendToHost({
                        type: 'moveUnit',
                        playerId: myPlayerId,
                        unitId: u.id,
                        x: x,
                        y: y
                    });
                    selectedUnitId = null;
                    renderAll();
                }
            }
        }
        return;
    }
    if (myRole !== 'st') return;

    let newVal = (currentTool === 'floor') ? 0 : parseInt(currentTool);
    if (state.mapData[y][x] !== newVal) {
        state.mapData[y][x] = newVal;

        // During painting drag, only update the cell visually without full re-render
        if (isPaintingDrag && e && e.target && e.target.classList.contains('cell')) {
            const theme = MAP_PRESETS[state.themeId] || MAP_PRESETS[0];
            const tileDef = theme.tiles.find(t => t.id === newVal);
            if (tileDef) {
                e.target.style.backgroundColor = tileDef.color;
                if(tileDef.name.includes('ç‰†') || tileDef.name.includes('æ©é«”')) {
                    e.target.style.backgroundImage = 'repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(0,0,0,0.2) 4px,rgba(0,0,0,0.2) 8px)';
                } else {
                    e.target.style.backgroundImage = '';
                }
            } else {
                // Floor / clear
                e.target.style.backgroundColor = '';
                e.target.style.backgroundImage = '';
            }
        } else {
            renderAll();
        }
    }
}

/* --- 6. UNITS LOGIC --- */
function renderUnitsList() {
    const list = document.getElementById('units-list');
    if (!list) return;

    list.innerHTML = state.units.map((u, idx) => {
        const isTurn = idx === state.turnIdx;
        const a = u.hpArr.filter(x => x === 3).length;
        const l = u.hpArr.filter(x => x === 2).length;
        const b = u.hpArr.filter(x => x === 1).length;
        const empty = u.maxHp - a - l - b;

        const isEnemy = u.type === 'enemy';
        const isSt = myRole === 'st';
        const canControl = canControlUnit(u);
        const isMyUnit = u.ownerId === myPlayerId;
        const hideDetails = isEnemy && !isSt && !isMyUnit;

        let statusText = `${empty}å®Œå¥½ / ${b}B / ${l}L / ${a}A`;
        if (hideDetails) statusText = `ç‹€æ…‹: ${getVagueStatus(u)}`;

        // Owner indicator
        let ownerTag = '';
        if (u.ownerName) {
            const ownerColor = isMyUnit ? 'var(--accent-green)' : 'var(--text-dim)';
            ownerTag = `<span style="font-size:0.65rem;color:${ownerColor};margin-left:6px;">[${escapeHtml(u.ownerName)}]</span>`;
        }

        const bar = u.hpArr.map(h => {
            let cls = 'hp-empty';
            if (h === 1) cls = 'hp-b';
            if (h === 2) cls = 'hp-l';
            if (h === 3) cls = 'hp-a';
            return `<div class="hp-chunk ${cls}" style="width:${100/u.maxHp}%"></div>`;
        }).join('');

        const deployBtn = u.x >= 0
            ? `<button class="action-btn" onclick="recallUnit(${u.id})">ğŸ“æ”¶å›</button>`
            : `<button class="action-btn" onclick="startDeploy(${u.id})">ğŸ“éƒ¨ç½²</button>`;

        // Show actions for users who can control this unit
        let actions = '';
        if (canControl) {
            actions = `
                <div class="unit-actions">
                    <button class="action-btn dmg-b" onclick="modifyHP(${u.id},'b',1)" title="æŒ‰ä½Shifté–‹å•Ÿæ•¸é‡è¼¸å…¥">+B</button>
                    <button class="action-btn dmg-l" onclick="modifyHP(${u.id},'l',1)" title="æŒ‰ä½Shifté–‹å•Ÿæ•¸é‡è¼¸å…¥">+L</button>
                    <button class="action-btn dmg-a" onclick="modifyHP(${u.id},'a',1)" title="æŒ‰ä½Shifté–‹å•Ÿæ•¸é‡è¼¸å…¥">+A</button>
                    <button class="action-btn" onclick="openHpModal(${u.id},'damage')" title="é–‹å•Ÿå‚·å®³é¢æ¿">âš”</button>
                    <button class="action-btn heal" onclick="openHpModal(${u.id},'heal')" title="é–‹å•Ÿæ²»ç™‚é¢æ¿ (å¯é¸æ“‡ B/L/A)">æ²»ç™‚</button>
                    ${deployBtn}
                    <button class="action-btn" onclick="deleteUnit(${u.id})">âœ•</button>
                </div>
            `;
        }

        const avaStyle = u.avatar ? `background-image:url(${u.avatar});color:transparent;` : '';
        const initInput = `<input type="number" class="unit-init" value="${u.init}" onchange="updateInit(${u.id},this.value)" ${!canControl?'readonly':''} style="width:50px;text-align:center;">`;

        // Highlight user's own unit with a subtle border
        const myUnitStyle = isMyUnit ? 'border-left-width:6px;' : '';

        return `
            <div class="unit-card ${u.type} ${isTurn ? 'active-turn' : ''}" style="${myUnitStyle}">
                <div class="unit-header">
                    <div class="unit-avatar ${u.type}" style="${avaStyle}" onclick="uploadAvatar(${u.id})">${u.avatar?'':u.name[0]}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${escapeHtml(u.name)}${ownerTag}</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">${statusText}</div>
                    </div>
                    ${initInput}
                </div>
                <div class="hp-bar-wrap">${bar}</div>
                ${actions}
            </div>
        `;
    }).join('');
}

function renderSidebarUnits() {
    const c = document.getElementById('sidebar-units');
    if(!c) return;
    if(state.units.length === 0) { c.innerHTML = '<div style="padding:10px;text-align:center;color:#555;">ç„¡å–®ä½</div>'; return; }
    
    c.innerHTML = state.units.map((u, idx) => {
        const isTurn = idx === state.turnIdx;
        const isEnemy = u.type === 'enemy';
        const isSt = myRole === 'st';
        
        const bar = `<div class="hp-bar-wrap" style="height:6px;margin-top:4px;">` + 
            u.hpArr.map(h => `<div class="hp-chunk ${h===0?'hp-empty':h===1?'hp-b':h===2?'hp-l':'hp-a'}" style="width:${100/u.maxHp}%"></div>`).join('') + 
            `</div>`;

        let statusTxt = isEnemy && !isSt ? getVagueStatus(u) : 
            `${u.hpArr.filter(x=>x===3).length}A ${u.hpArr.filter(x=>x===2).length}L`;

        return `
            <div class="unit-card ${u.type} ${isTurn?'active-turn':''}" style="padding:8px;margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;">
                    <span style="font-weight:bold;font-size:0.9rem;">${escapeHtml(u.name)}</span>
                    <span style="color:var(--accent-yellow);font-family:'JetBrains Mono';">${u.init}</span>
                </div>
                <div style="font-size:0.75rem;color:#777;">${statusTxt}</div>
                ${bar}
            </div>
        `;
    }).join('');
}

function getVagueStatus(u) {
    const dmg = u.hpArr.filter(x => x > 0).length;
    const ratio = dmg / u.maxHp;
    if(ratio === 0) return "å®Œå¥½";
    if(ratio < 0.3) return "è¼•å‚·";
    if(ratio < 0.6) return "å—å‚·";
    if(ratio < 0.9) return "é‡å‚·";
    return "ç€•æ­»";
}

/* --- 7. ACTIONS --- */
function openAddUnitModal() { document.getElementById('modal-add-unit').classList.add('show'); }
function openBatchModal() { document.getElementById('modal-batch').classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function confirmAddUnit() {
    const name = document.getElementById('add-name').value || 'Unit';
    const hp = parseInt(document.getElementById('add-hp').value) || 10;
    const type = document.getElementById('add-type').value;
    const useAvatar = document.getElementById('add-avatar').checked;

    if (myRole === 'st') {
        // ST creates unit directly
        const u = createUnit(name, hp, type, myPeerId, myName);
        if(useAvatar) { uploadTargetId = u.id; document.getElementById('file-upload').click(); }
        state.units.push(u);
        closeModal('modal-add-unit');
        sendState();
        renderAll();
    } else {
        // Player sends request to ST
        sendToHost({
            type: 'addUnit',
            playerId: myPlayerId,
            name: name,
            hp: hp,
            unitType: type,
            playerName: myName
        });
        closeModal('modal-add-unit');
        showToast('å·²è«‹æ±‚æ–°å¢å–®ä½');
    }
}

function confirmBatchAdd() {
    if (myRole !== 'st') {
        showToast('åªæœ‰ ST å¯ä»¥æ‰¹é‡æ–°å¢');
        return;
    }

    const pre = document.getElementById('batch-prefix').value || 'Unit';
    const start = parseInt(document.getElementById('batch-start').value) || 1;
    const count = parseInt(document.getElementById('batch-count').value) || 5;
    const hp = parseInt(document.getElementById('batch-hp').value) || 10;
    const type = document.getElementById('batch-type').value;

    for(let i=0; i<count; i++) {
        state.units.push(createUnit(`${pre}${start+i}`, hp, type, myPeerId, myName));
    }
    closeModal('modal-batch');
    sendState();
    renderAll();
}

function createUnit(name, hp, type, ownerId = null, ownerName = null) {
    return {
        id: Date.now()+Math.random(),
        name,
        maxHp: hp,
        hpArr: Array(hp).fill(0),
        type,
        init: 0,
        x: -1,
        y: -1,
        avatar: null,
        ownerId: ownerId,
        ownerName: ownerName
    };
}

// Check if current user can control a unit
function canControlUnit(unit) {
    if (myRole === 'st') return true;
    return unit.ownerId === myPlayerId;
}

// Internal HP modification (used by both ST and message handler)
// type can be: 'b', 'l', 'a' (damage), 'heal' (heal any), 'heal-b', 'heal-l', 'heal-a' (heal specific)
function modifyHPInternal(unit, type, amount) {
    for(let i=0; i<amount; i++) {
        if (type === 'heal') {
            // Heal any damage (prioritize A > L > B)
            const idx = unit.hpArr.findIndex(x => x > 0);
            if(idx !== -1) unit.hpArr[idx] = 0;
        } else if (type === 'heal-a') {
            // Only heal A damage
            const idx = unit.hpArr.findIndex(x => x === 3);
            if(idx !== -1) unit.hpArr[idx] = 0;
        } else if (type === 'heal-l') {
            // Only heal L damage
            const idx = unit.hpArr.findIndex(x => x === 2);
            if(idx !== -1) unit.hpArr[idx] = 0;
        } else if (type === 'heal-b') {
            // Only heal B damage
            const idx = unit.hpArr.findIndex(x => x === 1);
            if(idx !== -1) unit.hpArr[idx] = 0;
        } else {
            // Apply damage
            const val = type==='b'?1:type==='l'?2:3;
            const eIdx = unit.hpArr.findIndex(x => x === 0);
            if(eIdx !== -1) unit.hpArr[eIdx] = val;
            else {
                // Upgrade existing damage
                const bIdx = unit.hpArr.findIndex(x => x === 1);
                if(bIdx !== -1 && val >= 1) unit.hpArr[bIdx] = 2;
                else {
                    const lIdx = unit.hpArr.findIndex(x => x === 2);
                    if(lIdx !== -1 && val >= 1) unit.hpArr[lIdx] = 3;
                }
            }
        }
        unit.hpArr.sort((a,b) => b-a);
    }
}

function deleteUnit(id) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•åˆªé™¤å…¶ä»–äººçš„å–®ä½');
        return;
    }

    if(!confirm('åˆªé™¤?')) return;

    if (myRole === 'st') {
        state.units = state.units.filter(u => u.id !== id);
        sendState();
        renderAll();
    } else {
        sendToHost({ type: 'deleteUnit', playerId: myPlayerId, unitId: id });
    }
}

function modifyHP(id, type, amount) {
    const u = state.units.find(u => u.id === id);
    if(!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•ä¿®æ”¹å…¶ä»–äººçš„å–®ä½');
        return;
    }

    if (myRole === 'st') {
        modifyHPInternal(u, type, amount);
        broadcastState();
    } else {
        sendToHost({
            type: 'modifyHP',
            playerId: myPlayerId,
            unitId: id,
            dmgType: type,
            amount: amount
        });
    }
}

// Open HP modification modal
function openHpModal(id, mode) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•ä¿®æ”¹å…¶ä»–äººçš„å–®ä½');
        return;
    }

    document.getElementById('hp-target-id').value = id;
    document.getElementById('hp-amount').value = 1;
    document.getElementById('hp-action-type').value = mode === 'heal' ? 'heal-b' : 'b';

    document.getElementById('hp-modal-title').innerText = mode === 'heal' ? `æ²»ç™‚ï¼š${u.name}` : `å‚·å®³ï¼š${u.name}`;
    document.getElementById('hp-modal-mode-damage').style.display = mode === 'damage' ? 'block' : 'none';
    document.getElementById('hp-modal-mode-heal').style.display = mode === 'heal' ? 'block' : 'none';

    // Reset button highlights
    document.querySelectorAll('#modal-hp .action-btn').forEach(btn => btn.style.boxShadow = '');
    // Highlight first option
    const firstBtn = document.querySelector(mode === 'heal' ? '#hp-modal-mode-heal .action-btn' : '#hp-modal-mode-damage .action-btn');
    if (firstBtn) firstBtn.style.boxShadow = '0 0 0 2px var(--accent-yellow)';

    document.getElementById('modal-hp').classList.add('show');
}

function setHpModalType(type) {
    document.getElementById('hp-action-type').value = type;
    // Update button highlights
    document.querySelectorAll('#modal-hp .action-btn').forEach(btn => btn.style.boxShadow = '');
    event.target.style.boxShadow = '0 0 0 2px var(--accent-yellow)';
}

function confirmHpModify() {
    const id = parseFloat(document.getElementById('hp-target-id').value);
    const amount = parseInt(document.getElementById('hp-amount').value) || 1;
    const type = document.getElementById('hp-action-type').value;

    modifyHP(id, type, amount);
    closeModal('modal-hp');
}

function updateInit(id, val) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•ä¿®æ”¹å…¶ä»–äººçš„å–®ä½');
        return;
    }

    if (myRole === 'st') {
        u.init = parseInt(val);
        sendState();
        renderAll();
    } else {
        sendToHost({
            type: 'updateInit',
            playerId: myPlayerId,
            unitId: id,
            init: parseInt(val)
        });
    }
}
function sortByInit() {
    if (myRole !== 'st') {
        showToast('åªæœ‰ ST å¯ä»¥æ’åº');
        return;
    }
    state.units.sort((a,b) => b.init - a.init);
    state.turnIdx = 0;
    broadcastState();
}
function nextTurn() {
    if (myRole !== 'st') {
        showToast('åªæœ‰ ST å¯ä»¥æ§åˆ¶å›åˆ');
        return;
    }
    if(state.units.length) {
        state.turnIdx = (state.turnIdx + 1) % state.units.length;
        broadcastState();
        setTimeout(() => {
            const el = document.querySelector('.unit-card.active-turn');
            if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
        }, 100);
    }
}

function selectUnit(id) { selectedUnitId = id; renderMap(); }

// Keyboard controls for selected unit
function setupKeyboardControls() {
    document.addEventListener('keydown', (e) => {
        // Only handle arrow keys when on map page and a unit is selected
        if (!document.getElementById('page-map').classList.contains('active')) return;
        if (selectedUnitId === null) return;
        if (currentTool !== 'cursor') return;

        const u = state.units.find(u => u.id === selectedUnitId);
        if (!u || !canControlUnit(u)) return;
        if (u.x < 0 || u.y < 0) return; // Unit not on map

        let dx = 0, dy = 0;
        switch(e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                dy = -1;
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                dy = 1;
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                dx = -1;
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                dx = 1;
                break;
            case 'Escape':
                // Deselect unit
                selectedUnitId = null;
                renderMap();
                return;
            default:
                return;
        }

        e.preventDefault();

        // Calculate new position
        const newX = Math.max(0, Math.min(state.mapW - 1, u.x + dx));
        const newY = Math.max(0, Math.min(state.mapH - 1, u.y + dy));

        // Don't move if position hasn't changed
        if (newX === u.x && newY === u.y) return;

        // Move the unit
        if (myRole === 'st') {
            u.x = newX;
            u.y = newY;
            broadcastState();
        } else {
            sendToHost({
                type: 'moveUnit',
                playerId: myPlayerId,
                unitId: u.id,
                x: newX,
                y: newY
            });
        }
    });
}
function startDeploy(id) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•æ“æ§å…¶ä»–äººçš„å–®ä½');
        return;
    }

    switchPage('map');
    selectedUnitId = id;
    renderMap();
    showToast('è«‹åœ¨åœ°åœ–ä¸Šé»æ“Šä½ç½®éƒ¨ç½²');
}
function recallUnit(id) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    if (!canControlUnit(u)) {
        showToast('ä½ ç„¡æ³•æ“æ§å…¶ä»–äººçš„å–®ä½');
        return;
    }

    if (myRole === 'st') {
        u.x = -1;
        u.y = -1;
        sendState();
        renderAll();
    } else {
        sendToHost({
            type: 'moveUnit',
            playerId: myPlayerId,
            unitId: id,
            x: -1,
            y: -1
        });
    }
}
function clearSelection() { selectedUnitId = null; currentTool = 'cursor'; renderAll(); }

document.getElementById('file-upload').addEventListener('change', e => {
    if(!uploadTargetId) return;
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = 64; cvs.height = 64;
                cvs.getContext('2d').drawImage(img,0,0,64,64);
                const avatarData = cvs.toDataURL('image/jpeg',0.7);

                if (myRole === 'st') {
                    const u = state.units.find(u => u.id === uploadTargetId);
                    if(u) {
                        u.avatar = avatarData;
                        broadcastState();
                    }
                } else {
                    // Player sends avatar to ST
                    sendToHost({
                        type: 'uploadAvatar',
                        playerId: myPlayerId,
                        unitId: uploadTargetId,
                        avatar: avatarData
                    });
                }
                uploadTargetId = null;
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
    // Reset input so same file can be selected again
    e.target.value = '';
});

function uploadAvatar(id) {
    const u = state.units.find(u => u.id === id);
    if (!u) return;

    // Allow ST to upload for any unit, players only for their own units
    if (myRole !== 'st' && u.ownerId !== myPlayerId) {
        showToast('ä½ åªèƒ½ç‚ºè‡ªå·±çš„å–®ä½ä¸Šå‚³é ­åƒ');
        return;
    }

    uploadTargetId = id;
    document.getElementById('file-upload').click();
}

/* --- 8. CALCULATOR LOGIC (FIXED) --- */
const DEF_TYPES = [
    {id:'armor',name:'ç›”ç”²',t:'physical'},{id:'shield',name:'ç›¾ç‰Œ',t:'physical'},{id:'natural',name:'å¤©ç”Ÿ',t:'physical'},
    {id:'base',name:'åŸºç¤',t:'agility'},{id:'dodge',name:'é–ƒé¿',t:'agility'},{id:'block',name:'æ ¼æ“‹',t:'agility'},{id:'shieldBlock',name:'ç›¾æ“‹',t:'agility'},
    {id:'force',name:'åŠ›å ´',t:'supernatural'},{id:'deflect',name:'åæ–œ',t:'supernatural'},{id:'magicArmor',name:'æ³•ç”²',t:'supernatural'},
    {id:'cover',name:'æ©è”½',t:'other'},{id:'insight',name:'æ´å¯Ÿ',t:'other'},{id:'other',name:'å…¶ä»–',t:'other'}
];

document.getElementById('def-inputs').innerHTML = DEF_TYPES.map(d => 
    `<div class="def-input-row" id="def-${d.id}"><span style="width:50px;font-size:0.8rem;">${d.name}</span><input type="number" data-def="${d.id}" value="0"></div>`
).join('');

function toggleDefTag(id) {
    document.querySelector(`.def-tag[data-def="${id}"]`).classList.toggle('active');
    const row = document.getElementById(`def-${id}`);
    row.classList.toggle('show');
    if(!row.classList.contains('show')) row.querySelector('input').value=0;
}
function toggleAtkTag(t) {
    document.querySelector(`.atk-tag[data-type="${t}"]`).classList.toggle('active');
    const row = document.getElementById(`row-${t}`);
    row.classList.toggle('show');
    if(!row.classList.contains('show')) row.querySelector('input').value=0;
}

function calculateDP() {
    let atk = parseInt(document.getElementById('c-atk').value)||0;
    let auto = parseInt(document.getElementById('c-atk-auto').value)||0;
    let will = parseInt(document.getElementById('c-will').value)||0;
    
    let pen = parseInt(document.getElementById('c-pen').value)||0;
    let spd = parseInt(document.getElementById('c-speed').value)||0;
    let mag = parseInt(document.getElementById('c-magic').value)||0;
    
    let defs = {};
    DEF_TYPES.forEach(t => defs[t.id] = parseInt(document.querySelector(`input[data-def="${t.id}"]`).value)||0);
    
    // Reductions
    if(pen>0 && defs.shield>0) { let r=Math.min(pen,defs.shield); defs.shield-=r; pen-=r; }
    if(pen>0 && defs.armor>0) { let r=Math.min(pen,defs.armor); defs.armor-=r; pen-=r; }
    if(pen>0 && defs.natural>0) defs.natural-=Math.min(pen,defs.natural);
    
    if(spd>0 && defs.block>0) { let r=Math.min(spd,defs.block); defs.block-=r; spd-=r; }
    if(spd>0 && defs.dodge>0) { let r=Math.min(spd,defs.dodge); defs.dodge-=r; spd-=r; }
    if(spd>0 && defs.base>0) defs.base-=Math.min(spd,defs.base);
    
    if(mag>0 && defs.force>0) { let r=Math.min(mag,defs.force); defs.force-=r; mag-=r; }
    if(mag>0 && defs.deflect>0) { let r=Math.min(mag,defs.deflect); defs.deflect-=r; mag-=r; }
    if(mag>0 && defs.magicArmor>0) defs.magicArmor-=Math.min(mag,defs.magicArmor);
    
    let hits = parseInt(document.getElementById('c-hits').value)||0;
    while(hits>0) {
        if(defs.block>0) defs.block = Math.max(0, defs.block-2);
        else if(defs.shieldBlock>0) defs.shieldBlock = Math.max(0, defs.shieldBlock-2);
        else if(defs.dodge>0) defs.dodge = Math.max(0, defs.dodge-2);
        hits--;
    }
    
    let totalDef = Object.values(defs).reduce((a,b)=>a+b,0);
    let defAuto = parseInt(document.getElementById('c-def-auto').value)||0;
    
    let final = atk + will + auto - (totalDef + defAuto);
    const rm = document.getElementById('result-main');
    const rd = document.getElementById('result-detail');
    
    if(final > 0) {
        rm.innerText = `${final} D10`; rm.style.color='var(--accent-green)';
        rd.innerText = `æ”»æ“Š ${atk+will+auto} - é˜²ç¦¦ ${totalDef+defAuto}`;
    } else {
        rm.innerText = `æ©Ÿé‹éª°`; rm.style.color='var(--accent-red)';
        rd.innerText = `DP ${final} (â‰¤0)ï¼Œè½‰ç‚ºæ©Ÿé‹éª°åˆ¤å®š`;
    }
}

/* --- BOSS LOGIC FIXED --- */
let bossActions = [];
function toggleBossMode() {
    document.getElementById('boss-options').classList.toggle('show', document.getElementById('boss-mode').checked);
}
function addBossAction() {
    bossActions.push({ id: Date.now(), winner: 'boss' }); // default boss wins init
    renderBossActions(); updateBossSummary();
}
function removeBossAction(id) {
    bossActions = bossActions.filter(a => a.id !== id);
    renderBossActions(); updateBossSummary();
}
function setBossActionWinner(id, w) {
    const a = bossActions.find(a => a.id === id);
    if(a) { a.winner = w; updateBossSummary(); }
}

function renderBossActions() {
    const d = document.getElementById('boss-actions-list');
    d.innerHTML = bossActions.map((a, i) => `
        <div class="boss-action-item">
            <span class="boss-action-num">#${i+1}</span>
            <label><input type="radio" name="ba-${a.id}" ${a.winner==='boss'?'checked':''} onchange="setBossActionWinner(${a.id},'boss')"> Bosså¿«</label>
            <label><input type="radio" name="ba-${a.id}" ${a.winner==='player'?'checked':''} onchange="setBossActionWinner(${a.id},'player')"> ç©å®¶å¿«</label>
            <button onclick="removeBossAction(${a.id})" style="margin-left:auto;color:var(--text-dim);background:none;">âœ•</button>
        </div>
    `).join('');
}

function updateBossSummary() {
    const tier = parseInt(document.getElementById('boss-tier').value) || 1;
    const engage = document.getElementById('boss-engage').value;
    const content = document.getElementById('boss-summary-content');
    const baseVal = tier * 10;
    
    if(engage === 'no') {
        content.innerHTML = `<div class="boss-summary-line"><span>æœ¬å›åˆæœªå°æŠ—ï¼Œç©å®¶ DP</span><span class="val-pos">+${baseVal}</span></div>`;
        return;
    }

    if(bossActions.length === 0) {
        content.innerHTML = '<div style="color:gray;">è«‹æ–°å¢è¡Œå‹•ä»¥è¨ˆç®—</div>';
        return;
    }

    // New Logic per user request
    let html = '';
    
    // 1. Multi-action penalty calculation
    // "è‹¥æ‡‰å°è¤‡æ•¸è¡Œå‹•ï¼Œæ¯å¤šä¸€å€‹ï¼ŒBOSSé‡å°ä½ çš„è¡Œå‹•DPå¢åŠ  Tier*10"
    const extraCount = Math.max(0, bossActions.length - 1);
    const multiPenalty = extraCount * baseVal;
    
    if(extraCount > 0) {
        html += `<div class="boss-summary-line"><span>è¤‡æ•¸è¡Œå‹•æ‡²ç½° (${extraCount}å€‹é¡å¤–)</span><span class="val-neg">Boss DP +${multiPenalty}</span></div>`;
    } else {
        html += `<div class="boss-summary-line"><span>å–®ä¸€è¡Œå‹•</span><span class="val-neutral">ç„¡æ‡²ç½°</span></div>`;
    }

    html += '<hr style="border:0;border-top:1px dashed #444;width:100%;margin:4px 0;">';

    // 2. Per action calculation
    bossActions.forEach((a, idx) => {
        let speedMod = 0;
        let speedText = "";
        
        if (a.winner === 'boss') {
            speedMod = baseVal;
            speedText = "Bosså…ˆæ”»å¿« (+10)";
        } else {
            speedMod = -baseVal;
            speedText = "Bosså…ˆæ”»æ…¢ (-10)";
        }
        
        const total = speedMod + multiPenalty;
        const colorClass = total > 0 ? 'val-neg' : (total < 0 ? 'val-pos' : 'val-neutral');
        const sign = total > 0 ? '+' : '';
        
        html += `
            <div class="boss-summary-line">
                <span>è¡Œå‹• #${idx+1} (${a.winner==='boss'?'Bosså¿«':'ç©å®¶å¿«'})</span>
                <span class="${colorClass}">Boss DP ${sign}${total}</span>
            </div>
            <div style="font-size:0.7rem;color:#666;text-align:right;margin-top:-2px;">
                (é€Ÿåº¦${speedMod > 0 ? '+' : ''}${speedMod} + æ‡²ç½°+${multiPenalty})
            </div>
        `;
    });

    content.innerHTML = html;
}

function resetCalc() {
    document.querySelectorAll('#page-calc input[type="number"]').forEach(i => {
        if(i.id!=='boss-tier') i.value=0;
    });
    document.getElementById('c-atk').value = 10; // default
    // Only remove active from calculator tags, not navigation tabs
    document.querySelectorAll('#page-calc .def-tag.active, #page-calc .atk-tag.active').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.def-input-row').forEach(e=>e.classList.remove('show'));
    document.querySelectorAll('#page-calc .calc-field.def-input-row').forEach(e=>e.classList.remove('show'));
    document.getElementById('result-main').innerText='---';
    document.getElementById('result-main').style.color='var(--accent-green)';
    document.getElementById('result-detail').innerText='ä¸€èˆ¬è¨ˆç®—çµæœé¡¯ç¤ºæ–¼æ­¤\n(BOSSæ¨¡å¼è«‹çœ‹ä¸Šæ–¹é è¦½é¢æ¿)';
}

/* --- UTILS --- */
function escapeHtml(t) { return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):t; }
function copyId() { navigator.clipboard.writeText(myPeerId).then(()=>showToast('æˆ¿é–“ ID å·²è¤‡è£½')); }
function copyMyCode() { navigator.clipboard.writeText(myPlayerCode).then(()=>showToast('è­˜åˆ¥ç¢¼å·²è¤‡è£½: ' + myPlayerCode)); }

// Update player code display in navbar
function updateCodeDisplay() {
    const codeEl = document.getElementById('my-code');
    if (codeEl && myPlayerCode) {
        codeEl.innerText = myPlayerCode;
        codeEl.style.display = 'inline-block';
    }
}
function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebar-toggle').classList.toggle('active'); }
function switchPage(p) {
    document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
    document.querySelector(`.nav-tab[data-page="${p}"]`).classList.add('active');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    checkExistingSession();
    setupKeyboardControls();
});
</script>
</body>
</html>