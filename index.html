<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Limbus Command</title>

    <!-- 安全標頭 -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- Firebase SDK (使用 Compat 版本以支援舊版語法) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet" crossorigin="anonymous">
    <!-- CSS 檔案 -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/calculator.css">
    <link rel="stylesheet" href="styles/combat-hud.css">
</head>
<body>
<input type="file" id="file-upload" accept="image/*" style="display:none;">
<div class="toast" id="toast"></div>

<!-- Login Layer -->
<div id="login-layer">
    <div class="login-box" id="login-main">
        <div class="login-title">LIMBUS</div>
        <div style="color:var(--text-dim);margin-bottom:20px;">戰術指揮系統</div>
        <input type="text" id="input-name" placeholder="輸入代號" style="width:100%;text-align:center;margin-bottom:10px;">
        <button class="login-btn btn-host" onclick="showSTStep()">我是 ST（建房）</button>
        <button class="login-btn btn-join" onclick="showJoinStep()">我是玩家（加入）</button>
    </div>
    <div class="login-box hidden" id="login-st">
        <div class="login-title">建立房間</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">如有舊識別碼可輸入以恢復身份</div>
        <input type="text" id="input-st-code" placeholder="4 位數識別碼（選填）" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-host" onclick="initSystem('st')">建立房間</button>
        <button class="login-btn" style="background:var(--accent-blue);" onclick="showRoomManager()">📋 房間管理</button>
        <button class="login-btn btn-back" onclick="showMainStep()">返回</button>
    </div>
    <div class="login-box hidden" id="login-join">
        <div class="login-title">加入房間</div>
        <input type="text" id="input-host-id" placeholder="貼上 ST 的房間 ID" style="width:100%;text-align:center;margin-bottom:10px;">
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">如有舊識別碼可輸入以恢復身份</div>
        <input type="text" id="input-player-code" placeholder="4 位數識別碼（選填）" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-join" onclick="initSystem('player')">連線</button>
        <button class="login-btn btn-back" onclick="showMainStep()">返回</button>
    </div>
    <div class="login-box hidden" id="login-loading">
        <div style="color:var(--accent-green);margin-bottom:10px;">連線中...</div>
        <div id="loading-status" style="font-size:0.8rem;color:var(--text-dim);"></div>
    </div>
    <div class="login-box hidden" id="login-room-manager" style="max-width:600px;max-height:80vh;overflow-y:auto;">
        <div class="login-title">房間管理</div>
        <div id="room-list-container" style="margin:15px 0;"></div>
        <button class="login-btn btn-back" onclick="showSTStep()">返回</button>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="map" onclick="switchPage('map')">🗺️ 地圖</button>
        <button class="nav-tab" data-page="units" onclick="switchPage('units')">⚔️ 單位</button>
        <button class="nav-tab" data-page="calc" onclick="switchPage('calc')">🎲 計算</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
        <div class="conn-status" id="conn-status" title="連線狀態">
            <div class="conn-dot connecting" id="conn-dot"></div>
            <span id="conn-text">連線中</span>
        </div>
        <span class="player-code" id="my-code" onclick="copyMyCode()" title="點擊複製識別碼" style="font-size:0.9rem;padding:4px 8px;display:none;">----</span>
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">📋</button>
        <span class="id-badge" id="my-id" onclick="copyId()" title="點擊複製ID">---</span>
        <button class="logout-btn" id="logout-btn" onclick="logoutAndReset()" title="登出/切換帳號" style="display:none;">🚪</button>
    </div>
</nav>

<!-- 戰鬥模式：Navbar 暫開按鈕 -->
<button class="combat-navbar-peek" id="combat-navbar-peek" title="顯示導覽列">▼</button>

<!-- Main Content -->
<div class="main-wrapper">
    <!-- Map Page -->
    <div id="page-map" class="page active">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span style="font-weight:bold;color:var(--accent-yellow);">戰鬥序列</span>
                <button style="background:none;color:var(--text-dim);font-size:1.2rem;" onclick="toggleSidebar()">×</button>
            </div>
            <div class="sidebar-content">
                <div id="tile-info-panel">
                    <div style="color:var(--accent-yellow);font-weight:bold;margin-bottom:4px;">地形效果</div>
                    <div id="tile-effect-desc"></div>
                </div>
                <div id="sidebar-units"></div>
            </div>
        </aside>
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;">
            <div class="map-toolbar">
                <div class="map-tools-scroll" id="dynamic-tools">
                    <button class="tool-btn active" data-tool="cursor" onclick="setTool('cursor')">👆</button>
                    <button class="tool-btn" data-tool="floor" onclick="setTool('floor')">🧹</button>
                </div>
                <div class="tool-separator"></div>
                <button class="tool-btn" onclick="resetCamera()" title="視角歸位">🎯</button>
                <button class="tool-btn" onclick="clearSelection()" title="取消選取">✕</button>
                
                <div class="map-controls-right" id="st-map-controls">
                    <button class="map-manager-btn" onclick="openMapManagerModal()" title="儲存/載入地圖">📂 地圖</button>
                    <select id="map-theme-select" class="map-select" onchange="changeMapTheme(this.value)">
                        <option value="0">一般訓練室</option>
                        <option value="1">後巷深處</option>
                        <option value="2">L 公司廢墟</option>
                        <option value="3">W 公司列車</option>
                        <option value="4">K 公司工廠</option>
                        <option value="5">U 公司甲板</option>
                        <option value="6">冰雪城堡</option>
                        <option value="7">血肉山丘</option>
                        <option value="8">地獄雞廚房</option>
                        <option value="9">廢品蟹海灘</option>
                        <option value="10">20區的奇蹟</option>
                        <option value="11">肉斬骨斷</option>
                    </select>
                    <input type="number" id="map-w" class="size-input" value="15" min="5" max="50">
                    <span style="font-size:0.8rem;color:#555;">x</span>
                    <input type="number" id="map-h" class="size-input" value="15" min="5" max="50">
                    <button class="apply-btn" onclick="resizeMap()">套用</button>
                </div>
            </div>
            <div class="map-viewport" id="map-viewport">
                <div class="map-container" id="map-container">
                    <div id="battle-map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Units Page -->
    <div id="page-units" class="page">
        <div class="units-toolbar" id="units-toolbar">
            <button class="units-btn primary" onclick="nextTurn()">▶ 下一回合</button>
            <button class="units-btn" onclick="openAddUnitModal()">+ 新增</button>
            <button class="units-btn" onclick="openBatchModal()">📋 批量</button>
            <button class="units-btn" onclick="sortByInit()">⏱ 排序</button>
        </div>
        <div class="units-list" id="units-list"></div>
    </div>

    <!-- Calculator Page -->
    <div id="page-calc" class="page">
        <div class="calc-container">
            <!-- Boss Mode Section -->
            <div class="calc-section">
                <label class="boss-toggle">
                    <input type="checkbox" id="boss-mode" onchange="toggleBossMode()">
                    <div>
                        <div style="font-weight:bold;color:var(--accent-purple);">🔮 特殊 BOSS 模式</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">啟用房規計算：複數行動、先攻加成</div>
                    </div>
                </label>
                <div class="boss-options" id="boss-options">
                    <div class="calc-grid">
                        <div class="calc-field">
                            <span class="calc-label">主線/支線等級</span>
                            <input type="number" id="boss-tier" value="1" min="1" max="10" onchange="updateBossSummary()">
                        </div>
                        <div class="calc-field">
                            <span class="calc-label">本回合狀況</span>
                            <select id="boss-engage" onchange="updateBossSummary()">
                                <option value="yes">有對抗行動</option>
                                <option value="no">完全未對抗 (我方DP+)</option>
                            </select>
                        </div>
                    </div>
                    <div id="boss-actions-list" style="margin-top:10px;"></div>
                    <button class="boss-add-action" onclick="addBossAction()">+ 新增對抗行動</button>
                    <div class="boss-summary">
                        <div style="font-weight:bold;color:var(--accent-purple);margin-bottom:6px;">📊 結果預覽</div>
                        <div id="boss-summary-content" style="display:flex;flex-direction:column;gap:4px;"></div>
                    </div>
                </div>
            </div>

            <!-- Attacker Section -->
            <div class="calc-section">
                <div class="calc-section-title atk">🗡️ 攻擊方 (我方)</div>
                <div class="atk-tags">
                    <span class="atk-tag" data-type="pen" onclick="toggleAtkTag('pen')">破甲</span>
                    <span class="atk-tag" data-type="speed" onclick="toggleAtkTag('speed')">高速</span>
                    <span class="atk-tag" data-type="magic" onclick="toggleAtkTag('magic')">破魔</span>
                </div>
                <div class="calc-grid">
                    <div class="calc-field">
                        <span class="calc-label">攻擊 DP</span>
                        <input type="number" id="c-atk" value="10" min="0">
                    </div>
                    <div class="calc-field">
                        <span class="calc-label">攻擊附加成功</span>
                        <input type="number" id="c-atk-auto" value="0" min="0">
                    </div>
                    <div class="calc-field">
                        <span class="calc-label">意志加值</span>
                        <select id="c-will">
                            <option value="0">不使用</option>
                            <option value="3">+3 (完美)</option>
                        </select>
                    </div>
                </div>
                <div class="def-input-row" id="row-pen">
                    <span>破甲值</span>
                    <input type="number" id="c-pen" value="0">
                </div>
                <div class="def-input-row" id="row-speed">
                    <span>高速值</span>
                    <input type="number" id="c-speed" value="0">
                </div>
                <div class="def-input-row" id="row-magic">
                    <span>破魔值</span>
                    <input type="number" id="c-magic" value="0">
                </div>
            </div>

            <!-- Defender Section -->
            <div class="calc-section">
                <div class="calc-section-title def">🛡️ 防禦方 (敵方)</div>
                <div class="def-tags" id="def-tags"></div>
                <div class="def-inputs" id="def-inputs"></div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">
                    <div class="calc-grid">
                        <div class="calc-field">
                            <span class="calc-label">本回合已受擊次數</span>
                            <input type="number" id="c-hits" value="0" min="0">
                        </div>
                        <div class="calc-field">
                            <span class="calc-label" style="color:var(--accent-orange)">防禦附加成功</span>
                            <input type="number" id="c-def-auto" value="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="calc-buttons">
                <button class="calc-btn calc-btn-reset" onclick="resetCalc()">🔄 重置</button>
                <button class="calc-btn calc-btn-calc" onclick="calculateDP()">⚡ 計算 (僅一般)</button>
            </div>
            <div style="text-align:center;padding:15px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);">
                <div id="result-main" style="font-size:2rem;font-weight:bold;color:var(--accent-green);">---</div>
                <div id="result-detail" style="font-size:0.8rem;color:var(--text-dim);margin-top:5px;">
                    一般計算結果顯示於此<br>(BOSS模式請看上方預覽面板)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modals-container"></div>

<!-- 快速操作球 (Quick Action Ball) -->
<div id="quick-action-ball" class="qab-container">
    <!-- 彈出選單 -->
    <div class="qab-menu" id="qab-menu">
        <div class="qab-menu-item" onclick="toggleMusicPanel(); closeQABMenu();">
            <span class="qab-menu-icon">🎵</span>
            <span class="qab-menu-text">音樂播放器</span>
        </div>
        <div class="qab-menu-item" onclick="toggleLyricsPanel(); closeQABMenu();">
            <span class="qab-menu-icon">📝</span>
            <span class="qab-menu-text">歌詞工具</span>
            <span class="qab-menu-icon">🎤</span>
            <span class="qab-menu-text">動態歌詞</span>
        </div>
        <div class="qab-menu-item" onclick="toggleHotkeyHelp(); closeQABMenu();">
            <span class="qab-menu-icon">⌨</span>
            <span class="qab-menu-text">快捷鍵說明</span>
        </div>
        <div class="qab-menu-item" onclick="openImportModal(); closeQABMenu();">
            <span class="qab-menu-icon">📊</span>
            <span class="qab-menu-text">匯入角色數據</span>
        </div>
        <div class="qab-menu-item" onclick="toggleCombatHUD(); closeQABMenu();">
            <span class="qab-menu-icon">🎯</span>
            <span class="qab-menu-text">戰鬥儀表板</span>
        </div>
        <div class="qab-menu-divider"></div>
        <div class="qab-menu-item" onclick="openHUDSettings(); closeQABMenu();">
            <span class="qab-menu-icon">⚙️</span>
            <span class="qab-menu-text">HUD 設定</span>
        </div>
    </div>

    <!-- 主按鈕 -->
    <button class="qab-main-btn" id="qab-main" onclick="toggleQABMenu()" title="快速操作">
        <span class="qab-icon">⚡</span>
    </button>

    <!-- 音樂播放器面板 -->
    <div id="music-player-panel" class="qab-panel music-panel">
        <div class="music-header">
            <span class="music-title">背景音樂</span>
            <button class="music-close-btn" onclick="toggleMusicPanel()">×</button>
        </div>
        <div class="music-panel-body">
            <div class="music-now-playing">
                <span class="music-label">正在播放</span>
                <span id="bgm-now-playing" class="music-track-name">無音樂</span>
            </div>
            <div class="music-controls">
                <button id="bgm-play-btn" class="music-ctrl-btn" onclick="stTogglePlayback()" title="播放/暫停">▶</button>
                <button id="bgm-stop-btn" class="music-ctrl-btn" onclick="handleStopMusic()" title="停止">⏹</button>
                <button id="bgm-mute-btn" class="music-ctrl-btn" onclick="toggleMute()" title="靜音">🔊</button>
                <button id="bgm-lyrics-pick-btn" class="music-ctrl-btn" onclick="toggleLyricsPicker()" title="選擇歌詞">🎤</button>
                <input type="range" id="bgm-volume" class="music-volume" min="0" max="100" value="50" oninput="setVolume(this.value / 100)" title="音量">
            </div>
            <div id="bgm-st-controls" class="music-st-section" style="display:none;">
                <div class="music-section-title">播放清單 (ST)</div>
                <div class="music-add-form">
                    <input type="text" id="bgm-input-name" placeholder="音樂名稱" class="music-input">
                    <input type="text" id="bgm-input-url" placeholder="音樂 URL" class="music-input">
                    <button class="music-add-btn" onclick="addToPlaylist(document.getElementById('bgm-input-name').value, document.getElementById('bgm-input-url').value)">+ 新增</button>
                </div>
                <div id="bgm-playlist" class="music-playlist">
                    <div style="color:var(--text-dim);font-size:0.8rem;text-align:center;padding:10px;">播放清單為空</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 歌詞工具面板 (獨立) -->
    <div id="lyrics-panel" class="qab-panel lyrics-tool-panel">
        <div class="music-header">
            <span class="music-title">歌詞工具</span>
            <button class="music-close-btn" onclick="toggleLyricsPanel()">×</button>
        </div>
        <div class="lyrics-tool-body">
            <!-- 歌詞輸入 -->
            <div class="lyrics-section">
                <div class="music-section-title">歌詞字幕</div>
                <textarea id="lyrics-input" class="lyrics-textarea" placeholder="在此輸入歌詞，每行一句&#10;例如：&#10;在黑暗中前行&#10;尋找那道光芒&#10;即使世界崩塌"></textarea>
                <div class="lyrics-controls">
                    <div class="lyrics-speed-control">
                        <label class="lyrics-label" for="lyrics-speed">速度</label>
                        <input type="range" id="lyrics-speed" class="lyrics-slider" min="0" max="1000" value="80" step="5">
                        <span id="lyrics-speed-val" class="lyrics-speed-val">80ms</span>
                    </div>
                    <div class="lyrics-speed-control">
                        <label class="lyrics-label" for="lyrics-pause">行距</label>
                        <input type="range" id="lyrics-pause" class="lyrics-slider" min="200" max="2000" value="600" step="100">
                        <span id="lyrics-pause-val" class="lyrics-speed-val">0.6s</span>
                    </div>
                    <div class="lyrics-actions">
                        <button class="lyrics-play-btn" id="lyrics-play-btn" onclick="toggleLyricsPlayback()">▶ 播放</button>
                    </div>
                    <!-- 速度預設組 -->
                    <div class="lyrics-speed-presets">
                        <span class="lyrics-label">預設</span>
                        <button class="speed-preset-btn active" id="speed-preset-1" data-preset="1">A: 80ms</button>
                        <button class="speed-preset-btn" id="speed-preset-2" data-preset="2">B: 80ms</button>
                        <button class="speed-preset-save-btn" id="speed-preset-save" title="儲存目前速度到選中的預設">儲存</button>
                    </div>
                    <!-- 同步偏移微調 -->
                    <div class="lyrics-speed-control">
                        <label class="lyrics-label" for="lyrics-sync-offset">偏移</label>
                        <input type="range" id="lyrics-sync-offset" class="lyrics-slider" min="-2" max="2" value="-0.5" step="0.1">
                        <span id="lyrics-sync-offset-val" class="lyrics-speed-val">-0.5s</span>
                    </div>
                </div>
            </div>
            <!-- ST 專用區域：錄製、清單、匯入、逐行編輯 -->
            <div id="lyrics-st-controls" class="lyrics-st-section" style="display:none;">
            <!-- 錄製模式 -->
            <div class="lyrics-section">
                <div class="music-section-title">手動錄製定點</div>
                <div class="rec-mode-desc">播放音樂後按「開始錄製」，在每句台詞開頭時按空白鍵定點。可從指定行數開始重錄，之前的定點會保留。</div>
                <div class="rec-controls">
                    <div class="rec-start-from">
                        <label class="lyrics-label" for="rec-start-line">從第</label>
                        <input type="number" id="rec-start-line" class="rec-start-input" min="1" value="1" step="1">
                        <label class="lyrics-label">句開始</label>
                    </div>
                    <button class="rec-btn" id="rec-start-btn" onclick="toggleRecording()">⏺ 開始錄製</button>
                    <button class="rec-btn rec-clear-btn" id="rec-clear-btn" onclick="clearRecording()">清除</button>
                </div>
                <div id="rec-status" class="rec-status"></div>
            </div>
            <!-- 匯入 -->
            <div class="lyrics-section">
                <button class="lyrics-import-btn" onclick="importJsonTimeline()">匯入 AI 分析數據 (JSON)</button>
            </div>
            <!-- 歌詞清單 -->
            <div class="lyrics-section">
                <div class="music-section-title">歌詞清單</div>
                <div class="lyrics-library-save">
                    <input type="text" id="lyrics-save-name" class="lyrics-save-name-input" placeholder="輸入歌詞名稱...">
                    <button class="lyrics-save-btn" id="lyrics-save-btn" onclick="saveLyricsToLibrary()">儲存</button>
                </div>
                <div id="lyrics-library-list" class="lyrics-library-list">
                    <div class="lyrics-library-empty">尚無儲存的歌詞</div>
                </div>
            </div>
            <!-- 逐行微調編輯器 -->
            <div id="lyrics-line-editor" class="lyrics-line-editor" style="display:none;">
                <div class="music-section-title">逐行微調</div>
                <div id="lyrics-line-list" class="lyrics-line-list"></div>
            </div>
            </div><!-- /lyrics-st-controls -->
        </div>
    </div>

    <!-- 快捷鍵說明面板 -->
    <div class="qab-panel hotkey-help-panel hidden" id="hotkey-help">
        <!-- 內容由 JS 動態生成 -->
    </div>

    <!-- 動態歌詞控制面板 -->
    <div id="lyrics-control-panel" class="qab-panel lyrics-panel">
        <div class="lyrics-panel-header">
            <span class="lyrics-panel-title">動態歌詞</span>
            <button class="lyrics-close-btn" onclick="toggleLyricsPanel()">×</button>
        </div>
        <div class="lyrics-panel-body">
            <!-- 歌詞輸入 -->
            <div class="lyrics-input-section">
                <textarea id="lyrics-text" class="lyrics-textarea" placeholder="在此輸入歌詞..."></textarea>
            </div>
            <!-- 速度控制 -->
            <div class="lyrics-speed-section">
                <label class="lyrics-label">打字速度</label>
                <input type="range" id="lyrics-speed-range" min="20" max="300" value="80" class="lyrics-speed-slider">
                <span id="lyrics-speed-value" class="lyrics-speed-val">80ms</span>
            </div>
            <!-- Tap Tempo 測速區塊 -->
            <div class="tap-tempo-section">
                <button id="tap-btn" class="tap-tempo-btn" onclick="handleTap()">跟著節奏按此 (或按 'T')</button>
                <div id="tap-bpm-display" class="tap-bpm-display">BPM: --</div>
            </div>
            <!-- 播放控制 -->
            <div class="lyrics-play-section">
                <button class="lyrics-btn lyrics-btn-play" onclick="playLyrics()">▶ 播放</button>
                <button class="lyrics-btn lyrics-btn-stop" onclick="stopLyrics()">⏹ 停止</button>
            </div>
            <!-- 歌詞顯示區 -->
            <div id="lyrics-display" class="lyrics-display"></div>
        </div>
    </div>
</div>

<!-- JS 檔案 - 分層載入，順序很重要！ -->
<!-- 配置層 -->
<script src="src/config/config.js"></script>
<script src="src/config/status-config.js"></script>
<script src="src/config/firebase-config.js"></script>

<!-- 核心層 -->
<script src="src/core/state.js"></script>

<!-- 工具層 -->
<script src="src/utils/security.js"></script>
<script src="src/utils/utils.js"></script>

<!-- 資料層 -->
<script src="src/data/storage.js"></script>
<script src="src/data/firebase-connection.js"></script>

<!-- UI 層 -->
<script src="src/ui/camera.js"></script>
<script src="src/ui/map.js"></script>
<script src="src/core/map-manager.js"></script>
<script src="src/ui/units.js"></script>
<script src="src/core/status-manager.js"></script>
<script src="src/core/calculator.js"></script>
<script src="src/ui/hotkeys.js"></script>
<script src="src/ui/modals.js"></script>
<script src="src/utils/audio.js"></script>
<script src="src/ui/lyrics.js"></script>
<script src="src/ui/combat-hud.js"></script>
<script src="src/ui/main.js"></script>
</body>
</html>
