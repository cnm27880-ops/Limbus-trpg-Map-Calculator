# Limbus Command

TRPG 戰術指揮系統，支援即時多人連線、地圖編輯、單位管理、狀態效果與 DP 計算。

## 功能總覽

### 多人連線系統
- **Firebase 即時同步**：所有玩家即時同步遊戲狀態
- **房間系統**：ST 建立房間，玩家透過房間 ID 加入
- **玩家識別碼**：4 位數識別碼，可用於重新連線恢復身份
- **房間管理**：ST 可查看和管理所有已建立的房間

### 地圖系統
- **可調整大小**：5x5 至 50x50 格子
- **12 種主題場景**：
  1. 一般訓練室 - 牆壁、掩體、險地
  2. 後巷深處 - 生鏽掩體、油污積水、路燈、垃圾堆
  3. L公司廢墟 - Cogito洩漏、收容門、活性屍塊、抑制力場
  4. W公司列車 - 空間裂隙、血肉座椅、頭等艙屏障、時間停滯
  5. K公司工廠 - HP安瓿、玻璃棧道、監控區域、消毒噴嘴
  6. U公司甲板 - 濕滑甲板、巨浪拍打、魚叉發射器、共鳴音叉
  7. 冰雪城堡 - 萬年玄冰、巨大冰刺、凍結供品、深淵邊緣
  8. 血肉山丘 - 蠕動屍骸、獻祭之火、穿刺樁、金枝光輝
  9. 地獄雞廚房 - 火焰烤架、油鍋、切肉台、冷凍庫
  10. 廢品蟹海灘 - 潮汐區、蟹殼掩體、漂流物、沙坑
  11. 20區的奇蹟 - 聖光區域、奇蹟泉水、祈禱石、腐敗區
  12. 肉斬骨斷 - 血池、骨刺地帶、肉牆、絞肉機
- **地形效果顯示**：ST 點擊格子可查看地形效果（僅 ST 可見）
- **繪製工具**：ST 可繪製各種地形，支援拖曳連續繪製
- **地圖儲存/載入**：
  - ST 可儲存當前地圖（含所有地形配置）
  - 最多儲存 20 張地圖
  - 可自訂地圖名稱
  - 支援載入和刪除已儲存的地圖

### 單位管理
- **新增單位**：支援單個新增或批量新增
- **單位大小**：支援 1x1（普通）、2x2（大型）、3x3（巨型）單位
- **HP 系統**：
  - 3 種傷害類型：B傷(鈍擊)、L傷(穿刺)、A傷(惡化)
  - 傷害升級機制：滿格時 B→L→A
  - 治療優先順序：A > L > B
- **頭像上傳**：可為單位上傳自訂頭像
- **先攻管理**：可設定先攻值並排序
- **回合控制**：ST 控制回合切換，自動高亮當前行動單位
- **部署系統**：選擇單位後點擊地圖部署，可收回至待命區

### 狀態效果系統
完整的狀態效果管理系統，基於無限恐怖規則：

- **60+ 種狀態效果**，分為 9 大類別：
  1. **戰鬥狀態** - 昏迷、定身、擊倒、纏鬥、脫離纏鬥等
  2. **增益效果** - 專注、鼓舞、庇護、幸運、狂暴等
  3. **減益效果** - 恐懼、易傷、目盲、耳聾、混亂等
  4. **元素效果** - 燃燒、冰凍、觸電、中毒、石化等
  5. **傷勢狀態** - 淺層傷口、深層傷口、出血、骨折、內傷等
  6. **心智狀態** - 驚慌、絕望、瘋狂、心靈創傷、意志動搖等
  7. **特殊狀態** - 隱形、飛行、潛行、變形、虛體化等
  8. **環境效果** - 黑暗、強光、濃霧、高溫、低溫等
  9. **其他效果** - 標記、追蹤、守護、挑釁、聚焦等

- **狀態計數器**：支援層數/回合數追蹤
- **即時同步**：狀態變更自動同步所有玩家
- **視覺化顯示**：狀態圖標顯示於單位卡片和地圖 Token 上

### 快捷鍵系統
按 `?` 鍵可查看完整快捷鍵說明：

| 按鍵 | 功能 |
|------|------|
| `1` / `2` / `3` | 切換頁面（地圖/單位/計算） |
| `Q` | 選取工具 |
| `W` | 清除地形工具 |
| `空白鍵` | 下一回合（僅 ST） |
| `Esc` | 取消選取 / 關閉視窗 |
| `Delete` | 刪除選取的單位 |
| `R` | 重置視角 |
| `方向鍵` | 移動選中的單位（已部署）或移動視角 |
| `+` / `-` | 放大/縮小視角 |
| `Tab` | 切換側邊欄 |
| `?` | 顯示快捷鍵說明 |

### 地圖操控
- **滑鼠拖曳**：平移地圖視角
- **滾輪縮放**：0.5x ~ 3.0x 縮放範圍
- **觸控支援**：支援手機觸控平移與捏合縮放
- **鍵盤控制**：方向鍵移動選中的單位或視角
- **視角重置**：一鍵歸位視角

### DP 計算器
- **攻擊方設定**：
  - 攻擊 DP、附加成功、意志加值
  - 特殊標籤：破甲、高速、破魔
- **防禦方設定**：
  - 12 種防禦類型（盔甲、盾牌、天生、基礎、閃避、格擋、盾擋、力場、偏斜、法甲、掩蔽、洞察、其他）
  - 受擊次數衰減計算
  - 防禦附加成功
- **BOSS 模式**：
  - 複數行動懲罰計算
  - 先攻快慢判定
  - 即時結果預覽

### 響應式設計
- **電腦版**：側邊欄預設顯示，可收合
- **手機版**：側邊欄預設隱藏，點擊按鈕展開
- **自適應佈局**：各元件自動調整大小

## 專案結構

```
limbus-command/
├── index.html              # 主要 HTML 檔案
├── README.md               # 說明文件
│
├── 樣式檔案
│   ├── main.css            # 主要樣式（版面、變數、RWD）
│   ├── components.css      # 元件樣式（Token、單位卡片、Modal）
│   └── calculator.css      # 計算器專用樣式
│
├── 核心模組
│   ├── config.js           # 配置（地圖預設、防禦類型）
│   ├── state.js            # 狀態管理
│   ├── utils.js            # 工具函數
│   └── main.js             # 主程式進入點
│
├── Firebase 相關
│   ├── firebase-config.js  # Firebase 配置
│   └── firebase-connection.js  # Firebase 連線管理
│
├── 功能模組
│   ├── storage.js          # 本地儲存
│   ├── camera.js           # 相機控制（平移、縮放）
│   ├── map.js              # 地圖渲染模組
│   ├── map-manager.js      # 地圖儲存/載入管理
│   ├── units.js            # 單位模組
│   ├── calculator.js       # DP 計算器
│   ├── modals.js           # Modal 彈窗
│   └── hotkeys.js          # 快捷鍵系統
│
└── 狀態效果系統
    ├── status-config.js    # 狀態效果配置（60+ 種狀態）
    └── status-manager.js   # 狀態效果管理器
```

## 使用方式

### 本地開發
直接用瀏覽器開啟 `index.html`，或使用本地伺服器：

```bash
# Python
python -m http.server 8080

# Node.js
npx serve .
```

### 部署到 GitHub Pages
1. 將所有檔案推送到 GitHub 倉庫
2. 進入 Settings > Pages
3. 選擇分支（通常是 `main`）並儲存
4. 等待部署完成

## 角色說明

### ST（Story Teller）
- 建立房間並分享房間 ID
- 完整的地圖編輯權限
- 控制回合與先攻排序
- 可查看所有地形效果
- 可操作所有單位
- 可儲存/載入地圖

### 玩家
- 透過房間 ID 加入遊戲
- 可新增並操作自己的單位
- 可移動自己的單位
- 查看地圖但無法編輯
- 使用 DP 計算器
- 為自己的單位添加/移除狀態效果

## 技術說明

- **前端**：原生 JavaScript、CSS3、HTML5
- **後端**：Firebase Realtime Database
- **字型**：Noto Sans TC、JetBrains Mono
- **即時同步**：Firebase 監聯器自動同步狀態
- **本地儲存**：地圖資料使用 localStorage 儲存

## 注意事項

1. **JS 載入順序很重要**，必須依照 `index.html` 中的順序載入
2. 需要網路連線才能使用多人功能
3. 狀態透過 Firebase 即時同步，本地 localStorage 作為備份
4. 地圖儲存功能使用瀏覽器 localStorage，最多可儲存 20 張地圖
5. 清除瀏覽器資料會刪除本地儲存的地圖

## 版本歷史

### v1.3.0
- 新增地圖儲存/載入功能
- 新增完整狀態效果系統（60+ 種狀態）
- 新增快捷鍵系統
- 新增 4 種地圖主題（共 12 種）
- 修復多處 BUG

### v1.2.0
- 新增大型單位支援（2x2、3x3）
- 改善地圖縮放與平移體驗
- 優化 Firebase 連線穩定性

### v1.1.0
- 新增 Firebase 即時同步
- 新增房間管理系統
- 新增玩家識別碼功能

### v1.0.0
- 初始版本
- 基本地圖編輯功能
- 單位管理與 HP 系統
- DP 計算器
