# Limbus Command

TRPG 戰術指揮系統，支援 Firebase 即時多人連線、地圖編輯、單位管理、狀態效果、DP 計算、音樂播放與歌詞同步。

## 功能總覽

### 多人連線系統
- **Firebase Realtime Database**：所有玩家即時同步遊戲狀態
- **房間系統**：ST 建立房間，玩家透過 4 位數房間碼加入
- **玩家識別碼**：4 位數識別碼，斷線後可恢復身份
- **自動重連**：頁面重新載入時自動恢復 Session（7 天內有效）
- **心跳機制**：每 45 秒發送心跳，維持連線活躍
- **在線狀態追蹤**：即時顯示玩家在線/離線狀態
- **房間管理**：ST 可查看、進入、刪除已建立的房間

### 地圖系統
- **可調整大小**：5×5 至 50×50 格子
- **12 種主題場景**：
  1. 一般訓練室 — 牆壁、掩體、險地
  2. 後巷深處 — 生鏽掩體、油污積水、路燈/霓虹、垃圾堆
  3. L 公司廢墟 — Cogito 洩漏、收容門、活性屍塊、抑制力場
  4. W 公司列車 — 空間裂隙、血肉座椅、頭等艙屏障、時間停滯
  5. K 公司工廠 — HP 安瓿、玻璃棧道、監控區域、消毒噴嘴
  6. U 公司甲板 — 濕滑甲板、巨浪拍打、魚叉發射器、共鳴音叉
  7. 冰雪城堡 — 萬年玄冰、巨大冰刺、凍結供品、深淵邊緣
  8. 血肉山丘 — 蠕動屍骸、獻祭之火、穿刺樁、金枝光輝
  9. 地獄雞廚房 — 特製辣醬灘、滾燙油鍋、全家桶堆、傳菜輸送帶
  10. 廢品蟹海灘 — 鬆軟沙地、蘇打水窪、銳利廢鐵堆、廢品壓縮機
  11. 20 區的奇蹟 — 積雪地面、煙囪煤灰雲、紅色禮物袋、綠色禮物袋
  12. 肉斬骨斷 — 劍道場中央、落花堆積處、鐵竹林、墨痕裂隙
- **地形效果**：每種地形都有獨特的戰鬥效果（增益、減益、危險區域等）
- **繪製工具**：ST 可繪製地形，支援拖曳連續繪製
- **自訂地形**：ST 可新增、編輯自訂地形（右鍵編輯現有地形）
- **混合調色盤**：支援跨主題混用不同地形
- **地圖儲存/載入**：
  - 最多儲存 20 張地圖至 localStorage
  - 可自訂地圖名稱
  - 支援 JSON 匯出/匯入
- **測距尺**：按住 Alt 鍵可拖曳測量格子距離，右鍵可新增折點

### 單位管理
- **單位類型**：敵人、玩家、BOSS
- **單位大小**：1×1（普通）、2×2（大型）、3×3（巨型）
- **HP 系統**：
  - 3 種傷害類型：B 傷（鈍擊）、L 傷（穿刺）、A 傷（惡化）
  - 傷害升級機制：滿格時 B → L → A
  - 治療優先順序：A > L > B
  - 支援 Shift + 按鈕開啟批量傷害/治療面板
  - 生命上限可動態調整
- **批量新增**：一次建立多個同類型單位
- **單位模板**：儲存並快速載入單位配置
- **頭像上傳**：可為單位上傳自訂頭像（自動裁切為正方形）
- **先攻管理**：設定先攻值並自動排序
- **戰鬥流程**：
  - ST 開始/結束戰鬥
  - 回合控制（上/下一回合）
  - 當前行動單位高亮顯示（地圖 Token + 單位卡片）
  - 旋轉符文指示器標記當前回合單位
- **部署系統**：選擇單位後點擊地圖格子部署，可收回至待命區
- **權限分配**：ST 可將單位操控權分配給特定玩家
- **BOSS 血條 HUD**：為 BOSS 單位啟用浮動血條，支援加權 HP 算法（B=1, L=2, A=3 分）

### 狀態效果系統
完整的狀態效果管理系統，基於無限恐怖規則：

- **60+ 種預設狀態效果**，分為 9 大類別：
  1. **戰鬥狀態** — 昏迷、定身、擊倒、纏鬥、脫離纏鬥等
  2. **增益效果** — 專注、鼓舞、庇護、幸運、狂暴等
  3. **減益效果** — 恐懼、易傷、目盲、耳聾、混亂等
  4. **元素效果** — 燃燒、冰凍、觸電、中毒、石化等
  5. **傷勢狀態** — 淺層傷口、深層傷口、出血、骨折、內傷等
  6. **心智狀態** — 驚慌、絕望、瘋狂、心靈創傷、意志動搖等
  7. **特殊狀態** — 隱形、飛行、潛行、變形、虛體化等
  8. **環境效果** — 黑暗、強光、濃霧、高溫、低溫等
  9. **其他效果** — 標記、追蹤、守護、挑釁、聚焦等
- **自訂狀態**：可新增自訂狀態並透過 Firebase 同步給所有人
- **狀態計數器**：支援層數/回合數追蹤
- **搜尋功能**：快速搜尋狀態名稱
- **最近使用**：快速存取最近添加的狀態
- **視覺化顯示**：狀態圖標顯示於單位卡片和地圖 Token 上

### DP 計算器
- **攻擊方設定**：
  - 攻擊 DP、附加成功、意志加值（+3）
  - 特殊標籤：破甲、高速、破魔（各自有對應數值輸入）
- **防禦方設定**：
  - 13 種防禦類型：
    - 物理類：盔甲、盾牌、天生
    - 敏捷類：基礎、閃避、格擋、盾擋
    - 超自然類：力場、偏斜、法甲
    - 其他類：掩蔽、洞察、其他
  - 受擊次數衰減計算
  - 防禦附加成功
- **BOSS 模式**：
  - 主線/支線等級設定
  - 複數行動懲罰計算
  - 先攻快慢判定（Boss 快 / 玩家快）
  - 即時結果預覽面板

### 音樂播放器
- **播放清單管理**：ST 可新增音樂名稱和 URL
- **播放控制**：播放/暫停、停止、靜音、音量調整
- **音量淡入/淡出**：平滑切換音樂
- **雲端 URL 支援**：Dropbox、Google Drive 等
- **即時同步**：ST 播放的音樂即時同步至所有玩家
- **localStorage 持久化**：播放清單自動儲存

### 歌詞工具
- **打字機效果**：逐字顯示歌詞，支援調整速度（每字毫秒數）
- **雙欄顯示**：歌詞可左右分欄顯示
- **行距控制**：可調整行與行之間的間隔
- **速度預設**：A/B 兩組速度預設，可快速切換
- **同步偏移**：微調歌詞與音樂的同步偏移量
- **手動錄製定點**：播放音樂時按空白鍵為每句歌詞標記時間點
- **從指定行重錄**：可從特定行數開始重新錄製，保留先前定點
- **AI 數據匯入**：支援 JSON 格式的時間軸匯入
- **歌詞清單**：儲存並管理多組歌詞

### 戰鬥儀表板（Combat HUD）
- **Google Sheets 整合**：從試算表匯入角色數據
- **資源顯示**：意志值、能量等
- **豁免與防禦**：快速查閱角色數值
- **攻擊預設**：常用攻擊模式快速選取
- **可拖曳介面**：浮動 HUD 可自由拖曳、收合
- **HUD 設定**：自訂 Google Sheets 連結等參數

### 快速操作球（QAB）
畫面右下角的浮動按鈕，提供快速存取：
- 音樂播放器
- 歌詞工具
- 快捷鍵說明
- 匯入角色數據
- 戰鬥儀表板
- HUD 設定

### 快捷鍵系統

按 `?` 鍵可查看完整快捷鍵說明：

| 按鍵 | 功能 |
|------|------|
| `1` / `2` / `3` | 切換頁面（地圖 / 單位 / 計算） |
| `Q` | 選取工具 |
| `W` | 清除地形工具 |
| `H` | 切換戰鬥儀表板 |
| `空白鍵` | 下一回合（僅 ST） |
| `Esc` | 取消選取 / 關閉視窗 |
| `Delete` | 刪除選取的單位 |
| `R` | 重置視角 |
| `方向鍵` | 移動選中的單位（已部署）或平移視角 |
| `+` / `-` | 放大 / 縮小視角 |
| `Tab` | 切換側邊欄 |
| `Alt + 拖曳` | 測距尺（右鍵新增折點） |
| `?` | 顯示快捷鍵說明 |

### 地圖操控
- **滑鼠拖曳**：平移地圖視角
- **滾輪縮放**：0.5× ~ 3.0× 縮放範圍
- **觸控支援**：支援手機觸控平移與捏合縮放
- **鍵盤控制**：方向鍵移動選中單位或視角
- **視角重置**：`R` 鍵或工具列按鈕一鍵歸位

### 響應式設計
- **電腦版**：側邊欄預設顯示，可收合
- **手機版**：側邊欄預設隱藏，點擊按鈕展開；觸控手勢優化
- **自適應佈局**：各元件自動調整大小
- **戰鬥模式**：戰鬥中隱藏導覽列，透過暫開按鈕查看

## 專案結構

```
Limbus-trpg-Map-Calculator/
├── index.html                          # 主要 HTML 檔案（入口點）
│
├── styles/                             # 樣式檔案
│   ├── main.css                        # 主要樣式（版面、CSS 變數、RWD）
│   ├── components.css                  # 元件樣式（Token、單位卡片、Modal、狀態標籤）
│   ├── calculator.css                  # 計算器專用樣式
│   └── combat-hud.css                  # 戰鬥儀表板樣式
│
├── src/
│   ├── config/                         # 配置層
│   │   ├── config.js                   # 遊戲常數（地圖預設、防禦類型、連線配置）
│   │   ├── status-config.js            # 狀態效果資料庫（60+ 種狀態定義）
│   │   └── firebase-config.js          # Firebase 初始化配置
│   │
│   ├── core/                           # 核心邏輯層
│   │   ├── state.js                    # 全域狀態管理（遊戲狀態、UI 狀態、相機狀態）
│   │   ├── calculator.js               # DP 計算引擎與 BOSS 模式
│   │   ├── map-manager.js              # 地圖儲存/載入/匯出管理
│   │   └── status-manager.js           # 狀態效果管理器（Modal、搜尋、新增/刪除）
│   │
│   ├── data/                           # 資料存取層
│   │   ├── storage.js                  # localStorage 持久化（房間、用戶、單位模板）
│   │   └── firebase-connection.js      # Firebase 即時同步（房間管理、監聽器、心跳）
│   │
│   ├── ui/                             # 使用者介面層
│   │   ├── main.js                     # 應用程式進入點與初始化
│   │   ├── map.js                      # 地圖渲染、地形繪製、Token 互動、測距尺
│   │   ├── units.js                    # 單位列表渲染、HP 修改、回合控制、頭像上傳
│   │   ├── modals.js                   # Modal 彈窗管理（新增單位、HP 面板、分配權限等）
│   │   ├── camera.js                   # 相機控制（平移、縮放、觸控捏合）
│   │   ├── hotkeys.js                  # 鍵盤快捷鍵系統
│   │   ├── combat-hud.js              # 戰鬥儀表板（Google Sheets 整合）
│   │   └── lyrics.js                   # 歌詞顯示系統（打字機效果、錄製、同步）
│   │
│   └── utils/                          # 工具函數層
│       ├── utils.js                    # HTML 轉義、Toast 通知、剪貼簿、ID 生成
│       └── audio.js                    # 音樂播放器（播放清單、淡入淡出、音量控制）
│
└── assets/
    ├── images/
    │   └── boss_frame.png              # BOSS 單位框架圖片
    └── audio/                          # 內建背景音樂
```

### 架構說明

專案採用分層架構，各層職責明確：

```
HTML / DOM / 使用者事件
        │
   UI 層 (ui/)          ← DOM 操作、事件綁定、渲染
        │
   ┌────┴────┐
Data 層    Utils 層      ← Firebase 同步、localStorage、工具函數
(data/)    (utils/)
   └────┬────┘
        │
   Core 層 (core/)       ← 業務邏輯、狀態管理、計算
        │
   Config 層 (config/)   ← 常數、預設值、配置
```

**JS 載入順序**（定義在 `index.html`，順序重要）：
1. Config 層 → 2. Core 層 → 3. Utils 層 → 4. Data 層 → 5. UI 層

## 使用方式

### 本地開發

使用任意本地伺服器開啟：

```bash
# Python
python -m http.server 8080

# Node.js
npx serve .
```

> 也可直接用瀏覽器開啟 `index.html`，但多人連線功能需要 Firebase 配置。

### Firebase 配置

1. 前往 [Firebase Console](https://console.firebase.google.com/) 建立專案
2. 啟用 Realtime Database
3. 將你的 Firebase 配置填入 `src/config/firebase-config.js`
4. 設定資料庫規則允許讀寫（注意：僅適合信任的遊戲群組）

### 部署到 GitHub Pages

1. 將所有檔案推送到 GitHub 倉庫
2. 進入 Settings → Pages
3. 選擇分支（通常是 `main`）並儲存
4. 等待部署完成

## 角色說明

### ST（Story Teller）— 遊戲主持人
- 建立房間並分享房間碼
- 完整的地圖編輯權限（繪製地形、切換主題、調整大小）
- 控制戰鬥流程（開始/結束、回合切換、先攻排序）
- 可操作所有單位（移動、修改 HP、分配權限）
- 儲存/載入地圖、管理單位模板
- 管理音樂播放與歌詞同步
- 查看所有地形效果

### 玩家
- 透過房間碼加入遊戲
- 新增並操作自己的單位
- 移動自己的單位、管理狀態效果
- 查看地圖（無法編輯）
- 使用 DP 計算器
- 即時接收所有同步更新

## 技術說明

- **前端**：原生 JavaScript (ES6+)、CSS3、HTML5（無框架依賴）
- **後端**：Firebase Realtime Database
- **字型**：Noto Sans TC、JetBrains Mono
- **即時同步**：Firebase 監聽器（`on('value')`）自動推送更新
- **本地儲存**：地圖儲存、播放清單、歌詞、HUD 設定使用 localStorage
- **渲染最佳化**：DocumentFragment 批次 DOM 更新、繪製節流（500ms）

## 注意事項

1. JS 載入順序嚴格依賴 `index.html` 中的 `<script>` 標籤順序
2. 需要網路連線才能使用多人功能（Firebase）
3. 地圖儲存使用瀏覽器 localStorage，最多 20 張；清除瀏覽器資料會遺失
4. Firebase 安全規則採信任模式，適合私人遊戲群組，不適合公開部署
5. Session 自動保存 7 天，手動登出後下次需重新連線
