<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Limbus Command</title>

    <!-- Firebase SDK (使用 Compat 版本以支援舊版語法) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <!-- CSS 檔案 - 同一層級 -->
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="calculator.css">
</head>
<body>
<input type="file" id="file-upload" accept="image/*" style="display:none;">
<div class="toast" id="toast"></div>

<!-- Login Layer -->
<div id="login-layer">
    <div class="login-box" id="login-main">
        <div class="login-title">LIMBUS</div>
        <div style="color:var(--text-dim);margin-bottom:20px;">戰術指揮系統</div>
        <input type="text" id="input-name" placeholder="輸入代號" style="width:100%;text-align:center;margin-bottom:10px;">
        <button class="login-btn btn-host" onclick="showSTStep()">我是 ST（建房）</button>
        <button class="login-btn btn-join" onclick="showJoinStep()">我是玩家（加入）</button>
    </div>
    <div class="login-box hidden" id="login-st">
        <div class="login-title">建立房間</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">如有舊識別碼可輸入以恢復身份</div>
        <input type="text" id="input-st-code" placeholder="4 位數識別碼（選填）" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-host" onclick="initSystem('st')">建立房間</button>
        <button class="login-btn" style="background:var(--accent-blue);" onclick="showRoomManager()">📋 房間管理</button>
        <button class="login-btn btn-back" onclick="showMainStep()">返回</button>
    </div>
    <div class="login-box hidden" id="login-join">
        <div class="login-title">加入房間</div>
        <input type="text" id="input-host-id" placeholder="貼上 ST 的房間 ID" style="width:100%;text-align:center;margin-bottom:10px;">
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">如有舊識別碼可輸入以恢復身份</div>
        <input type="text" id="input-player-code" placeholder="4 位數識別碼（選填）" maxlength="4" style="width:100%;text-align:center;margin-bottom:10px;font-family:'JetBrains Mono',monospace;letter-spacing:4px;">
        <button class="login-btn btn-join" onclick="initSystem('player')">連線</button>
        <button class="login-btn btn-back" onclick="showMainStep()">返回</button>
    </div>
    <div class="login-box hidden" id="login-loading">
        <div style="color:var(--accent-green);margin-bottom:10px;">連線中...</div>
        <div id="loading-status" style="font-size:0.8rem;color:var(--text-dim);"></div>
    </div>
    <div class="login-box hidden" id="login-room-manager" style="max-width:600px;max-height:80vh;overflow-y:auto;">
        <div class="login-title">房間管理</div>
        <div id="room-list-container" style="margin:15px 0;"></div>
        <button class="login-btn btn-back" onclick="showSTStep()">返回</button>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="map" onclick="switchPage('map')">🗺️ 地圖</button>
        <button class="nav-tab" data-page="units" onclick="switchPage('units')">⚔️ 單位</button>
        <button class="nav-tab" data-page="calc" onclick="switchPage('calc')">🎲 計算</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
        <div class="conn-status" id="conn-status" title="連線狀態">
            <div class="conn-dot connecting" id="conn-dot"></div>
            <span id="conn-text">連線中</span>
        </div>
        <span class="player-code" id="my-code" onclick="copyMyCode()" title="點擊複製識別碼" style="font-size:0.9rem;padding:4px 8px;display:none;">----</span>
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">📋</button>
        <span class="id-badge" id="my-id" onclick="copyId()" title="點擊複製ID">---</span>
    </div>
</nav>

<!-- Main Content -->
<div class="main-wrapper">
    <!-- Map Page -->
    <div id="page-map" class="page active">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span style="font-weight:bold;color:var(--accent-yellow);">戰鬥序列</span>
                <button style="background:none;color:var(--text-dim);font-size:1.2rem;" onclick="toggleSidebar()">×</button>
            </div>
            <div class="sidebar-content">
                <div id="tile-info-panel">
                    <div style="color:var(--accent-yellow);font-weight:bold;margin-bottom:4px;">地形效果</div>
                    <div id="tile-effect-desc"></div>
                </div>
                <div id="sidebar-units"></div>
            </div>
        </aside>
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;">
            <div class="map-toolbar">
                <div class="map-tools-scroll" id="dynamic-tools">
                    <button class="tool-btn active" data-tool="cursor" onclick="setTool('cursor')">👆</button>
                    <button class="tool-btn" data-tool="floor" onclick="setTool('floor')">🧹</button>
                </div>
                <div class="tool-separator"></div>
                <button class="tool-btn" onclick="resetCamera()" title="視角歸位">🎯</button>
                <button class="tool-btn" onclick="clearSelection()" title="取消選取">✕</button>
                
                <div class="map-controls-right" id="st-map-controls">
                    <button class="map-manager-btn" onclick="openMapManagerModal()" title="儲存/載入地圖">📂 地圖</button>
                    <select id="map-theme-select" class="map-select" onchange="changeMapTheme(this.value)">
                        <option value="0">一般訓練室</option>
                        <option value="1">後巷深處</option>
                        <option value="2">L 公司廢墟</option>
                        <option value="3">W 公司列車</option>
                        <option value="4">K 公司工廠</option>
                        <option value="5">U 公司甲板</option>
                        <option value="6">冰雪城堡</option>
                        <option value="7">血肉山丘</option>
                        <option value="8">地獄雞廚房</option>
                        <option value="9">廢品蟹海灘</option>
                        <option value="10">20區的奇蹟</option>
                        <option value="11">肉斬骨斷</option>
                    </select>
                    <input type="number" id="map-w" class="size-input" value="15" min="5" max="50">
                    <span style="font-size:0.8rem;color:#555;">x</span>
                    <input type="number" id="map-h" class="size-input" value="15" min="5" max="50">
                    <button class="apply-btn" onclick="resizeMap()">套用</button>
                </div>
            </div>
            <div class="map-viewport" id="map-viewport">
                <div class="map-container" id="map-container">
                    <div id="battle-map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Units Page -->
    <div id="page-units" class="page">
        <div class="units-toolbar" id="units-toolbar">
            <button class="units-btn primary" onclick="nextTurn()">▶ 下一回合</button>
            <button class="units-btn" onclick="openAddUnitModal()">+ 新增</button>
            <button class="units-btn" onclick="openBatchModal()">📋 批量</button>
            <button class="units-btn" onclick="sortByInit()">⏱ 排序</button>
        </div>
        <div class="units-list" id="units-list"></div>
    </div>

    <!-- Calculator Page -->
    <div id="page-calc" class="page">
        <div class="calc-container">
            <!-- Boss Mode Section -->
            <div class="calc-section">
                <label class="boss-toggle">
                    <input type="checkbox" id="boss-mode" onchange="toggleBossMode()">
                    <div>
                        <div style="font-weight:bold;color:var(--accent-purple);">🔮 特殊 BOSS 模式</div>
                        <div style="font-size:0.75rem;color:var(--text-dim);">啟用房規計算：複數行動、先攻加成</div>
                    </div>
                </label>
                <div class="boss-options" id="boss-options">
                    <div class="calc-grid">
                        <div class="calc-field">
                            <span class="calc-label">主線/支線等級</span>
                            <input type="number" id="boss-tier" value="1" min="1" max="10" onchange="updateBossSummary()">
                        </div>
                        <div class="calc-field">
                            <span class="calc-label">本回合狀況</span>
                            <select id="boss-engage" onchange="updateBossSummary()">
                                <option value="yes">有對抗行動</option>
                                <option value="no">完全未對抗 (我方DP+)</option>
                            </select>
                        </div>
                    </div>
                    <div id="boss-actions-list" style="margin-top:10px;"></div>
                    <button class="boss-add-action" onclick="addBossAction()">+ 新增對抗行動</button>
                    <div class="boss-summary">
                        <div style="font-weight:bold;color:var(--accent-purple);margin-bottom:6px;">📊 結果預覽</div>
                        <div id="boss-summary-content" style="display:flex;flex-direction:column;gap:4px;"></div>
                    </div>
                </div>
            </div>

            <!-- Attacker Section -->
            <div class="calc-section">
                <div class="calc-section-title atk">🗡️ 攻擊方 (我方)</div>
                <div class="atk-tags">
                    <span class="atk-tag" data-type="pen" onclick="toggleAtkTag('pen')">破甲</span>
                    <span class="atk-tag" data-type="speed" onclick="toggleAtkTag('speed')">高速</span>
                    <span class="atk-tag" data-type="magic" onclick="toggleAtkTag('magic')">破魔</span>
                </div>
                <div class="calc-grid">
                    <div class="calc-field">
                        <span class="calc-label">攻擊 DP</span>
                        <input type="number" id="c-atk" value="10" min="0">
                    </div>
                    <div class="calc-field">
                        <span class="calc-label">攻擊附加成功</span>
                        <input type="number" id="c-atk-auto" value="0" min="0">
                    </div>
                    <div class="calc-field">
                        <span class="calc-label">意志加值</span>
                        <select id="c-will">
                            <option value="0">不使用</option>
                            <option value="3">+3 (完美)</option>
                        </select>
                    </div>
                </div>
                <div class="def-input-row" id="row-pen">
                    <span>破甲值</span>
                    <input type="number" id="c-pen" value="0">
                </div>
                <div class="def-input-row" id="row-speed">
                    <span>高速值</span>
                    <input type="number" id="c-speed" value="0">
                </div>
                <div class="def-input-row" id="row-magic">
                    <span>破魔值</span>
                    <input type="number" id="c-magic" value="0">
                </div>
            </div>

            <!-- Defender Section -->
            <div class="calc-section">
                <div class="calc-section-title def">🛡️ 防禦方 (敵方)</div>
                <div class="def-tags" id="def-tags"></div>
                <div class="def-inputs" id="def-inputs"></div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">
                    <div class="calc-grid">
                        <div class="calc-field">
                            <span class="calc-label">本回合已受擊次數</span>
                            <input type="number" id="c-hits" value="0" min="0">
                        </div>
                        <div class="calc-field">
                            <span class="calc-label" style="color:var(--accent-orange)">防禦附加成功</span>
                            <input type="number" id="c-def-auto" value="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="calc-buttons">
                <button class="calc-btn calc-btn-reset" onclick="resetCalc()">🔄 重置</button>
                <button class="calc-btn calc-btn-calc" onclick="calculateDP()">⚡ 計算 (僅一般)</button>
            </div>
            <div style="text-align:center;padding:15px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);">
                <div id="result-main" style="font-size:2rem;font-weight:bold;color:var(--accent-green);">---</div>
                <div id="result-detail" style="font-size:0.8rem;color:var(--text-dim);margin-top:5px;">
                    一般計算結果顯示於此<br>(BOSS模式請看上方預覽面板)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modals-container"></div>

<!-- 快捷鍵提示按鈕 -->
<button class="hotkey-help-btn" onclick="toggleHotkeyHelp()" title="快捷鍵說明">&#9000;</button>

<!-- 快捷鍵說明面板 -->
<div class="hotkey-help-panel hidden" id="hotkey-help">
    <!-- 內容由 JS 動態生成 -->
</div>

<!-- JS 檔案 - 同一層級，順序很重要！ -->
<script src="config.js"></script>

<!-- 狀態效果系統 - 需在 units.js 之前載入 -->
<script src="status-config.js"></script>
<script src="status-manager.js"></script>

<!-- Firebase 配置 - 必須在其他模組之前載入 -->
<script src="firebase-config.js"></script>

<script src="state.js"></script>
<script src="utils.js"></script>
<script src="storage.js"></script>

<!-- Firebase 連線模組 - 替代原本的 P2P 連線 -->
<script src="firebase-connection.js"></script>

<script src="camera.js"></script>
<script src="map.js"></script>
<script src="map-manager.js"></script>
<script src="units.js"></script>
<script src="calculator.js"></script>
<script src="hotkeys.js"></script>
<script src="modals.js"></script>
<script src="main.js"></script>
</body>
</html>
